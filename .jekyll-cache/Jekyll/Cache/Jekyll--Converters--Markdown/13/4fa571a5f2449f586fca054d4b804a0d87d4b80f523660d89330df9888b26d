I"ßz<p>ì‚¬ì „ì—ì„œ context(ì»¨í…ìŠ¤íŠ¸)ë¥¼ ì°¾ì•„ë³´ë©´ ì–´ë–¤ ì‚¬ê±´ì´ ë°œìƒí–ˆì„ ë•Œì˜ ì£¼ë³€ ìƒí™© ì •ë„ë¡œ ì„¤ëª…í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì»´í“¨í„° ì†Œí”„íŠ¸ì›¨ì–´ì—ì„œë„ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­, ë¡œê·¸ ì»¨í…ìŠ¤íŠ¸, ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ ë“± ì»¨í…ìŠ¤íŠ¸ë¼ëŠ” ë‹¨ì–´ë¥¼ ë§ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<p>ë¼ë¼ë²¨ì€ IoCë¥¼ ìœ„í•œ Service Container<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>ê°€ ìˆìœ¼ë©°, ì—¬ê¸°ì— ì–´ë–¤ ë°ì´í„° íƒ€ì…ì´ë“  ë°”ì¸ë”©í•  ìˆ˜ ìˆê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì¤‘ì— ì•„ë˜ì²˜ëŸ¼ êº¼ë‚´ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$container</span> <span class="o">=</span> <span class="nx">app</span><span class="p">();</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="s1">'bar'</span><span class="p">;</span>
<span class="p">});</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">);</span> <span class="c1">// 'bar'</span>
</code></pre></div></div>

<p>ê·¸ëŸ°ë°, ì•„ë˜ì™€ ê°™ì€ ë¬¸ì œê°€ ìˆì£ <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup>. ì‘ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ì´ë ‡ê²Œ ì“´ë‹¤ê³  ì „í˜€ ë¬¸ì œì—†ì§€ë§Œ, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì»¤ì§€ë©´ ê²°êµ­ ê°œë°œìì—ê²Œ í° ë¶€ë‹´ìœ¼ë¡œ ë‹¤ê°€ì˜µë‹ˆë‹¤.</p>

<p><a href="/images/2018-07-09-img-01.png"><img src="/images/2018-07-09-img-01.png" alt="Strong Dependency" /></a></p>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¼ë¼ë²¨ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì˜ ì£¼ë³€ ìƒí™©ì„ ë‹´ì•„ ë†“ê³  í•„ìš”í•  ë•Œ êº¼ë‚´ ì“°ê¸° ìœ„í•œ ë°ì´í„° ì»¨í…Œì´ë„ˆë¥¼ êµ¬í˜„í–ˆë˜ ì°ì„ í’€ì–´ë³´ë ¤í•©ë‹ˆë‹¤. <code class="highlighter-rouge">ApplicationContext</code>ë¼ ì´ë¦„ ì§€ì—ˆê³  Java ì–¸ì–´ì˜ <code class="highlighter-rouge">ThreadLocal</code><sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>ê³¼ ë¹„ìŠ·í•œ ì—­í• ì„ í•œë‹¤ê³  ë³´ë©´ ë©ë‹ˆë‹¤. ì£¼ë¡œ ì•„ë˜ì™€ ê°™ì€ ìƒí™©ì— ìœ ìš©í•˜ê²Œ ì‚¬ìš©ë˜ê¸°ë¥¼ ë°”ë¼ë©° ë§Œë“¤ì—ˆì–´ìš”.</p>

<ul>
  <li>í”„ë ˆì„ì›Œí¬ ì˜ì—­(=main)ì˜ ë°ì´í„°ë¥¼ ì½”ì–´ ì˜ì—­(=app)ìœ¼ë¡œ ì „ë‹¬í•  ë•Œ</li>
  <li>ë¡œê¹… ë° ê°ì‚¬</li>
  <li>í”„ë¡œì„¸ìŠ¤ê°„ ì»¨í…ìŠ¤íŠ¸ ë¦´ë ˆì´ ë“±ë“± (e.g. Api -&gt; Queue, App -&gt; External, â€¦)</li>
</ul>

<!--more-->
<div class="spacer">â€¢ â€¢ â€¢</div>

<h2 id="1-ê¸°ëŠ¥-ìš”êµ¬-ì‚¬í•­">1. ê¸°ëŠ¥ ìš”êµ¬ ì‚¬í•­</h2>

<ul>
  <li>ì»¨í…ìŠ¤íŠ¸ë¥¼ ì†Œë¹„í•˜ëŠ” ì½”ì–´ ì½”ë“œê°€ í”„ë ˆì„ì›Œí¬ì—ì„œ ìƒì„±í•œ <code class="highlighter-rouge">Container</code>, <code class="highlighter-rouge">Application</code>ì— ì˜ì¡´í•˜ì§€ ì•Šë„ë¡ í•œë‹¤</li>
  <li>ì¶”ê°€ì ì¸ ì˜ì¡´ì„±ì´ ì—†ëŠ” í´ë¦°í•œ ë°ì´í„° ì»¨í…Œì´ë„ˆ</li>
  <li>í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë‹¤ìŒ í”„ë¡œì„¸ìŠ¤ì— ì „ë‹¬í•  ìˆ˜ ìˆê³ , ì§ì „ ì»¨í…ìŠ¤íŠ¸ë¥¼ í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ì— ì—°ê²°í•  ìˆ˜ ìˆë‹¤</li>
  <li>íŠ¸ëœì­ì…˜ ì •ë³´ë¥¼ ë‹´ê³  ìˆë‹¤</li>
  <li>ì‚¬ìš©ì ì •ë³´ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤</li>
</ul>

<h2 id="2-ì„¤ê³„">2. ì„¤ê³„</h2>

<p><a href="/images/2018-07-09-img-02.png"><img src="/images/2018-07-09-img-02.png" alt="ApplicationContext Design" /></a></p>

<h2 id="3-êµ¬í˜„">3. êµ¬í˜„</h2>

<p>ì½”ë“œì— ì£¼ì„ì„ ë‹¬ì•˜ìœ¼ë¯€ë¡œ ì¶”ê°€ì ì¸ ì„¤ëª…ì€ ìƒëµí•©ë‹ˆë‹¤.</p>

<h3 id="31-applicationcontextserviceprovider">3.1. <code class="highlighter-rouge">ApplicationContextServiceProvider</code></h3>

<p>ë¼ë¼ë²¨ì´ ë¶€íŒ…í•  ë•Œ, <code class="highlighter-rouge">ApplicationContext</code> ê°ì²´ë¥¼ ë§Œë“¤ê³  <code class="highlighter-rouge">ServiceContainer</code>ì— ë“±ë¡í•´ ë‘ëŠ” ì¼ì„ í•©ë‹ˆë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// https://github.com/appkr/db-lock-poc/blob/master/app/Providers/ApplicationContextServiceProvider.php</span>

<span class="kn">namespace</span> <span class="nn">App\Providers</span><span class="p">;</span>

<span class="nx">use</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="kd">class</span> <span class="nc">ApplicationContextServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">singleton</span><span class="p">(</span><span class="nx">ApplicationContext</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Application</span> <span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$runningInConsole</span> <span class="o">=</span> <span class="nb">php_sapi_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'cli'</span><span class="p">;</span>
            <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">ConfigRepository</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nx">ApplicationContext</span><span class="p">([</span>
                <span class="s1">'runningInConsole'</span> <span class="o">=&gt;</span> <span class="nv">$runningInConsole</span><span class="p">,</span>
                <span class="s1">'appEnv'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'app.env'</span><span class="p">,</span> <span class="s1">'UNKNOWN'</span><span class="p">),</span>
                <span class="s1">'appVersion'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'app.version'</span><span class="p">,</span> <span class="s1">'UNKNOWN'</span><span class="p">),</span>
                <span class="s1">'transactionId'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTransactionId</span><span class="p">(),</span>
                <span class="s1">'traceNumber'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTraceNumber</span><span class="p">(),</span>
                <span class="s1">'user'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getUser</span><span class="p">(),</span>
                <span class="s1">'clientIp'</span> <span class="o">=&gt;</span> <span class="nv">$runningInConsole</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getClientIp</span><span class="p">()</span>
            <span class="p">]);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">getTransactionId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="cd">/** @var Request $request */</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">Request</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">hasHeader</span><span class="p">(</span><span class="nx">XHttpHeader</span><span class="o">::</span><span class="na">REQUEST_ID</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// í´ë¼ì´ì–¸íŠ¸ê°€ ì œì¶œí•œ X-Vendor-Request-Idê°€ í•­ìƒ ìµœìš°ì„  ì‚¬ìš©ë©ë‹ˆë‹¤.</span>
            <span class="k">return</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">header</span><span class="p">(</span><span class="nx">XHttpHeader</span><span class="o">::</span><span class="na">REQUEST_ID</span><span class="p">)));</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">hasHeader</span><span class="p">(</span><span class="nx">XHttpHeader</span><span class="o">::</span><span class="na">UNIQUE_ID</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// ì›¹ ì„œë²„ê°€ ë¶€ì—¬í•œ ì‹ë³„ìê°€ ê·¸ ë‹¤ìŒìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</span>
            <span class="k">return</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">header</span><span class="p">(</span><span class="nx">XHttpHeader</span><span class="o">::</span><span class="na">UNIQUE_ID</span><span class="p">)));</span>
        <span class="p">}</span>
        <span class="c1">// ë‘˜ ì¤‘ ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©°, ë¼ë¼ë²¨ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°œê¸‰í•œ UUIDë¡œ í´ë°±í•©ë‹ˆë‹¤.</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="nx">Uuid</span><span class="o">::</span><span class="na">uuid4</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">getTraceNumber</span><span class="p">()</span>
    <span class="p">{</span>
    	<span class="c1">// ë¡œê·¸ë¥¼ ì“¸ ë•Œë§ˆë‹¤ íŠ¸ë ˆì´ìŠ¤ ë„˜ë²„ë¥¼ 1ì”© ì¦ê°€ì‹œì¼œ, ë¡œê·¸ë¥¼ ìˆœì„œëŒ€ë¡œ ë³´ê¸° ìœ„í•¨í™ë‹ˆë‹¤.</span>
    	<span class="c1">// ì»¨í…ìŠ¤íŠ¸ë¥¼ ì „ë‹¬í•  ë•Œë„ í˜„ì¬ì˜ ì»¨í…ìŠ¤íŠ¸ ê°ì²´ ë˜ëŠ” API ìš”ì²­ í—¤ë”ì— ë‹¬ì•„ë³´ë‚´ì„œ ìˆœì„œë¥¼ ìœ ì§€í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">Request</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">hasHeader</span><span class="p">(</span><span class="nx">XHttpHeader</span><span class="o">::</span><span class="na">TRACE_NUMBER</span><span class="p">)</span>
            <span class="o">?</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">header</span><span class="p">(</span><span class="nx">XHttpHeader</span><span class="o">::</span><span class="na">TRACE_NUMBER</span><span class="p">)))</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">getUser</span><span class="p">(</span><span class="nv">$guardName</span> <span class="o">=</span> <span class="s1">'api'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">php_sapi_name</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'cli'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">User</span><span class="o">::</span><span class="na">createDefaultUser</span><span class="p">([</span>
                <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'CLI'</span><span class="p">,</span>
                <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'cli@example.com'</span><span class="p">,</span>
            <span class="p">]);</span>
        <span class="p">}</span>

        <span class="cd">/** @var Factory $authFactory */</span>
        <span class="nv">$authFactory</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">Factory</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$guard</span> <span class="o">=</span> <span class="nv">$authFactory</span><span class="o">-&gt;</span><span class="na">guard</span><span class="p">(</span><span class="nv">$guardName</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$guard</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span> <span class="o">?:</span> <span class="nx">User</span><span class="o">::</span><span class="na">createDefaultUser</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">getClientIp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="cd">/** @var Request $request */</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">Request</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getClientIp</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="32-applicationcontext">3.2. <code class="highlighter-rouge">ApplicationContext</code></h3>

<p>ë¡œì§ ì—†ì´ Getterì™€ Setterë§Œ ìˆëŠ” DTO(Data Transfer Object), Boundary ê°ì²´ì…ë‹ˆë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// https://github.com/appkr/db-lock-poc/blob/master/app/ApplicationContext.php</span>

<span class="kn">namespace</span> <span class="nn">App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Myshop\Domain\Model\User</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ApplicationContext</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$dataContainer</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span> <span class="o">=</span> <span class="p">[])</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dataContainer</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isRunningInConsole</span><span class="p">()</span><span class="o">:</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'runningInConsole'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAppEnv</span><span class="p">()</span><span class="o">:</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'appEnv'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAppVersion</span><span class="p">()</span><span class="o">:</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'appVersion'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTransactionId</span><span class="p">()</span><span class="o">:</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'transactionId'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTransactionId</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$newTransactionId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'transactionId'</span><span class="p">,</span> <span class="nv">$newTransactionId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTraceNumber</span><span class="p">()</span><span class="o">:</span> <span class="kt">int</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'traceNumber'</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTraceNumber</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$newTraceNumber</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'traceNumber'</span><span class="p">,</span> <span class="nv">$newTraceNumber</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">increaseTraceNumber</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'traceNumber'</span><span class="p">,</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'traceNumber'</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">succeedPreviousContext</span><span class="p">(</span><span class="nx">ApplicationContext</span> <span class="nv">$previousContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$previousContext</span> <span class="o">===</span> <span class="nv">$this</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'transactionId'</span><span class="p">,</span> <span class="nv">$previousContext</span><span class="o">-&gt;</span><span class="na">getTransactionId</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'traceNumber'</span><span class="p">,</span> <span class="nv">$previousContext</span><span class="o">-&gt;</span><span class="na">getTraceNumber</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="nv">$previousContext</span><span class="o">-&gt;</span><span class="na">getUser</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUser</span><span class="p">()</span><span class="o">:</span> <span class="nx">User</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'user'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUser</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getClientIp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'clientIp'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Helpers</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">all</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">keys</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">values</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$default</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dataContainer</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dataContainer</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$default</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">set</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dataContainer</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">has</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="33-clientcontextpolicy-a-domain-class-example">3.3. <code class="highlighter-rouge">ClientContextPolicy</code>: A Domain Class Example</h3>

<p>ëŸ°íƒ€ì„ì— <code class="highlighter-rouge">ServiceContainer</code>ì— ë“±ë¡í–ˆë˜ <code class="highlighter-rouge">ApplicationContext</code>ë¥¼ ì£¼ì…ë°›ì•„ ì‚¬ìš©ìì˜ IPë¥¼ ì²´í¬í•˜ëŠ” ì¼ì„ í•˜ëŠ” ì˜ˆì œ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” í”„ë ˆì„ì›Œí¬ ì˜ì—­ì¸ <code class="highlighter-rouge">App</code> ì•„ë˜ì— ìˆì§€ë§Œ, â€œí—ˆìš©í•œ IPë¡œ ì ‘ì†í–ˆì„ ë•Œë§Œ ì„œë¹„ìŠ¤ ì‚¬ìš©ì„ í—ˆìš©í•œë‹¤â€ë¼ëŠ” ë„ë©”ì¸ ì •ì±…ì„ êµ¬í˜„í•˜ê³  ìˆìœ¼ë¯€ë¡œ, ë„ë©”ì¸ í´ë˜ìŠ¤ë¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// https://github.com/appkr/db-lock-poc/blob/master/app/Policies/ClientContextPolicy.php</span>

<span class="kn">namespace</span> <span class="nn">App\Policies</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">App\ApplicationContext</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">App\Http\Exception\NotAllowedIpException</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Myshop\Domain\Model\User</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Symfony\Component\HttpFoundation\IpUtils</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ClientContextPolicy</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$appContext</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">ApplicationContext</span> <span class="nv">$appContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">appContext</span> <span class="o">=</span> <span class="nv">$appContext</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">check</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">appContext</span><span class="o">-&gt;</span><span class="na">getUser</span><span class="p">();</span>
        <span class="nv">$clientIp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">appContext</span><span class="o">-&gt;</span><span class="na">getClientIp</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">checkUserIp</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$clientIp</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">checkUserIp</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$clientIp</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$allowedIps</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">allowed_ips</span> <span class="o">?:</span> <span class="p">[</span><span class="s1">'*'</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="s1">'*'</span><span class="p">,</span> <span class="nv">$allowedIps</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$accessAllowed</span> <span class="o">=</span> <span class="nx">IpUtils</span><span class="o">::</span><span class="na">checkIp</span><span class="p">(</span><span class="nv">$clientIp</span><span class="p">,</span> <span class="nv">$allowedIps</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$accessAllowed</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">NotAllowedIpException</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ê¹ƒí—ˆë¸Œ ì˜ˆì œ ì½”ë“œì—ì„œëŠ” Sentry, Logging, Exception Handling ë“±ì— <code class="highlighter-rouge">ApplicationContext</code>ë¥¼ ì ìš©í•˜ëŠ” ë¶€ë¶„ë„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤. ì „ì²´ ì½”ë“œëŠ” <a href="https://github.com/appkr/db-lock-poc/pull/23/files">https://github.com/appkr/db-lock-poc/pull/23/files</a> ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://laravel.com/docs/5.6/container">ServiceContainer ê³µì‹ ë¬¸ì„œ</a>, <a href="https://gist.github.com/davejamesmiller/bd857d9b0ac895df7604dd2e63b23afe">ê³µì‹ë³´ë‹¤ ë” ë‚˜ì€ ë¬¸ì„œ</a>Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="/learn-n-think/clean-architecture-and-dependency/#2-%ED%81%B4%EB%A6%B0-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98">í´ë¦° ì•„í‚¤í…ì²˜</a>ì— ëŒ€í•œ í¬ìŠ¤íŠ¸ë¥¼ ì½ì–´ë³´ì„¸ìš”.Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="//javacan.tistory.com/entry/ThreadLocalUsage"><code class="highlighter-rouge">ThreadLocal</code>ì— ê´€í•œ ìµœë²”ê· ë‹˜ì˜ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸</a>Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
:ET