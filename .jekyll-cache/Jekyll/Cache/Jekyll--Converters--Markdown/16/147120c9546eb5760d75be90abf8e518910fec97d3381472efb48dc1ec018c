I"çc<p>ìµœê·¼ì— íšŒì‚¬ ì¼ë¡œ ê²€ìƒ‰ ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí–ˆë‹¤. ê²€ìƒ‰ ì—”ì§„ìœ¼ë¡œëŠ” Elastic Searchë¥¼ ì‚¬ìš©í–ˆê³ , ë§¤ì¼ ìµœí•œì‹œ(off-peak time)ì— í•œ ë²ˆì”© ìš´ì˜ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê²€ìƒ‰, í•„í„°ë§, ì •ë ¬, Aggregation ë“±ì— í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ê³¨ë¼ ì¸ë±ì‹±í•˜ë„ë¡ ì„¤ê³„í–ˆë‹¤. ê·¸ë¦¬ê³ , ì¬ê³  ìˆ˜ëŸ‰ê³¼ ê°™ì´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œ ê°’ ë“¤ì€ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì—ì„œ SNS ë©”ì‹œì§€ ë˜ëŠ” ë©”ì‹œì§€ íë¥¼ ì´ìš©í•´ì„œ ì „ë‹¬í•˜ê³ , ì „ë‹¬ ë°›ì€ ê°’ì„ ì¸ë±ì‹±ì— ë°˜ì˜í•˜ë„ë¡ êµ¬í˜„í–ˆë‹¤.</p>

<p>Elastic SearchëŠ” ì‚¬ìš©ë²•ì´ ë³µì¡í•˜ê¸´ í•˜ì§€ë§Œ, ì¸ë±ì‹±ëœ í•„ë“œ ê°’ì— ë”°ë¼ ë‚´ë¦¼ì°¨ìˆœ, ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ë¯¸ë¦¬ ì •ë ¬ëœ ê²°ê³¼ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤. ê·¸ëŸ°ë°, ì•„ë¬´ë¦¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ í•œë‹¤ê³  í•´ë„, ì¸ë±ì‹±ëœ ê°’ë§Œìœ¼ë¡œ ì •ë ¬ì´ ë¶ˆê°€ëŠ¥í•œ ê²½ìš°ê°€ ìˆê³ , ì´ ê²½ìš°ì—ëŠ” ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°›ì•„ì„œ í›„ ì²˜ë¦¬ë¡œ ë°°ì—´ì„ ìˆœíšŒí•˜ë©´ì„œ ë‹¤ì‹œ ì •ë ¬ì„ í•´ì•¼ í•œë‹¤. ê°™ì€ í´ë˜ìŠ¤ì˜ Public ë©”ì„œë“œê°€ ì •ë ¬ ìš”ì²­ì„ í•˜ë¯€ë¡œ, ë‹¹ì—°íˆ Protected ë©”ì„œë“œë¡œ êµ¬í˜„í–ˆë‹¤.</p>

<p>ì¼ë°˜ì ìœ¼ë¡œ ì•Œë ¤ì§„ <strong>í…ŒìŠ¤íŠ¸ ëª¨ë²” ì‚¬ë¡€</strong>ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<ul>
  <li><strong>ë‚´ê°€ ì§  ì½”ë“œë§Œ í…ŒìŠ¤íŠ¸í•œë‹¤.</strong> ì™¸ë¶€ì—ì„œ ê°€ì ¸ì˜¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í…ŒìŠ¤íŠ¸í•  ì´ìœ ëŠ” ì—†ë‹¤.</li>
  <li><strong>Public ë©”ì„œë“œë§Œ í…ŒìŠ¤íŠ¸í•œë‹¤.</strong> Privateë‚˜ Protected ë©”ì„œë“œëŠ” Public ë©”ì„œë“œê°€ ì‘ë™í•˜ëŠ”ë° ë„ì›€ì„ ì£¼ëŠ” ë©”ì„œë“œë“¤ì´ë¯€ë¡œ, Public ë©”ì„œë“œë¥¼ í…ŒìŠ¤íŠ¸í•¨ìœ¼ë¡œì¨ ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ëœë‹¤.</li>
</ul>

<p>í›„ì²˜ë¦¬ ì •ë ¬ì˜ ì •ìƒ ì‘ë™ì„ í™•ì¸í•´ì•¼ í•  í•„ìš”ì„±ì´ ìƒê¸´ ê²ƒì´ë‹¤. ë¬¼ë¡  êµ¬í˜„í•œ Protected ë©”ì„œë“œì˜ ê°€ì‹œì„±ì„ Publicìœ¼ë¡œ ë³€ê²½í•˜ë©´ ì‰½ë‹¤. ê·¸ëŸ°ë°, ë‹¤ë¥¸ í´ë˜ìŠ¤ì—ì„œ í˜¸ì¶œí•˜ì§€ë„ ì•Šì„ ë©”ì„œë“œë¥¼ Publicìœ¼ë¡œ ì„ ì–¸í•˜ëŠ” ê²ƒì€ ê¸°ë¶„ì´ ì°œì°œí•˜ë‹¤. ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” <strong>Privateë‚˜ Protectedë¡œ ì„ ì–¸ëœ ë©”ì„œë“œë¥¼ ìœ ë‹› í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…</strong>í•œë‹¤. ê²°ë¡ ë¶€í„° ë§í•˜ë©´, <strong>PHPì˜ <code class="highlighter-rouge">Reflection</code> APIë¥¼ ì´ìš©</strong>í•˜ëŠ” ê²ƒì´ë‹¤.</p>

<!--more-->
<div class="spacer">â€¢ â€¢ â€¢</div>

<h2 id="1-í…ŒìŠ¤íŠ¸-íƒ€ê²Ÿ">1. í…ŒìŠ¤íŠ¸ íƒ€ê²Ÿ</h2>

<p>í…ŒìŠ¤íŠ¸ì˜ ëŒ€ìƒì€ ì•„ë˜ í´ë˜ìŠ¤ì˜ <code class="highlighter-rouge">sortByStoreStatusAndCanBuyNow()</code> ë©”ì„œë“œë‹¤. ì—¬ëŸ¬ ë‹¨ê³„ë¥¼ ê±°ì¹˜ê¸´ í•˜ì§€ë§Œ, Publicìœ¼ë¡œ ì„ ì–¸í•œ <code class="highlighter-rouge">query()</code> ë©”ì„œë“œì˜ ì˜í•´ì„œ í˜¸ì¶œëœë‹¤. ì¸ë¼ì¸ìœ¼ë¡œ ê°„ëµí•œ ì„¤ëª…ì„ ë‹¬ì•„ ë‘ì—ˆë‹¤.</p>

<p>ì°¸ê³ ë¡œ <strong>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë‚˜ì˜¨ <a href="//bootake.com"><code class="highlighter-rouge">Bootake</code>ëŠ” ë‚´ê°€ ì†í•œ íšŒì‚¬ì—ì„œ í•˜ëŠ” ì„œë¹„ìŠ¤</a> ì¤‘ í•˜ë‚˜</strong>ë‹¤. ì´ë²ˆì— êµ¬í˜„í•œ ì½”ë“œëŠ” ì•„ì§ ì„œë¹„ìŠ¤ì— ë°˜ì˜ë˜ì§„ ì•Šì•˜ë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// core/Infrastructure/Queries/CvsProduct.php</span>

<span class="kn">namespace</span> <span class="nn">Search\Infrastructure\Queries</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Bootake\SearchService\Thrift\Search\Product</span> <span class="k">as</span> <span class="n">ThriftProduct</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Bootake\SearchService\Thrift\Search\SearchFilter</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Bootake\SearchService\Thrift\Search\Section</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Bootake\SearchService\Thrift\Search\SectionType</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Illuminate\Support\Collection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Search\Application\OutMappers\ProductMapper</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Search\Domain\Product</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">CvsProduct</span> <span class="k">extends</span> <span class="nx">BaseQuery</span> <span class="k">implements</span> <span class="nx">Queryable</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">model</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ì—˜ë¡œí€€íŠ¸ ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë‹¤. ëª¨ë¸ì— ì„ ì–¸í•œ ëª‡ ê°€ì§€ ì†ì„±ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œ í•„ìš”í•˜ë‹¤.</span>
        <span class="c1">// BaseQueryë¼ëŠ” ì¶”ìƒ ë¶€ëª¨ í´ë˜ìŠ¤ì—ì„œ abstract functionìœ¼ë¡œ ì´ ë©”ì„œë“œì˜ êµ¬í˜„ì„ ê°•ì œí•˜ê³  ìˆë‹¤.</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">query</span><span class="p">(</span><span class="nx">SearchFilter</span> <span class="nv">$sf</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$regionId</span><span class="p">,</span> <span class="nv">$offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Elastic Searchë¡œ ë¶€í„° ë°›ì€ ê²€ìƒ‰ ê²°ê³¼ë¥¼ $rawResultsì— ë‹´ì•˜ë‹¤.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawResults</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">search</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">buildParam</span><span class="p">(</span><span class="nv">$sf</span><span class="p">,</span> <span class="nv">$regionId</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="c1">// ê²€ìƒ‰ ê²°ê³¼ëŠ” ì—¬ëŸ¬ ìƒì ì—ì„œ ì œí¼ì„ ê²€ìƒ‰í•˜ë¯€ë¡œ ë™ì¼ ì œí’ˆì´ ê²€ìƒ‰ ê²°ê³¼ì— ë‚˜íƒ€ë‚œë‹¤.</span>
        <span class="c1">// Elastic SearchëŠ” ì´ë¯¸ Aggregation(GROUP BY)ëœ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,</span>
        <span class="c1">// íŠ¹ì • í•„ë“œ ê°’ì— ë”°ë¼ Aggregationí–ˆì„ ë•Œì˜ IDê°’ì„ ê²°ê³¼ì— í¬í•¨í•˜ì—¬ ë°˜í™˜í•œë‹¤.</span>
        <span class="c1">// í•´ì„œ ì‹¤ì œ í•„ìš”í•œ ê°œìˆ˜ë³´ë‹¤ ë” ë§ì€ ë ˆì½”ë“œë¥¼ ìš”ì²­í•˜ê³ , í•„ìš”í•œ ë ˆì½”ë“œë§Œ ê³¨ë¼ë‚¸ í›„ í˜ì´ì§•ì„ í•´ì•¼ í•œë‹¤.</span>
        <span class="c1">// ë¶€ëª¨ í´ë˜ìŠ¤ì˜ fetch() ë©”ì„œë“œê°€ ì´ ì—­í• ì„ ë‹´ë‹¹í•œë‹¤.</span>
        <span class="nv">$filtered</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">model</span><span class="o">-&gt;</span><span class="na">distinctAttribute</span><span class="p">(),</span> <span class="nv">$offset</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">buildSection</span><span class="p">(</span><span class="nv">$filtered</span><span class="p">,</span> <span class="nv">$sf</span><span class="p">,</span> <span class="nv">$regionId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">buildParam</span><span class="p">(</span><span class="nx">SearchFilter</span> <span class="nv">$sf</span><span class="p">,</span> <span class="nv">$regionId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Elastic Searchì— ì „ë‹¬í•  ê²€ìƒ‰ íŒŒë¼ë¯¸í„°ë‹¤.</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="c1">// ...</span>
        <span class="p">];</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">buildSection</span><span class="p">(</span><span class="nx">Collection</span> <span class="nv">$payload</span><span class="p">,</span> <span class="nx">SearchFilter</span> <span class="nv">$sf</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$regionId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// HTTP ì‘ë‹µìœ¼ë¡œ ë°˜í™˜í•  í•„ë“œë§Œ ê³¨ë¼ì„œ ë§µí•‘í•œë‹¤.</span>
        <span class="c1">// ì´ ê³¼ì •ì—ì„œ ëŸ°íƒ€ì„ì— ê³„ì‚°í•´ì•¼ í•  ê°’ë“¤ì„ ì¶”ê°€í•˜ê±°ë‚˜, ë°ì´í„°ë¥¼ ê°€ê³µí•˜ê±°ë‚˜ ìºìŠ¤íŒ…í•˜ê¸°ë„ í•œë‹¤.</span>
        <span class="nv">$mapped</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">ProductMapper</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">mapCollection</span><span class="p">(</span><span class="nv">$payload</span><span class="p">,</span> <span class="nv">$sf</span><span class="p">,</span> <span class="nv">$regionId</span><span class="p">);</span>
        
        <span class="c1">// ì •ë ¬í•œë‹¤. ì´ í¬ìŠ¤íŠ¸ì˜ ëŒ€ìƒì´ ë˜ëŠ” ë¬¸ì œì˜ ë©”ì„œë“œê°€ ì—¬ê¸°ì„œ í˜¸ì¶œëœë‹¤.</span>
        <span class="c1">// ì •ë ¬í•œ ê²°ê³¼ë¥¼ ë¯¸ë¦¬ ì •ì˜í•œ ThriftProduct Typeì— ë§ë„ë¡ ë§µí•‘í–ˆë‹¤. </span>
        <span class="nv">$sorted</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sortByStoreStatusAndCanBuyNow</span><span class="p">(</span><span class="nv">$mapped</span><span class="p">)</span>
                       <span class="o">-&gt;</span><span class="na">map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="k">array</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
                           <span class="k">return</span> <span class="k">new</span> <span class="nx">ThriftProduct</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
                       <span class="p">})</span>
                       <span class="o">-&gt;</span><span class="na">values</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

        <span class="c1">// $sorted ë°°ì—´ì€ [ThriftProduct, ThriftProduct, ...] í˜•ì‹ì¸ë°,</span>
        <span class="c1">// ì–˜ë¥¼ ë‹¤ì‹œ Thrift ì¸í„°í˜ì´ìŠ¤ì—ì„œ ì •ì˜í•œ Section Typeìœ¼ë¡œ ë©í•‘í•œë‹¤.</span>
        <span class="c1">// getTotal()ë“±ì˜ ë©”ì„œë“œëŠ” ë¶€ëª¨ í´ë˜ìŠ¤ì— ìˆë‹¤.</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Section</span><span class="p">([</span>
            <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">SectionType</span><span class="o">::</span><span class="na">PRODUCT</span><span class="p">,</span>
            <span class="s1">'matchedCount'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTotal</span><span class="p">(),</span>
            <span class="s1">'perPage'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">perPage</span><span class="p">(),</span>
            <span class="s1">'currentPage'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resolveCurrentPage</span><span class="p">(),</span>
            <span class="s1">'stores'</span> <span class="o">=&gt;</span> <span class="p">[],</span>
            <span class="s1">'products'</span> <span class="o">=&gt;</span> <span class="nv">$sorted</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">sortByStoreStatusAndCanBuyNow</span><span class="p">(</span><span class="nx">Collection</span> <span class="nv">$unsorted</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$unsorted</span><span class="o">-&gt;</span><span class="na">sortBy</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 'canBuyNow' ì†ì„±ì€ ë¶ˆë¦¬ì–¸ì´ë¼ ì •ë ¬ì„ ìœ„í•´ ì •ìˆ˜ ê°’ìœ¼ë¡œ ë°”ê¾¸ì–´, $canBuyNow ë³€ìˆ˜ì— í• ë‹¹í–ˆë‹¤.</span>
            <span class="c1">// 'canBuyNow'ëŠ” ì§€ê¸ˆ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆê³¼ ê°™ì€ ìƒì ì˜ ì œí’ˆì´ë€ ì˜ë¯¸ë‹¤.</span>
            <span class="nv">$canBuyNow</span> <span class="o">=</span> <span class="nv">$product</span><span class="p">[</span><span class="s1">'canBuyNow'</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>

            <span class="c1">// ì œí’ˆì´ ì†í•œ ìƒì ì˜ ìƒíƒœ(ì˜ì—… ì¤‘ -&gt; ë°°ì†¡ ì¤€ë¹„ ì¤‘ -&gt; ì˜ì—… ì¤€ë¹„ ì¤‘)ì™€</span>
            <span class="c1">// $canBuyNowë¥¼ ë³µí•©í•´ì„œ ì •ë ¬í•´ì•¼ í•˜ë¯€ë¡œ ë‘ ê°œ ê°’ì„ ê²°í•©í–ˆë‹¤.</span>
            <span class="c1">// ì¦‰, ì§€ê¸ˆ ìƒì ì´ ì˜ì—… ì¤‘ì´ê³  ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆê³¼ ê°™ì€ ìƒí’ˆì´ë¼ ë°”ë¡œ êµ¬ë§¤ ê°€ëŠ¥í•œ ìƒí’ˆì´ ìš°ì„  ë…¸ì¶œëœë‹¤.</span>
            <span class="k">return</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'%d%d'</span><span class="p">,</span> <span class="nv">$product</span><span class="p">[</span><span class="s1">'storeStatus'</span><span class="p">],</span> <span class="nv">$canBuyNow</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="2-í…ŒìŠ¤íŠ¸-ì‘ì„±">2. í…ŒìŠ¤íŠ¸ ì‘ì„±</h2>

<h3 id="21-í…ŒìŠ¤íŠ¸-í—¬í¼">2.1. í…ŒìŠ¤íŠ¸ í—¬í¼</h3>

<p><code class="highlighter-rouge">getTestableMethod()</code> ë©”ì„œë“œëŠ” PHPì˜ <code class="highlighter-rouge">Reflection</code> í´ë˜ìŠ¤ë¥¼ ì´ìš©í•´ì„œ ì¸ìë¡œ ë°›ì€ <code class="highlighter-rouge">$class::$name</code> ë©”ì„œë“œë¥¼ ì´ë²ˆ í”„ë¡œì„¸ìŠ¤ ë™ì•ˆë§Œ Private ë˜ëŠ” Protected ë©”ì„œë“œë¥¼ Publicìœ¼ë¡œ ë³€ê²½í•´ì¤€ë‹¤. ì¦‰, í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë™ì•ˆì€ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ê°€ íƒ€ì¼“ ë©”ì„œë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// tests/TestCase.php</span>

<span class="kn">namespace</span> <span class="nn">Test</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TestCase</span> <span class="k">extends</span> <span class="nx">\Laravel\Lumen\Testing\TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createApplication</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">require</span> <span class="k">__DIR__</span><span class="o">.</span><span class="s1">'/../bootstrap/app.php'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getTestableMethod</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// $classì˜ Reflection ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“ ë‹¤.</span>
        <span class="nv">$reflection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\ReflectionClass</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
        
        <span class="c1">// $name ë©”ì„œë“œë¥¼ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•œë‹¤.</span>
        <span class="nv">$method</span> <span class="o">=</span> <span class="nv">$reflection</span><span class="o">-&gt;</span><span class="na">getMethod</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="nv">$method</span><span class="o">-&gt;</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

        <span class="c1">// Reflectionëœ í´ë˜ìŠ¤ê°€ ì•„ë‹ˆë¼, ë©”ì„œë“œë¥¼ ë°˜í™˜í•œë‹¤.</span>
        <span class="k">return</span> <span class="nv">$method</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="22-í…ŒìŠ¤íŠ¸-ì½”ë“œ">2.2. í…ŒìŠ¤íŠ¸ ì½”ë“œ</h3>

<p>ì´ì œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì“°ë©´ ëœë‹¤. ì• ì ˆì—ì„œ ë§Œë“  í—¬í¼ì—ì„œ ë°˜í™˜ ë°›ì€ ë©”ì„œë“œì— <code class="highlighter-rouge">invokeArgs(í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤, [ë©”ì„œë“œì˜ ì¸ì])</code>ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ ì›ë˜ ê°ì¶”ì§„ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// tests/Unit/QueryTest.php</span>

<span class="kn">namespace</span> <span class="nn">Test\Unit</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Bootake\SearchService\Thrift\Search\StoreStatus</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Elasticsearch\ClientBuilder</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Search\Infrastructure\Queries\CvsProduct</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">QueryTest</span> <span class="k">extends</span> <span class="nx">\Test\TestCase</span>
<span class="p">{</span>
    <span class="cd">/** @test */</span>
    <span class="k">function</span> <span class="nf">cvs_products_collection_should_be_sorted_by_its_parent_store_status</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$productCollection</span> <span class="o">=</span> <span class="nx">collect</span><span class="p">([</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">CLOSED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">CLOSED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">PREPARING</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">PREPARING</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">OPENED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">OPENED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">],</span>
        <span class="p">]);</span>

        <span class="c1">// 1ì ˆì—ì„œ ì„¤ëª…í•œ í…ŒìŠ¤íŠ¸ íƒ€ì¼“ í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“ ë‹¤.</span>
        <span class="nv">$cvsProductQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CvsProduct</span><span class="p">(</span>
            <span class="nx">ClientBuilder</span><span class="o">::</span><span class="na">fromConfig</span><span class="p">([</span><span class="cm">/*...*/</span><span class="p">])</span>
        <span class="p">);</span>

        <span class="c1">// í…ŒìŠ¤íŠ¸ í—¬í¼ë¥¼ ì´ìš©í•´ì„œ ë‹¤ë¥¸ í´ë˜ìŠ¤ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œë¥¼ ê°€ì ¸ì˜¨ë‹¤. </span>
        <span class="nv">$method</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">getTestableMethod</span><span class="p">(</span>
            <span class="nx">CvsProduct</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="s1">'sortByStoreStatusAndCanBuyNow'</span>
        <span class="p">);</span>

        <span class="c1">// ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê³  ë°˜í™˜ê°’ì„ ì €ì¥í•œë‹¤.</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$method</span><span class="o">-&gt;</span><span class="na">invokeArgs</span><span class="p">(</span><span class="nv">$cvsProductQuery</span><span class="p">,</span> <span class="p">[</span><span class="nv">$productCollection</span><span class="p">]);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">OPENED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">],</span>
            <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">()</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">CLOSED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">],</span>
            <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="/images/2016-12-04-img-01.png"><img src="/images/2016-12-04-img-01.png" alt="Unit Test" /></a></p>

<!--more-->
<div class="spacer">â€¢ â€¢ â€¢</div>

<h2 id="ë§-elastic-search-ê²€ìƒ‰-ì„±ëŠ¥">ë§. Elastic Search ê²€ìƒ‰ ì„±ëŠ¥</h2>

<p>ì§€ë‚œ ë‹¬ì— ì—´ë¦° XEConì—ì„œ <a href="https://www.facebook.com/findstar">ì•ˆì •ìˆ˜</a>ë‹˜ì´ <a href="https://laravel.kr/docs/5.3/scout">ë¼ë¼ë²¨ Scout</a>ë¥¼ ë°œí‘œí–ˆëŠ”ë°, ì²­ì¤‘ ì¤‘ì— í•œ ë¶„ì´ Scoutì˜ ì„±ëŠ¥ì— ëŒ€í•œ ì§ˆë¬¸ì„ í•˜ì…¨ë‹¤. ScoutëŠ” Algolia ë˜ëŠ” Elastic Search ë“±ì˜ ê²€ìƒ‰ ì—”ì§„ì„ ë¼ë¼ë²¨ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸° ì‰½ë„ë¡ ë©í•‘í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë‹¤. ë³¸ í¬ìŠ¤íŠ¸ì˜ ì£¼ì œì™€ ë¬´ê´€í•˜ì§€ë§Œ í•„ìê°€ ì¸¡ì •í•œ ì„±ëŠ¥ì„ ë‚¨ê²¨ ë†“ëŠ”ë‹¤.</p>

<p>ê²€ìƒ‰ ìš”ì²­ì„ ìˆ˜ì‹ í•˜ê³  í”„ë ˆì„ì›Œí¬ë¥¼ ë¶€íŒ…í•˜ê³  ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ëŠ” ë©”ì„œë“œì— ë„ë‹¬í•˜ëŠ” ë°ê¹Œì§€ 41ms, ê²€ìƒ‰ ìš”ì²­ì—ëŠ” ìœ„/ê²½ë„ë¥¼ í¬í•¨í•˜ê³  ìˆëŠ”ë° ë°›ì€ ìœ„/ê²½ë„ì— í•´ë‹¹í•˜ëŠ” ì§€ì—­ IDë¥¼ PostgreSQLì„ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì— ë˜ì ¸ ì‘ë‹µì„ ë°›ëŠ”ë°ê¹Œì§€ ê±¸ë¦° ì´ ì‹œê°„ 481ms, 15ë§Œ ì¸ë±ìŠ¤ì— ëŒ€ê³  ê²€ìƒ‰í•˜ê³  ê²°ê³¼ë¥¼ ë°›ì•„ í›„ì²˜ë¦¬í•˜ëŠ” ë“± ëª¨ë“  ì‘ì—…ì„ ë§ˆì¹˜ê³  ì‘ë‹µì„ ë‚´ë³´ê¸° ì§ì „ê¹Œì§€ ê±¸ë¦° ì‹œê°„ 777msë‹¤.</p>

<p>OS Xì˜ PHP ë‚´ì¥ ì›¹ ì„œë²„ì—ì„œ ê²€ìƒ‰ ì„œë¹„ìŠ¤ë¥¼ êµ¬ë™í•˜ê³ , Elastic SearchëŠ” ì›ê²©ì— ìˆëŠ” ìƒíƒœë¡œ í…ŒìŠ¤íŠ¸í–ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># storage/logs/lumen.log</span>

<span class="o">[</span>2016-12-04 15:13:22] search.DEBUG: ê²€ìƒ‰ ìš”ì²­ ìˆ˜ì‹ :SearchService.php:69 <span class="o">[</span>0.04101300239563] 
<span class="o">[</span>2016-12-04 15:13:22] search.DEBUG: RegionId í˜ì¹˜ ì™„ë£Œ<span class="o">(</span><span class="nv">regionId</span><span class="o">=</span><span class="k">****</span><span class="o">)</span>:SearchService.php:77 <span class="o">[</span>0.48165106773376] 
<span class="o">[</span>2016-12-04 15:13:22] search.DEBUG: ê²€ìƒ‰ ì™„ë£Œ:SearchService.php:87 <span class="o">[</span>0.7775821685791] 
<span class="o">[</span>2016-12-04 15:13:22] search.DEBUG: ì„±ëŠ¥ ìš”êµ¬ëŸ‰ <span class="o">[</span><span class="s2">"ë©”ëª¨ë¦¬(MB) : 6.883152"</span>,<span class="s2">"CPU(%): 1.97802734375"</span><span class="o">]</span> 
</code></pre></div></div>
:ET