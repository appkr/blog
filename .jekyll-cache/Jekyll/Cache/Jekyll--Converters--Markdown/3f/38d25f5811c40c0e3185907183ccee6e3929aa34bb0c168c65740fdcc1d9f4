I"­v<p>ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” <strong>PHP ì»¤ë®¤ë‹ˆí‹°ì—ì„œ De facto(ì‚¬ì‹¤ìƒ) í‘œì¤€ìœ¼ë¡œ ì¸ì‹ë˜ëŠ” ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ <a href="https://github.com/Seldaek/monolog">Monolog</a>ì˜ ì‚¬ìš©ë²•ì„ ì†Œê°œ</strong>í•œë‹¤. MonologëŠ” <a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-3-logger-interface.md">PSR-3</a> <code class="highlighter-rouge">LoggerInterface</code>ë¥¼ êµ¬í˜„í•œ êµ¬í˜„ì²´ì´ë©°, RFC-5424ì—ì„œ ì •ì˜í•œ ì‹¬ê°ë„ ê·œê²©(e.g. DEBUG, INFO, ..)ì— ë”°ë¼ ë¡œê·¸ë¥¼ í•¸ë“¤ë§í•œë‹¤. ì»´í¬ì €ë¥¼ ë§Œë“  ì¡°ë¥´ë”” ë³´ê¸°ì•„ë…¸(Jordi Boggiano)ê°€ êµ¬í˜„í–ˆìœ¼ë©°, <strong>íŒŒì¼ ë¿ë§Œ ì•„ë‹ˆë¼ ë°ì´í„°ë² ì´ìŠ¤, ë©”ì¼, SaaS ì„œë¹„ìŠ¤ë“± ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ë¡œê·¸ë¥¼ ì²˜ë¦¬</strong>í•  ìˆ˜ ìˆë‹¤.</p>

<p>ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¼ë¼ë²¨ í”„ë¡œì íŠ¸ì—ì„œ ê¸°ë³¸ ë¡œê·¸ ì €ì¥ì†Œì¸ íŒŒì¼(<code class="highlighter-rouge">storage/logs/laravel.log</code>)ì— ë”í•´ì„œ Elastic Searchì—ë„ ë¡œê·¸ë¥¼ ì ì¬í•˜ëŠ” ë°©ë²•ì„ ë‹¤ë£¬ë‹¤. ë‹¤ìŒ ë„êµ¬ ë˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•œë‹¤.</p>

<ul>
  <li>ë¼ë¼ë²¨: PHP í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡œ ì‘ì„±ëœ í’€ ìŠ¤íƒ ì›¹ í”„ë ˆì„ì›Œí¬<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup></li>
  <li>Elastic Search: ê²€ìƒ‰ì— íŠ¹í™”ëœ ë°ì´í„°ë² ì´ìŠ¤. CRUD ë° ì„¤ì •ì„ ìœ„í•œ REST APIë¥¼ ì œê³µí•œë‹¤.<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup></li>
  <li>Docker: ì»¨í…Œì´ë„ˆí™”ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ìš´ì˜ í™˜ê²½ì„ ê´€ë¦¬í•˜ëŠ” ë„êµ¬<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup></li>
</ul>

<p>ì´ í¬ìŠ¤íŠ¸ì˜ ì†ŒìŠ¤ ì½”ë“œëŠ” <a href="https://github.com/appkr/monolog-scratchpad">https://github.com/appkr/monolog-scratchpad</a>ì—ì„œ ë°›ì„ ìˆ˜ ìˆë‹¤.</p>

<!--more-->
<div class="spacer">â€¢ â€¢ â€¢</div>

<h2 id="1-ë¡œê·¸-ì“°ê¸°">1. ë¡œê·¸ ì“°ê¸°</h2>

<p>ìƒˆë¡œ ë§Œë“  ë¼ë¼ë²¨ í”„ë¡œì íŠ¸ì˜ ë¼ìš°íŒ… ì •ì˜ íŒŒì¼ì„ ì´ìš©í•´ì„œ ë¡œê·¸ë¥¼ ì¨ ë´¤ë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// routes/web.php</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nv">$message</span> <span class="o">=</span> <span class="s2">"Hello Monolog"</span><span class="p">;</span>
    <span class="nv">$context</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'bar'</span><span class="p">];</span>
    
    <span class="nb">Log</span><span class="o">::</span><span class="na">emergency</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
    <span class="nb">Log</span><span class="o">::</span><span class="na">alert</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
    <span class="nb">Log</span><span class="o">::</span><span class="na">critical</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
    <span class="nb">Log</span><span class="o">::</span><span class="na">error</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
    <span class="nb">Log</span><span class="o">::</span><span class="na">warning</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
    <span class="nb">Log</span><span class="o">::</span><span class="na">notice</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
    <span class="nb">Log</span><span class="o">::</span><span class="na">info</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
    <span class="nb">Log</span><span class="o">::</span><span class="na">debug</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">'welcome'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>ê·¸ë¦¬ê³ , ë¡œê·¸ íŒŒì¼ì„ í™•ì¸í•´ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ê°€ ê¸°ë¡ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># storage/logs/laravel.log</span>

<span class="o">[</span>2016-12-03 06:58:34] local.EMERGENCY: Hello Monolog <span class="o">{</span><span class="s2">"foo"</span>:<span class="s2">"bar"</span><span class="o">}</span> 
<span class="o">[</span>2016-12-03 06:58:34] local.ALERT: Hello Monolog  
<span class="o">[</span>2016-12-03 06:58:34] local.CRITICAL: Hello Monolog  
<span class="o">[</span>2016-12-03 06:58:34] local.ERROR: Hello Monolog  
<span class="o">[</span>2016-12-03 06:58:34] local.WARNING: Hello Monolog  
<span class="o">[</span>2016-12-03 06:58:34] local.NOTICE: Hello Monolog  
<span class="o">[</span>2016-12-03 06:58:34] local.INFO: Hello Monolog  
<span class="o">[</span>2016-12-03 06:58:34] local.DEBUG: Hello Monolog  
</code></pre></div></div>

<h2 id="2-monolog-ì‚´í´-ë³´ê¸°">2. Monolog ì‚´í´ ë³´ê¸°</h2>

<p>Monolog ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë””ë ‰í† ë¦¬ êµ¬ì¡°ë¡œ, í¬ê²Œ ë³´ë©´</p>

<ol>
  <li>PSR-3 <code class="highlighter-rouge">LoggerInterface</code> êµ¬í˜„ì²´</li>
  <li>ë¡œê·¸ í•¸ë“¤ëŸ¬</li>
  <li>ë¡œê·¸ í¬ë§¤í„°</li>
  <li>ë¡œê·¸ í”„ë¡œì„¸ì„œ</li>
</ol>

<p>ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. ê°ê°ì˜ ì—­í• ê³¼ ì˜ˆëŠ” ì•„ë˜ ë¸”ëŸ­ì— ì¸ë¼ì¸ ì£¼ì„ìœ¼ë¡œ í‘œì‹œí–ˆë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/monolog-scratchpad <span class="nv">$ </span>tree vendor/monolog/monolog/src/Monolog
<span class="c"># vendor/monolog/monolog/src/Monolog</span>
<span class="c"># â”œâ”€â”€ ErrorHandler.php            # Monologë¥¼ ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬ê¸°ë¡œ ë“±ë¡í•  ë•Œ í¸ë¦¬í•œ í—¬í¼</span>
<span class="c"># â”œâ”€â”€ Logger.php                  # PSR-3 LoggerInterfaceë¥¼ êµ¬í˜„í•œ êµ¬ì²´ í´ë˜ìŠ¤</span>
<span class="c"># â”œâ”€â”€ Registry.php                # ë¡œê±° ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë“±ë¡í•´ë†“ì€ ê°„ë‹¨í•œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í´ë˜ìŠ¤</span>
<span class="c"># |                                 ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì—¬ëŸ¬ ê°œì˜ ë¡œê±°ë¥¼ ì‚¬ìš©í•  ë•Œ ì“´ë‹¤.</span>
<span class="c"># â”œâ”€â”€ Formatter                   # í¬ë§¤í„°</span>
<span class="c"># â”‚Â Â  â”œâ”€â”€ FormatterInterface.php</span>
<span class="c"># â”‚Â Â  â”œâ”€â”€ ...</span>
<span class="c"># â”‚Â Â  â””â”€â”€ LineFormatter.php       # ë¡œê·¸ë¥¼ ë¬¸ìì—´(String)ë¡œ í¬ë§¤íŒ…í•œë‹¤.</span>
<span class="c"># â”œâ”€â”€ Handler                     # ë¡œê·¸ í•¸ë“¤ëŸ¬</span>
<span class="c"># â”‚Â Â  â”œâ”€â”€ AbstractHandler.php</span>
<span class="c"># â”‚Â Â  â”œâ”€â”€ HandlerInterface.php</span>
<span class="c"># â”‚Â Â  â”œâ”€â”€ ErrorLogHandler.php     # ë¡œê·¸ë¥¼ stdoutìœ¼ë¡œ ë³´ë‚¸ë‹¤.</span>
<span class="c"># â”‚Â Â  â”œâ”€â”€ ...</span>
<span class="c"># â”‚Â Â  â””â”€â”€ SlackHandler.php        # ë¡œê·¸ë¥¼ ìŠ¬ë™ìœ¼ë¡œ ë³´ë‚¸ë‹¤.</span>
<span class="c"># â””â”€â”€ Processor                   # í”„ë¡œì„¸ì„œ, ë¡œê·¸ë¥¼ ê°€ê³µí•˜ê±°ë‚˜ ì¶”ê°€ ì •ë³´ë¥¼ ë”í•œë‹¤.</span>
<span class="c">#  Â Â  â”œâ”€â”€ ...</span>
<span class="c">#  Â Â  â””â”€â”€ GitProcessor.php        # ë¡œê·¸ì— Git ë¸Œëœì¹˜ì™€ ì»¤ë°‹ í•´ì‹œë¥¼ ì¶”ê°€í•œë‹¤.</span>
<span class="c">#</span>
<span class="c"># 7 directories, 88 files</span>
</code></pre></div></div>

<h2 id="3-elastic-searchë¥¼-ì´ìš©í•œ-ë¡œê·¸-í•¸ë“¤ë§">3. Elastic Searchë¥¼ ì´ìš©í•œ ë¡œê·¸ í•¸ë“¤ë§</h2>

<h3 id="31-elastic-search-ì„¤ì¹˜">3.1. Elastic Search ì„¤ì¹˜</h3>

<p>Elastic Searchë¥¼ ì´ìš©í•˜ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<ol>
  <li>ê²€ìƒ‰ì´ ë¹ ë¥´ë‹¤.</li>
  <li><a href="https://www.elastic.co/products/kibana">Kibana</a> ë“± ì‹œê°í™” ë„êµ¬ì™€ ì—°ê²°í•˜ê¸° ì¢‹ë‹¤.</li>
</ol>

<h4 id="311-docker-ë°ëª¬-ì„¤ì¹˜">3.1.1. Docker ë°ëª¬ ì„¤ì¹˜</h4>

<p>ì•„ë˜ ì„¤ì¹˜ë²•ì€ ë§¥ OS X ê¸°ì¤€ì¸ë°, ë‹¤ë¥¸ ìš´ì˜ì²´ì œë„ <a href="https://www.docker.com/">Docker í™ˆí˜ì´ì§€</a>ë¥¼ ë°©ë¬¸í•´ì„œ Docker íŒ¨í‚¤ì§€ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ìœ¼ë©´ ëœë‹¤. Docker íŒ¨í‚¤ì§€ëŠ” ê°€ë²¼ìš´ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ê³¼ ìœ í‹¸ë¦¬í‹°ì˜ ëª¨ìŒì´ë¼ê³  ì´í•´í•˜ë©´ ëœë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>brew tap caskroom/cask
<span class="nv">$ </span>brew cask <span class="nb">install </span>docker <span class="nt">--appdir</span><span class="o">=</span>/Application
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">Note</code>`</strong> Docker ë°ëª¬ì€ ê´€ë¦¬ì ê¶Œí•œì„ ìš”êµ¬í•˜ë¯€ë¡œ, ì„¤ì¹˜ í›„ ìµœì´ˆ í•œë²ˆ ì‹¤í–‰í•´ì„œ ìš´ì˜ì²´ì œ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ê¶Œí•œì„ ë¶€ì—¬í•´ì•¼í•œë‹¤.</p>

<h4 id="312-elastic-search-ì´ë¯¸ì§€-ë‹¤ìš´ë¡œë“œ-ë°-ì‹¤í–‰">3.1.2. Elastic Search ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë° ì‹¤í–‰</h4>

<p>Dockerë¥¼ ì“°ëŠ” ì´ìœ ëŠ” í™˜ê²½ ê²©ë¦¬ë‹¤. í˜¸ìŠ¤íŠ¸ ìš´ì˜ì²´ì œê°€ ìœˆë„ìš°ë“  ë§¥ì´ë“  Docker ì´ë¯¸ì§€ëŠ” ê°™ì€ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ìœ„ì—ì„œ ì‘ë™í•˜ë¯€ë¡œ í˜¸ìŠ¤íŠ¸ ìš´ì˜ì²´ì œì˜ ì˜í–¥ì„ ë°›ì§€ ì•ŠëŠ”ë‹¤. ê²Œë‹¤ê°€ ìš´ì˜ì²´ì œì— ë§ì¶˜ ë³µì¡í•œ ì»´íŒŒì¼ ê³¼ì •ì„ ê±°ì¹˜ì§€ ì•Šì•„ë„ ëœë‹¤. ê·¸ëƒ¥ ì•„ë˜ ëª…ë ¹ì–´ë“¤ì„ ë³µì‚¬í•´ì„œ ì½˜ì†”ì— ë¶™ì—¬ë„£ê¸°ë§Œ í•˜ë©´ ëœë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„ì»¤ ì»¨í…Œì´ë„ˆì™€ í˜¸ìŠ¤íŠ¸ ë¨¸ì‹ ì´ ê³µìœ í•  í´ë”ë¥¼ ë§Œë“ ë‹¤.</span>
<span class="c"># í˜¸ìŠ¤íŠ¸ ë¨¸ì‹ ì´ë€ ë¡œì»¬ ì»´í“¨í„°ë¥¼ ë§í•œë‹¤. </span>
<span class="c"># Docker ì´ë¯¸ì§€ëŠ” ì„œë²„ì˜ ìŠ¤ëƒ…ìƒ·ì´ê³  ì´ë¥¼ ì‹¤í–‰í•œ ìƒíƒœë¥¼ ì»¨í…Œì´ë„ˆë¼ í•œë‹¤(ì •í™•í•œ í‘œí˜„ì€ ì•„ë‹ˆë‹¤.)</span>
~/monolog-scratchpad <span class="nv">$ </span><span class="nb">mkdir </span>esdata

<span class="c"># ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ê³  ì‹¤í–‰í•œë‹¤.</span>
~/monolog-scratchpad <span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
    <span class="nt">--name</span> es50 <span class="se">\</span>
    <span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/esdata:/usr/share/elasticsearch/data <span class="se">\</span>
    <span class="nt">-p</span> 9200:9200 <span class="se">\</span>
    elasticsearch
<span class="c"># Unable to find image 'elasticsearch:latest' locally</span>
<span class="c"># ...</span>
<span class="c"># Status: Downloaded newer image for elasticsearch:latest</span>
<span class="c"># a88d12860180...</span>

<span class="c"># ì‹¤í–‰ ìƒíƒœë¥¼ í™•ì¸í•œë‹¤.</span>
<span class="c"># CONTAINER ID í•´ì‹œëŠ” í•„ìì˜ ê²ƒê³¼ ë‹¤ë¥´ë‹¤.</span>
~/monolog-scratchpad <span class="nv">$ </span>docker ps
<span class="c"># CONTAINER ID        IMAGE            COMMAND    CREATED    STATUS    PORTS    NAMES</span>
<span class="c"># a88d12860180        elasticsearch    ...        ...        ...       9200/tcp es50</span>
</code></pre></div></div>

<p>ë¸Œë¼ìš°ì €ì—ì„œ <code class="highlighter-rouge">http://localhost:9200</code>ì„ ë°©ë¬¸í•´ì„œ ë°©ê¸ˆ Docker ì»¨í…Œì´ë„ˆë¡œ êµ¬ë™í•œ Elastic Searchê°€ ì˜ ì‘ë™í•˜ë‚˜ í™•ì¸í•´ ë³´ì.</p>

<p><a href="/images/2016-12-03-img-01.png"><img src="/images/2016-12-03-img-01.png" alt="Elastic Search Welcome Page" /></a></p>

<h3 id="32-elastic-search-php-í´ë¼ì´ì–¸íŠ¸-ì„¤ì¹˜-ë°-ì‘ë™-í™•ì¸">3.2. Elastic Search PHP í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜ ë° ì‘ë™ í™•ì¸</h3>

<p>ì•ì„œ Elastic SearchëŠ” REST APIë¥¼ ì œê³µí•œë‹¤ê³  í–ˆë‹¤. REST APIë¥¼ ì†Œë¹„í•˜ëŠ” PHP í´ë¼ì´ì–¸íŠ¸ë¥¼ ì„¤ì¹˜í•œë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/monolog-scratchpad <span class="nv">$ </span>composer require elasticsearch/elasticsearch
</code></pre></div></div>

<p>ë¼ìš°íŠ¸ ì •ì˜ íŒŒì¼ë¡œ ì„¤ì¹˜í•œ Elastic Search ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì‘ë™í•˜ì§€ëŠ” í™•ì¸í•œë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// routes/web.php </span>

<span class="kn">use</span> <span class="nn">Elasticsearch\ClientBuilder</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nv">$esClient</span> <span class="o">=</span> <span class="nx">ClientBuilder</span><span class="o">::</span><span class="na">create</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">build</span><span class="p">();</span>
    <span class="nx">dd</span><span class="p">(</span><span class="nv">$esClient</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p><a href="/images/2016-12-03-img-02.png"><img src="/images/2016-12-03-img-02.png" alt="Elastic Search Client" /></a></p>

<h3 id="33-monologë¥¼-ìœ„í•œ-elastic-search-í•¸ë“¤ëŸ¬-ë§Œë“¤ê¸°">3.3. Monologë¥¼ ìœ„í•œ Elastic Search í•¸ë“¤ëŸ¬ ë§Œë“¤ê¸°</h3>

<p>Monolog ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ëŠ” <code class="highlighter-rouge">ElasticSearchHandler</code>ê°€ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆë‹¤. ê·¸ëŸ°ë°, ì• ì ˆì—ì„œ ì„¤ì¹˜í•œ Elastic Search ê³µì‹ í´ë¼ì´ì–¸íŠ¸ê°€ ì•„ë‹Œ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤. APIê°€ ë‹¬ë¼ ë¶€ë“ì´ ë³„ë„ì˜ í•¸ë“¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤. Monologì™€ Elastic Search ë¬¸ì„œë¥¼ ì½ì–´ ë³´ë‹ˆ ì–´ë µì§€ ì•Šë‹¤. ë§Œë“¤ì–´ ë³´ì.</p>

<p>ë¼ë¼ë²¨ <a href="https://laravel.com/docs/5.3/errors#configuration">ê³µì‹ ë¬¸ì„œ</a>ì—ì„œëŠ” <code class="highlighter-rouge">bootstrap/app.php</code>ì—ì„œ ë“±ë¡í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•˜ê³  ìˆë‹¤. ì¢€ ë” ê³ ê¸‰ì§€ê³ , ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì¬í™œìš©í•  ìˆ˜ ìˆë„ë¡ ë³„ë„ ì„œë¹„ìŠ¤ í”„ë¡œë°”ì´ë”ë¡œ ë§Œë“¤ì–´ ë´¤ë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/monolog-scratchpad <span class="nv">$ </span>php artisan make:provider CustomLogProvider
</code></pre></div></div>

<p><code class="highlighter-rouge">boot()</code> ë©”ì„œë“œì—ì„œ <code class="highlighter-rouge">ESHandler</code> ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ê³  í¬ë§¤í„°ì™€ í”„ë¡œì„¸ì„œë¥¼ ì¶”ê°€í•œ í›„, <code class="highlighter-rouge">Monolog</code> ì¸ìŠ¤í„´ìŠ¤ì— ì¶”ê°€í•œë‹¤. ëª‡ ê°€ì§€ ì˜ˆì œë¥¼ ë” ì¶”ê°€í–ˆëŠ”ë° ì¸ë¼ì¸ ì£¼ì„ì„ ë‹¬ì•„ ë‘ì—ˆë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Providers/CustomLogProvider.php</span>

<span class="kn">namespace</span> <span class="nn">App\Providers</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">App\LogHandlers\ESHandler</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Elasticsearch\ClientBuilder</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Illuminate\Support\ServiceProvider</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Monolog\Formatter\NormalizerFormatter</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Monolog\Processor\WebProcessor</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">CustomLogProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ë¼ë¼ë²¨ì´ ë¶€íŒ…í•˜ë©´ì„œ ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆì— ì´ë¯¸ ë“±ë¡í•´ë†“ì€ Monolog ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì˜¨ë‹¤.</span>
        <span class="nv">$monolog</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">[</span><span class="s1">'log'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getMonolog</span><span class="p">();</span>
        
        <span class="c1">// Elastic Search REST í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“ ë‹¤.</span>
        <span class="nv">$esClient</span> <span class="o">=</span> <span class="nx">ClientBuilder</span><span class="o">::</span><span class="na">create</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">build</span><span class="p">();</span>
        
        <span class="c1">// Monologì— ì¶”ê°€í•  Elastic Search í•¸ë“¤ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“ ë‹¤.</span>
        <span class="nv">$esHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ESHandler</span><span class="p">(</span><span class="nv">$esClient</span><span class="p">);</span>
        
        <span class="c1">// NormalizerFormatterëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ë‚´ì¥ë˜ì–´ ìˆë‹¤.</span>
        <span class="c1">// Monolog ë©”ì„œë“œì˜ ì¸ìì¸ $message, $context ê°’ì„ ì •ê·œí™”í•œë‹¤.</span>
        <span class="c1">// ì •ê·œí™”ë€ ë°ì´í„° íƒ€ì…ì„ íŒë‹¨í•˜ê³  ì ì¡€í•œ í˜•íƒœë¡œ ê°€ê³µí•˜ëŠ” ê²ƒì„ ë§í•œë‹¤.</span>
        <span class="nv">$esHandler</span><span class="o">-&gt;</span><span class="na">setFormatter</span><span class="p">(</span><span class="k">new</span> <span class="nx">NormalizerFormatter</span><span class="p">(</span><span class="s1">'Y-m-d\TH:i:s.uP'</span><span class="p">));</span>
        
        <span class="c1">// WebProcessorëŠ” HTTP ìš”ì²­ì—ì„œ url, ip, http_method, referrer ë“±ì˜ </span>
        <span class="c1">// ê°’ì„ ì¶”ì¶œí•˜ê³  ë¡œê·¸ ë©”ì‹œì§€ì— ì¶”ê°€í•˜ëŠ” ì¼ì„ í•œë‹¤.</span>
        <span class="nv">$esHandler</span><span class="o">-&gt;</span><span class="na">pushProcessor</span><span class="p">(</span><span class="k">new</span> <span class="nx">WebProcessor</span><span class="p">);</span>
        
        <span class="c1">// Monolog ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ê¸°ë³¸ í¬í•¨ëœ í”„ë¡œì„¸ì„œê°€ ì•„ë‹Œ ì •ë§ ì •ë§ ì»¤ìŠ¤ì»´ í”„ë¡œì„¸ì„œë¥¼ ì¶”ê°€í•´ì„œ</span>
        <span class="c1">// ë¡œê¹…í•  ë°ì´í„°ë¥¼ ë” ì¶”ê°€í•œë‹¤. ì—¬ê¸°ì„œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„, ë²„ì „, HTTP ìš”ì²­ì„ êµ¬ë¶„í•  ìˆ˜ ìˆëŠ” Hash ê°’ì„ ì¶”ê°€í–ˆë‹¤.</span>
        <span class="nv">$esHandler</span><span class="o">-&gt;</span><span class="na">pushProcessor</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="k">array</span> <span class="nv">$record</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$record</span><span class="p">[</span><span class="s1">'extra'</span><span class="p">][</span><span class="s1">'app_name'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">config</span><span class="p">(</span><span class="s1">'app.name'</span><span class="p">);</span>
            <span class="nv">$record</span><span class="p">[</span><span class="s1">'extra'</span><span class="p">][</span><span class="s1">'app_version'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">env</span><span class="p">(</span><span class="s1">'APP_VERSION'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
            <span class="nv">$record</span><span class="p">[</span><span class="s1">'extra'</span><span class="p">][</span><span class="s1">'fingerprint'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">fingerprint</span><span class="p">();</span>
            <span class="k">return</span> <span class="nv">$record</span><span class="p">;</span>
        <span class="p">});</span>
        
        <span class="c1">// Elastic Search í•¸ë“¤ëŸ¬ë¥¼ Monologì— ì¶”ê°€í–ˆë‹¤.</span>
        <span class="c1">// MonologëŠ” í•¸ë“¤ëŸ¬ë¥¼ ìŒ“ì•„ ë‘ì—ˆë‹¤ê°€, í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•œë‹¤.</span>
        <span class="c1">// ì¦‰, ë¼ë¼ë²¨ì´ ê¸°ë³¸ìœ¼ë¡œ ìƒì„±í•œ StreamHanlder(íŒŒì¼ ë¡œê·¸)ë¥¼ ì‹¤í–‰í•˜ê³ , ë°©ê¸ˆ ë§Œë“  ESHandlerë„ ì‹¤í–‰í•œë‹¤.</span>
        <span class="c1">// ì´ë¯¸ ìƒì„±ëœ ì¸ìŠ¤í„´ìŠ¤ì˜ ì†ì„±ì„ ë³€ê²½í•˜ëŠ” ê²ƒì´ë¯€ë¡œ returní•  í•„ìš” ì—†ë‹¤.</span>
        <span class="nv">$monolog</span><span class="o">-&gt;</span><span class="na">pushHandler</span><span class="p">(</span><span class="nv">$esHandler</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì´ì œ <code class="highlighter-rouge">ESHandler</code>ë¥¼ ë§Œë“¤ ì°¨ë¡€ì¸ë°, Elastic Search API ë¬¸ì„œë¥¼ ì°¸ê³ í•´ì•¼ í•œë‹¤. ë‹¤ìŒ ì½”ë“œ ë¸”ë¡ì—ì„œ <code class="highlighter-rouge">write</code> ë©”ì„œë“œëŠ” ë¶€ëª¨ í´ë˜ìŠ¤ì—ì„œ êµ¬í˜„ì„ ê°•ì œí•œ ë©”ì„œë“œì´ë©°, ë©”ì„œë“œ ë³¸ë¬¸ì€ Elastic Search PHP í´ë¼ì´ì–¸íŠ¸ì˜ ì‚¬ìš©ë²•ì„ ì°¸ê³ í•œ ê²ƒì´ë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/LogHandlers/ESHandler.php</span>

<span class="kn">namespace</span> <span class="nn">App\LogHandlers</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Elasticsearch\Client</span> <span class="k">as</span> <span class="n">ESClient</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Monolog\Handler\AbstractProcessingHandler</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Monolog\Logger</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ESHandler</span> <span class="k">extends</span> <span class="nx">AbstractProcessingHandler</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$esClient</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">ESClient</span> <span class="nv">$esClient</span><span class="p">,</span> <span class="nv">$level</span> <span class="o">=</span> <span class="nx">Logger</span><span class="o">::</span><span class="na">DEBUG</span><span class="p">,</span> <span class="nv">$bubble</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="nv">$bubble</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esClient</span> <span class="o">=</span> <span class="nv">$esClient</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">write</span><span class="p">(</span><span class="k">array</span> <span class="nv">$record</span> <span class="o">=</span> <span class="p">[])</span>
    <span class="p">{</span>
        <span class="nv">$payload</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'refresh'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s1">'body'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="s1">'index'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                        <span class="s1">'_index'</span> <span class="o">=&gt;</span> <span class="s1">'monolog'</span><span class="p">,</span>
                        <span class="s1">'_type'</span> <span class="o">=&gt;</span> <span class="nx">config</span><span class="p">(</span><span class="s1">'app.name'</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">],</span>
                <span class="nv">$record</span><span class="p">[</span><span class="s1">'formatted'</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">];</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esClient</span><span class="o">-&gt;</span><span class="na">bulk</span><span class="p">(</span><span class="nv">$payload</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="34-ì„œë¹„ìŠ¤-í”„ë¡œë°”ì´ë”-ë“±ë¡-ë°-í…ŒìŠ¤íŠ¸">3.4. ì„œë¹„ìŠ¤ í”„ë¡œë°”ì´ë” ë“±ë¡ ë° í…ŒìŠ¤íŠ¸</h3>

<p>ë¼ë¼ë²¨ í”„ë¡œì íŠ¸ì—ì„œ ì„œë¹„ìŠ¤ í”„ë¡œë°”ì´ë”ë¥¼ ë“±ë¡í•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì´ë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// config/app.php</span>

<span class="k">return</span> <span class="p">[</span>
    <span class="c1">// ...</span>
    <span class="s1">'providers'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="c1">// ...</span>
        <span class="nx">App\Providers\CustomLogProvider</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span>
</code></pre></div></div>

<p>ë¼ìš°íŠ¸ ì •ì˜ íŒŒì¼ì—ì„œ ë¡œê·¸ ì“°ëŠ” ë¶€ë¶„ì„ ì¢€ ë” ë‹¨ìˆœíˆ ê³ ì³¤ë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// web/routes.php</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nv">$message</span> <span class="o">=</span> <span class="s2">"Hello Monolog"</span><span class="p">;</span>
    <span class="nv">$context</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'bar'</span><span class="p">];</span>
    <span class="nb">Log</span><span class="o">::</span><span class="na">debug</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">'welcome'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>ì•„ë˜ ê·¸ë¦¼ì€ <code class="highlighter-rouge">http://localhost:9200/monolog/Laravel/_search?size=100&amp;sort=datetime:desc</code>ë¡œ ìš”ì²­í–ˆì„ ë•Œì˜ ì¶œë ¥ ê²°ê³¼ë‹¤.</p>

<p><a href="/images/2016-12-03-img-03.png"><img src="/images/2016-12-03-img-03.png" alt="Elastic Searchì— ì ì¬ëœ ë¡œê·¸" /></a></p>

<p>ë¼ë¼ë²¨ì˜ ë¡œê·¸ ì €ì¥ì†Œ(íŒŒì¼)ì—ë„ ì˜ ê¸°ë¡ë˜ì—ˆë‚˜ í™•ì¸í•´ ë³´ì.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># storage/logs/laravel.log</span>

<span class="o">[</span>2016-12-03 10:36:35] local.DEBUG: Hello Monolog <span class="o">{</span><span class="s2">"foo"</span>:<span class="s2">"bar"</span><span class="o">}</span> 
</code></pre></div></div>

<h2 id="4-ê²°ë¡ ">4. ê²°ë¡ </h2>

<p><strong>MonologëŠ” PHP ì»¤ë®¤ë‹ˆí‹° ê·œì¹™ì„ ë”°ë¥´ëŠ” ë¡œê±°</strong>ë¡œì„œ, í•¸ë“¤ëŸ¬, í¬ë§¤í„°, í”„ë¡œì„¸ì„œ ë“±ì˜ ê¸°ëŠ¥ì„ ì´ìš©í•´ì„œ, ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê¹…ì˜ ììœ ë„ì™€ í™•ì¥ì„±ì„ ì œê³µí•œë‹¤. ë³¸ë¬¸ì—ì„œ ë´¤ë‹¤ì‹œí”¼ <strong>í•¸ë“¤ëŸ¬ë¥¼ ê³„ì† ìŠ¤íƒœí‚¹(stacking)í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ë¡œê·¸ë¥¼ ì²˜ë¦¬</strong>í•  ìˆ˜ ìˆë‹¤. ê°€ë ¹ ì´ ê¸€ì˜ ì˜ˆì œì²˜ëŸ¼ íŒŒì¼ì—ë„ ì“°ê³ , Elastic Searchì—ë„ ì“°ê³ , ë§ë¶™ì—¬ì„œ <code class="highlighter-rouge">stdout</code> ë˜ëŠ” <code class="highlighter-rouge">stderr</code>ë¡œë„ ì¶œë ¥í•˜ê³  ì‹¶ë‹¤ë©´ <code class="highlighter-rouge">ErrorLogHandler</code>ë¥¼ ì¶”ê°€í•˜ë©´ ëœë‹¤. ì•„ë˜ì²˜ëŸ¼ ë§ì´ë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Providers/CustomLogProvider.php</span>

<span class="kd">class</span> <span class="nc">CustomLogProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$errorLogHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Monolog\Handler\ErrorLogHandler</span><span class="p">();</span>
        <span class="nv">$monolog</span><span class="o">-&gt;</span><span class="na">pushHandler</span><span class="p">(</span><span class="nv">$errorLogHandler</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">Note</code></strong> Docker ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í•˜ë ¤ë©´ <code class="highlighter-rouge">docker stop es50</code> ëª…ë ¹ì„ ìˆ˜í–‰í•œë‹¤. <code class="highlighter-rouge">docker rm es50</code> ëª…ë ¹ìœ¼ë¡œ ì´ë¯¸ ë§Œë“  ì»¨í…Œì´ë„ˆë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì§€ ì•Šì•˜ë‹¤ë©´ ë‹¤ìŒ ë²ˆ ì‹¤í–‰í•  ë•ŒëŠ” <code class="highlighter-rouge">docker start es50</code> ëª…ë ¹ìœ¼ë¡œ ê°„ë‹¨íˆ ì‹œì‘í•  ìˆ˜ ìˆë‹¤. Elastic SearchëŠ” ê½¤ ë¬´ê±°ìš´ ì„œë¹„ìŠ¤ë¼ ë¶€íŒ…í•˜ëŠ”ë° 10ì´ˆ ì •ë„ ê±¸ë¦´ ìˆ˜ ìˆë‹¤.</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>ë¼ë¼ë²¨ https://laravel.comÂ <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>Elastic Search https://www.elastic.co/kr/Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>Docker https://www.docker.com/Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
:ET