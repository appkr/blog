I"î±<p>ì•ì„œ <a href="/work-n-play/how-to-use-apache-thrift-in-php-part-1/">1ë¶€</a>ì—ì„œëŠ” ë‹¤ìŒ ë‚´ìš©ì„ ë‹¤ë£¨ì—ˆë‹¤.</p>

<ul>
  <li>RPC ì‹œìŠ¤í…œì— ëŒ€í•œ ì´í•´ì™€ ì—¬ëŸ¬ ê°€ì§€ RPC í”„ë ˆì„ì›Œí¬ì˜ íŠ¹ì§•</li>
  <li>Thrift IDL(Interface Definition Language)ë¥¼ ì´ìš©í•´ì„œ API ê·œê²© ë§Œë“œëŠ” ë°©ë²•</li>
  <li>API ê·œê²©ì„ ë‹¤ì–‘í•œ ì–¸ì–´ë¡œ ì»´íŒŒì¼í•˜ê³  ë¼ì´ë¸ŒëŸ¬ë¦¬í™” í•˜ëŠ” ë°©ë²•</li>
  <li>API ì„œë²„ í”„ë¡œì íŠ¸ì— ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í”ŒëŸ¬ê·¸ì¸í•˜ê³  API ê·œê²©ì— ë§ì¶˜ ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí•˜ëŠ” ë°©ë²•</li>
  <li>API í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ì ‘ì†í•˜ì—¬ Thrift í”„ë¡œí† ì½œë¡œ í†µì‹ í•˜ëŠ” ë°©ë²•</li>
</ul>

<p>1ë¶€ì—ì„œ ì–¸ê¸‰í–ˆë‹¤ì‹œí”¼, <strong>Thrift ìš”ì²­ê³¼ ì‘ë‹µì€ Thrift í”„ë¡œí† ì½œ ì•ˆìª½ì—ì„œ (ì—­)ì§ë ¬í™”</strong> ëœë‹¤. 1ë¶€ì˜ ë‚´ìš©ë§Œìœ¼ë¡œëŠ” ë””ë²„ê¹…ì´ ì–´ë ¤ì›Œ ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí•˜ê¸°ê°€ ìˆ˜ì›”ì¹˜ ì•Šë‹¤. ê·¸ë˜ì„œ 2ë¶€ì—ì„œëŠ” ë‹¤ìŒ ë‚´ìš©ì„ ë‹¤ë£¬ë‹¤.</p>

<ul>
  <li><strong>Thrift í”„ë¡œí† ì½œ ì•ˆìª½ì—ì„œ ì‘ë™í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´</strong>ë¥¼ ë§Œë“¤ì–´ì„œ Thrift ìš”ì²­ì„ í•¸ë“¤ë§í•˜ê³  ê·¸ ê³¼ì •ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì¡ê³  ì†Œë¹„í•˜ëŠ” ë°©ë²•</li>
  <li><strong>ì±…ì„ ì—°ì‡„(Chain of Responsibility) íŒ¨í„´</strong>ì˜ ì´í•´</li>
  <li>í†µí•© í…ŒìŠ¤íŠ¸(Integration Test) êµ¬í˜„</li>
</ul>

<!--more-->
<div class="spacer">â€¢ â€¢ â€¢</div>

<h2 id="1-í†µí•©-í…ŒìŠ¤íŠ¸-ì‘ì„±">1. í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±</h2>

<p>Thrift í´ë¼ì´ì–¸íŠ¸ê°€ IDLì—ì„œ ì •ì˜í•œ APIë¥¼ í˜¸ì¶œí•˜ëŠ” ê²½ìš°ë¥¼ ìƒì •í•˜ê³ , Outside-Inìœ¼ë¡œ ì„¤ëª…í•˜ëŠ” ê²ƒì´ ë” ì‰¬ìš¸ ê²ƒ ê°™ë‹¤. ì•„ë˜ í†µí•© í…ŒìŠ¤íŠ¸ëŠ” Thrift í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ê³  ê°™ì€ í”„ë¡œì íŠ¸ ë””ë ‰í„°ë¦¬ì— ìˆëŠ” API ì„œë²„ë¥¼ í˜¸ì¶œí•œë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// tests/ThriftClientTest.php</span>

<span class="kn">use</span> <span class="nn">App\Post</span> <span class="k">as</span> <span class="n">EloquentPost</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Post\Post</span> <span class="k">as</span> <span class="n">ThriftPost</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Post\PostServiceClient</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Post\QueryFilter</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Illuminate\Foundation\Testing\DatabaseTransactions</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Thrift\Protocol\TJSONProtocol</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Thrift\Transport\THttpClient</span><span class="p">;</span>

<span class="cd">/**
 * @property \Appkr\Thrift\Post\PostServiceClient client
 */</span>
<span class="kd">class</span> <span class="nc">ThriftClientTest</span> <span class="k">extends</span> <span class="nx">TestCase</span>
<span class="p">{</span>
    <span class="c1">// í…ŒìŠ¤íŠ¸ ì¤‘ì— ìƒì„±ëœ ë°ì´í„°ë¥¼ í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ ë¡¤ë°±í•´ì£¼ëŠ” ë¼ë¼ë²¨ì˜ ë‚´ì¥ Traitë‹¤.  </span>
    <span class="kn">use</span> <span class="nn">DatabaseTransactions</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">setUp</span><span class="p">();</span>

        <span class="nv">$transport</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THttpClient</span><span class="p">(</span>
            <span class="s1">'localhost'</span><span class="p">,</span>
            <span class="s1">'8000'</span><span class="p">,</span>
            <span class="s1">'api/posts'</span>
        <span class="p">);</span>

        <span class="nv">$protocol</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TJSONProtocol</span><span class="p">(</span><span class="nv">$transport</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PostServiceClient</span><span class="p">(</span><span class="nv">$protocol</span><span class="p">);</span>

        <span class="c1">// í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë ˆì½”ë“œ 20ê°œë¥¼ ë§Œë“ ë‹¤.</span>
        <span class="c1">// testAll, testFind, testStore ë“± í…ŒìŠ¤íŠ¸ ë©”ì„œë“œê°€ ì„¸ ê°œì´ë¯€ë¡œ ì´ ì„¸ ë²ˆ í˜¸ì¶œëœë‹¤.</span>
        <span class="nx">factory</span><span class="p">(</span><span class="nx">EloquentPost</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testAll</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$queryFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryFilter</span><span class="p">([</span>
            <span class="s1">'keyword'</span> <span class="o">=&gt;</span> <span class="s1">'Lorem'</span><span class="p">,</span>
            <span class="s1">'sortBy'</span> <span class="o">=&gt;</span> <span class="s1">'id'</span><span class="p">,</span>
            <span class="s1">'sortDirection'</span> <span class="o">=&gt;</span> <span class="s1">'desc'</span>
        <span class="p">]);</span>

        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">(</span><span class="nv">$queryFilter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

        <span class="nb">print_r</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$response</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Loremì´ë€ í…ìŠ¤íŠ¸ë¥¼ ê°€ì§„ ë ˆì½”ë“œê°€ ì—†ì„ ìˆ˜ë„ ìˆì–´, if ì ˆì— ë„£ì—ˆë‹¤.</span>
            <span class="c1">// ì‘ë‹µìœ¼ë¡œ ë°›ì€ ì»¬ë ‰ì…˜ì˜ ìš”ì†Œê°€ ThriftPost ê°ì²´ì¸ì§€ ê²€ì‚¬í•œë‹¤(IDLì— ê·¸ë ‡ê²Œ ì •ì˜í–ˆìŒ).</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertInstanceOf</span><span class="p">(</span><span class="nx">ThriftPost</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nv">$response</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testFind</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="nb">print_r</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertInstanceOf</span><span class="p">(</span><span class="nx">ThriftPost</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testStore</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">store</span><span class="p">(</span>
            <span class="s1">'foo'</span><span class="p">,</span>
            <span class="s1">'Lorem content'</span>
        <span class="p">);</span>

        <span class="nb">print_r</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertInstanceOf</span><span class="p">(</span><span class="nx">ThriftPost</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="2-ì„œë¹„ìŠ¤-ìˆ˜ì •">2. ì„œë¹„ìŠ¤ ìˆ˜ì •</h2>

<p>1ë¶€ì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ë„˜ê¸´ <code class="highlighter-rouge">QueryFilter</code>ë¥¼ ì´ìš©í•´ì„œ ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ê±°ë‚˜, ì •ë ¬í•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•˜ì§€ ì•Šì•˜ë‹¤. ë³¸ í¬ìŠ¤íŠ¸ì˜ ì£¼ì œì™€ëŠ” í¬ê²Œ ê´€ë ¨ì€ ì—†ì§€ë§Œ, Thrift IDLì—ì„œ ì •ì˜í•œ <code class="highlighter-rouge">struct</code>ë¥¼ ì‚¬ìš©í•˜ëŠ” ë²•ì„ ì—¿ë³¼ ìˆ˜ ìˆë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Services/PostService.php</span>

<span class="kn">namespace</span> <span class="nn">App\Services</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">App\Post</span> <span class="k">as</span> <span class="n">EloquentPost</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Post\Post</span> <span class="k">as</span> <span class="n">ThriftPost</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Post\PostField</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Post\PostServiceIf</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Post\QueryFilter</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">PostService</span> <span class="k">implements</span> <span class="nx">PostServiceIf</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">all</span><span class="p">(</span><span class="nx">QueryFilter</span> <span class="nv">$qf</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EloquentPost</span><span class="p">;</span>

        <span class="c1">// $qf ë³€ìˆ˜ëŠ” QueryFilter ê°ì²´ë‹¤.</span>
        <span class="c1">// $qf ë³€ìˆ˜ëŠ” ë¼ë¼ë²¨ì—ì„œ ì“°ë˜ Request ê°ì²´ë¼ê³  ìƒê°í•˜ë©´ ë˜ëŠ”ë°,</span>
        <span class="c1">// Thriftì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ IDLì— ì •ì˜í•œ ê°ì²´(struct)ë¥¼ ë„˜ê¸°ë¯€ë¡œ</span>
        <span class="c1">// ì„œë²„ì—ì„œ $qf-&gt;keywordì²˜ëŸ¼ ê°ì²´ ì•¡ì„¸ìŠ¤ë¥¼ í•  ìˆ˜ ìˆë‹¤.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$qf</span><span class="o">-&gt;</span><span class="na">keyword</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ê³ ê¸‰ DBë¥¼ ì‚¬ìš©í•œë‹¤ë©´ Full text BOOLEAN MATCHë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.</span>
            <span class="c1">// ì—¬ê¸°ì„œëŠ” ê°„ëµíˆ QueryFilterë¥¼ ì‚¬ìš©í•˜ëŠ” ì»¨ì…‰ë§Œ ì†Œê°œí•œë‹¤.</span>
            <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'like'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">{</span><span class="nv">$qf</span><span class="o">-&gt;</span><span class="na">keyword</span><span class="si">}</span><span class="s2">%"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$posts</span> <span class="o">=</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="nv">$qf</span><span class="o">-&gt;</span><span class="na">sortBy</span><span class="p">,</span> <span class="nv">$qf</span><span class="o">-&gt;</span><span class="na">sortDirection</span><span class="p">)</span>
                         <span class="o">-&gt;</span><span class="na">offset</span><span class="p">(</span><span class="nv">$offset</span><span class="p">)</span>
                         <span class="o">-&gt;</span><span class="na">limit</span><span class="p">(</span><span class="nv">$limit</span><span class="p">)</span>
                         <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$posts</span><span class="o">-&gt;</span><span class="na">map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">ThriftPost</span><span class="p">(</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">toArray</span><span class="p">());</span>
        <span class="p">})</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 1ë¶€ì™€ ë™ì¼ ...</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 1ë¶€ì™€ ë™ì¼ ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="3-ë¯¸ë“¤ì›¨ì–´ì™€-ì±…ì„-ì—°ì‡„-íŒ¨í„´">3. ë¯¸ë“¤ì›¨ì–´ì™€ ì±…ì„ ì—°ì‡„ íŒ¨í„´</h2>

<p>ë¯¸ë“¤ì›¨ì–´ë€ ì•„ì¼€ì´ë“œ ê²Œì„ì—ì„œ ìµœì¢… ë³´ìŠ¤ë¥¼ ë§Œë‚˜ê¸° ìœ„í•´ì„œ ìƒëŒ€í•´ì•¼ í•˜ëŠ” ì¤‘ê°„ ë³´ìŠ¤, ë˜ëŠ” ìµœì¢… ê²°ì¬ë¥¼ ë°›ê¸° ìœ„í•´ ê±°ì³ì•¼ í•˜ëŠ” ì¤‘ê°„ ê²°ì¬ì„ ì— ë¹„ìœ í•  ìˆ˜ ìˆë‹¤. ì¤‘ê°„ ê³¼ì •ì„ í†µê³¼í•˜ì§€ ëª»í•˜ë©´ ìµœì¢… ëª©ì ì§€ì— ë„ë‹¬í•˜ì§€ ëª»í•œë‹¤. ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” <code class="highlighter-rouge">PostService</code>ì— ë„ë‹¬í•˜ê¸° ìœ„í•´ì„œ ê±°ì³ì•¼ í•˜ëŠ” ì¤‘ê°„ ê³¼ì •ìœ¼ë¡œ ì´í•´í•˜ë©´ ëœë‹¤. ë‹¤ìŒ ê·¸ë¦¼ì„ ì°¸ê³ í•˜ì.</p>

<p><a href="https://rofildex86.files.wordpress.com/2015/02/clack-middleware-2.png"><img src="https://rofildex86.files.wordpress.com/2015/02/clack-middleware-2.png" alt="Http Middleware" /></a></p>

<p><small>ê·¸ë¦¼ ì¶œì²˜: <a href="https://rofildex86.wordpress.com/2015/02/20/laravel5-series-4-middleware/">Laravel/5 Series 4: Middleware</a></small></p>

<p>ë¯¸ë“¤ì›¨ì–´ë¥¼ êµ¬í˜„í•˜ëŠ”ë° ì í•©í•œ íŒ¨í„´ì€ ì±…ì„ ì—°ì‡„ íŒ¨í„´(Chain of Responsibility)ì´ë‹¤.</p>

<h3 id="31-ì„œë¹„ìŠ¤ì—-ë¯¸ë“¤ì›¨ì–´-ì ìš©í•˜ê¸°">3.1. ì„œë¹„ìŠ¤ì— ë¯¸ë“¤ì›¨ì–´ ì ìš©í•˜ê¸°</h3>

<p>ê¸€ë¡œ ì„¤ëª…í•˜ê¸° ë„ˆë¬´ í˜ë“¤ë‹¤, ì¦‰ ì„¤ëª…í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì€ í•„ìë„ ì˜ ëª¨ë¥¸ë‹¤ëŠ” ì˜ë¯¸ì´ê¸°ë„ í•˜ë‹¤ã…œã…œ. ì½”ë“œì— ì¸ë¼ì¸ ì£¼ì„ì„ ì°¸ê³ í•œë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Http/Controllers/PostsController</span>

<span class="kn">namespace</span> <span class="nn">App\Http\Controllers</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">App\Services\PostService</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">App\Thrift\BarMiddleware</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">App\Thrift\FooMiddleware</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">App\Thrift\ThriftResponse</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">App\Thrift\ThriftServiceHandler</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Post\PostServiceProcessor</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Illuminate\Http\Request</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">PostsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$format</span> <span class="o">=</span> <span class="s1">'json'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ê·¸ë¦¼ì—ì„œ ë³¸ ê²ƒì²˜ëŸ¼ Thrift ìš”ì²­ì€ ë°”ê¹¥ìª½ì— ìˆëŠ” FooMiddlewareë¥¼ ë¨¼ì € ê±°ì¹˜ê²Œ ëœë‹¤.</span>
        <span class="nv">$middleware</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FooMiddleware</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">BarMiddleware</span>
        <span class="p">);</span>

        <span class="nv">$service</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PostService</span><span class="p">();</span>
        <span class="c1">// PostServiceë¥¼ ì•ì„œ ë§Œë“  ë¯¸ë“¤ì›¨ì–´ë¡œ ì‹¸ì„œ ThriftServiceHandlerë¥¼ ë§Œë“¤ì—ˆë‹¤. </span>
        <span class="nv">$handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ThriftServiceHandler</span><span class="p">(</span><span class="nv">$service</span><span class="p">,</span> <span class="nv">$middleware</span><span class="p">);</span>
        <span class="c1">// ì´ì œ Thrift ì»´íŒŒì¼ëŸ¬ê°€ ë§Œë“¤ì–´ì¤€ í”„ë¡œì„¸ì„œì— ë¯¸ë“¤ì›¨ì–´ë¡œ ì—¬ëŸ¬ê²¹ í¬ì¥í•œ ì„œë¹„ìŠ¤ë¥¼ ë„˜ê²¨ì„œ ì²˜ë¦¬ë¥¼ ìœ„ì„í•œë‹¤.</span>
        <span class="nv">$processor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PostServiceProcessor</span><span class="p">(</span><span class="nv">$handler</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">ThriftResponse</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$processor</span><span class="p">,</span> <span class="nv">$format</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="32-ì„œë¹„ìŠ¤-í•¸ë“¤ëŸ¬-ë§Œë“¤ê¸°">3.2. ì„œë¹„ìŠ¤ í•¸ë“¤ëŸ¬ ë§Œë“¤ê¸°</h3>

<p>ì„œë¹„ìŠ¤ë¥¼ ë¯¸ë“¤ì›¨ì–´ë¡œ ê°ì‹¸ ì¤„ <code class="highlighter-rouge">ThriftServiceHandler</code>ë¥¼ ë§Œë“¤ ì°¨ë¡€ë‹¤. í•¸ë“¤ëŸ¬ì˜ ê°œë…ì„ ì´í•´í•˜ê¸° ì–´ë ¤ìš´ë° ë¯¸ë“¤ì›¨ì–´ê°€ ìˆìœ¼ë©´ ë¯¸ë“¤ì›¨ì–´ë¥¼ êµ¬ë™ì‹œí‚¤ê³ , ì—†ìœ¼ë©´ ì„œë¹„ìŠ¤ë¥¼ ë°”ë¡œ í˜¸ì¶œí•´ ì£¼ëŠ” ë…€ì„ì´ë‹¤. ì§„ì§œ ì„œë¹„ìŠ¤ê°€ ì•„ë‹ˆì§€ë§Œ ìì‹ ì´ ì„œë¹„ìŠ¤ì¸ ì–‘ í–‰ì„¸í•´ì„œ, í”„ë¡œì„¸ì„œê°€ ì„œë¹„ìŠ¤ë¡œ ê°„ì£¼í•˜ê³  í˜¸ì¶œí•˜ëŠ” ë…€ì„ì´ë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Thrift/ThriftServiceHandler.php</span>

<span class="kn">namespace</span> <span class="nn">App\Thrift</span><span class="p">;</span>

<span class="cd">/**
 * @property service
 * @property \App\Thrift\ThriftMiddleware|null middleware
 */</span>
<span class="kd">class</span> <span class="nc">ThriftServiceHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$service</span><span class="p">,</span> <span class="nx">ThriftMiddleware</span> <span class="nv">$middleware</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span> <span class="o">=</span> <span class="nv">$service</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span> <span class="o">=</span> <span class="nv">$middleware</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// ê°€ë ¹ í´ë¼ì´ì–¸íŠ¸ê°€ all APIë¥¼ í˜¸ì¶œí–ˆë‹¤ë©´, PostServiceProcessorê°€ PostService::all()</span>
    <span class="c1">// ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•Œ í´ë¼ì´ì–¸íŠ¸ê°€ ì œì‹œí•œ ì¸ìì¸ QueryParameter ê°ì²´ì™€, offset 0, limit 10ì„</span>
    <span class="c1">// ë„˜ê²¨ì¤€ë‹¤. ê·¸ëŸ°ë°, ì• ì ˆì—ì„œ PostServiceProcessorì— ë„˜ê²¨ ì¤€ ê²ƒì€ PostServiceê°€ ì•„ë‹ˆë¼</span>
    <span class="c1">// ì´ ì„œë¹„ìŠ¤ë¥¼ ë¯¸ë“¤ì›¨ì–´ë¡œ ëª‡ êº¼í’€ ì‹¸ ë†“ì€ ThriftServiceHandlerë¥¼ ë„˜ê²¼ë‹¤.</span>
    <span class="c1">// ThriftServiceHandlerì—ëŠ” all ë©”ì„œë“œê°€ ì—†ë‹¤. ì¼ì¹˜í•˜ëŠ” ë©”ì„œë“œê°€ ì—†ìœ¼ë¯€ë¡œ __call ë©”ì„œë“œê°€ í˜¸ì¶œëœë‹¤. </span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__call</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ìƒì„±ìë¥¼ í†µí•´ ì´ˆê¸°í™”í•œ ë¯¸ë“¤ì›¨ì–´ê°€ ìˆìœ¼ë©´ ì´ ë¡œì§ì„ ìˆ˜í–‰í•œë‹¤.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ë“±ë¡ëœ ë¯¸ë“¤ì›¨ì–´ì˜ handle ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤. 1ì ˆì˜ í…ŒìŠ¤íŠ¸ë¥¼ ê°€ì •í•˜ë©´,</span>
            <span class="c1">// ì´ ë•Œ PostService ê°ì²´, all, [QueryFilter ê°ì²´, 0, 10] ë“±ì„ ì¸ìë¡œ ë„˜ê¸°ê²Œ ëœë‹¤.</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// ë“±ë¡ëœ ë¯¸ë“¤ì›¨ì–´ê°€ ì—†ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ê°€ ì „ë‹¬í•œ ì¸ìë¡œ PostService::all ë©”ì„œë“œë¥¼ ë°”ë¡œ í˜¸ì¶œí•œë‹¤. </span>
        <span class="k">return</span> <span class="nb">call_user_func_array</span><span class="p">([</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">],</span> <span class="nv">$arguments</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="33-ë¯¸ë“¤ì›¨ì–´-ë§Œë“¤ê¸°">3.3. ë¯¸ë“¤ì›¨ì–´ ë§Œë“¤ê¸°</h3>

<p><code class="highlighter-rouge">PostService</code>ë¥¼ ê°ìŒŒë˜ <code class="highlighter-rouge">FooMiddleware</code>ë¥¼ ë§Œë“¤ì–´ ë³´ì(<code class="highlighter-rouge">BarMiddleware</code>ëŠ” ìƒëµí•œë‹¤). ì—­ì‹œ ì¸ë¼ì¸ìœ¼ë¡œ ì£¼ì„ì„ ë‹¬ì•˜ë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Thrift/FooMiddleware.php</span>

<span class="kn">namespace</span> <span class="nn">App\Thrift</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Appkr\Thrift\Errors\ErrorCode</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Errors\SystemException</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Appkr\Thrift\Errors\UserException</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Log</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">FooMiddleware</span> <span class="k">extends</span> <span class="nx">ThriftMiddleware</span>
<span class="p">{</span>
    <span class="c1">// ThriftServiceHandler::__callì—ì„œ ì´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí–ˆë‹¤. </span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// ì»¨ì…‰ë§Œ ë³´ì—¬ ì£¼ê¸° ìœ„í•´ì„œ ë¡œê·¸ì— ë©”ì‹œì§€ë¥¼ ì“°ëŠ” ê²ƒìœ¼ë¡œ ëŒ€ì‹ í•œë‹¤.</span>
            <span class="nb">Log</span><span class="o">::</span><span class="na">info</span><span class="p">(</span><span class="s1">'handling thrift request'</span><span class="p">,</span> <span class="p">[</span><span class="nb">func_get_args</span><span class="p">(),</span> <span class="k">__METHOD__</span><span class="p">]);</span>

            <span class="c1">// ì±…ì„ ì—°ì‡„ íŒ¨í„´ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì´ë‹¤. next ë©”ì„œë“œëŠ” ë‹¤ìŒ ì ˆì—ì„œ ì‚´í´ë³¸ë‹¤.</span>
            <span class="c1">// ìš°ë¦¬ ì˜ˆì œì—ì„œ nextëŠ” BarMiddlewareë‹¤.</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">next</span><span class="p">(</span><span class="nv">$service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">SystemException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ì¶”ê°€ì ì¸ ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ì—¬ê¸°ì„œ í•œë‹¤.</span>
            <span class="c1">// SystemExceptionì€ Thrift IDLì— ì •ì˜í•œ structë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ì™€ ì—°ê²°ëœ í”„ë¡œí† ì½œì„ í†µí•´</span>
            <span class="c1">// ì•ˆì „í•˜ê²Œ ì „ë‹¬ëœë‹¤. í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œë„ SystemExceptionìœ¼ë¡œ ì—­ ì§ë ¬í™”ë˜ì–´ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.</span>
            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">UserException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// SystemException ë° UserExceptionì„ ì œì™¸í•œ ë¼ë¼ë²¨ì˜ ì¼ë°˜ì ì¸ ì˜ˆì™¸ë¥¼ í•¸ë“¤ë§í•œë‹¤.</span>
            <span class="c1">// ì´ ì˜ˆì œì—ì„œëŠ” ë¡œê·¸ì— ë””ë²„ê·¸ ë©”ì‹œì§€ë¥¼ ì“´ë‹¤. Thriftê°€ ì—†ëŠ” ë¼ë¼ë²¨ í”„ë¡œì íŠ¸ë¼ë©´</span>
            <span class="c1">// app/Exceptions/Handler.phpì˜ ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬ê¸°ê°€ ì˜ˆì™¸ë¥¼ ì†Œë¹„í–ˆì„ ê²ƒì´ë‹¤.</span>
            <span class="c1">// ë¼ë¼ë²¨ì˜ Handler::report ë©”ì„œë“œë¥¼ ëŒ€ì‹ í•˜ëŠ” ì—­í• ì„ í•œë‹¤.</span>
            <span class="nb">Log</span><span class="o">::</span><span class="na">debug</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span>
                <span class="s2">"%s </span><span class="se">\n\n</span><span class="s2">%s </span><span class="se">\n</span><span class="s2">%s:%d </span><span class="se">\n\n</span><span class="s2">%s"</span><span class="p">,</span>
                <span class="nb">get_class</span><span class="p">(</span><span class="nv">$e</span><span class="p">),</span>
                <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span>
                <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getFile</span><span class="p">(),</span>
                <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">(),</span>
                <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getTraceAsString</span><span class="p">()</span>
            <span class="p">));</span>

            <span class="c1">// Thrift í´ë¼ì´ì–¸íŠ¸ê°€ ì´í•´í•  ìˆ˜ ìˆëŠ” SystemExceptionìœ¼ë¡œ ë³€ê²½í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ëŒë ¤ì¤€ë‹¤.</span>
            <span class="c1">// ë¼ë¼ë²¨ì˜ Handler::render ë©”ì„œë“œë¥¼ ëŒ€ì‹ í•˜ëŠ” ì—­í• ì„ í•œë‹¤.</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">SystemException</span><span class="p">([</span>
                <span class="s1">'code'</span> <span class="o">=&gt;</span> <span class="nx">ErrorCode</span><span class="o">::</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">,</span>
                <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span>
            <span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="34-ì¶”ìƒ-ë¯¸ë“¤ì›¨ì–´">3.4. ì¶”ìƒ ë¯¸ë“¤ì›¨ì–´</h3>

<p>ì• ì ˆì˜ ì¸ë¼ì¸ ì£¼ì„ì—ì„œ ì±…ì„ ì—°ì‡„ íŒ¨í„´ì— ê°€ì¥ ì¤‘ìš”í•œ ë©”ì„œë“œê°€ <code class="highlighter-rouge">next()</code>ë¼ê³  ë§í•œ ë°” ìˆë‹¤. ì´ ì ˆì—ì„œëŠ” ì´ <code class="highlighter-rouge">next()</code> ë©”ì„œë“œì˜ ì‘ë™ ì›ë¦¬ë¥¼ íŒŒí—¤ì³ë³¸ë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Thrift/ThriftMiddleware.php</span>

<span class="kn">namespace</span> <span class="nn">App\Thrift</span><span class="p">;</span>

<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">ThriftMiddleware</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$successor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">ThriftMiddleware</span> <span class="nv">$successor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 3.1.ì ˆì—ì„œ new FooMiddleware(new BarMiddleware)ì²˜ëŸ¼</span>
        <span class="c1">// ë¯¸ë“¤ì›¨ì–´ ìƒì„±ìì— ë‹¤ë¥¸ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë„£ì€ ê²ƒì„ ê¸°ì–µí•  ê²ƒì´ë‹¤. ë°”ë¡œ ì´ ë¶€ë¶„ì´ë‹¤.</span>
        <span class="c1">// $successorëŠ” ì´ë²ˆ ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µê³¼í•˜ê³  ë‚˜ë©´, ê·¸ ë‹¤ìŒì— í†µê³¼í•´ì•¼ í•  ë¯¸ë“¤ì›¨ì–´ë‹¤.</span>
        <span class="c1">// ì´ì œ FooMiddlewareì˜ $successorëŠ” BarMiddlewareë‹¤.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">successor</span> <span class="o">=</span> <span class="nv">$successor</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">abstract</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">next</span><span class="p">(</span><span class="nv">$service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">successor</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// êµ¬ì²´ ë¯¸ë“¤ì›¨ì–´ í´ë˜ìŠ¤ì˜ handle ë©”ì„œë“œì—ì„œ í•­ìƒ next ë©”ì„œë“œë¥¼ í˜¸ì¶œí–ˆë˜ ê²ƒì„ ê¸°ì–µí•  ê²ƒì´ë‹¤.</span>
            <span class="c1">// FooMiddlewareëŠ” BarMiddlewareë¼ëŠ” $successorë¥¼ ê°€ì§€ê³  ìˆìœ¼ë¯€ë¡œ</span>
            <span class="c1">// BarMiddlware::handle ë©”ì„œë“œê°€ í˜¸ì¶œë  ê²ƒì´ë‹¤.</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">successor</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// ë°˜ë©´ BarMiddlwareëŠ” $succesorê°€ ì—†ìœ¼ë¯€ë¡œ ì•„ë˜ êµ¬ë¬¸ì´ í˜¸ì¶œëœë‹¤.</span>
        <span class="c1">// ì´ ì˜ˆì œì—ì„œëŠ” PostService::all ë©”ì„œë“œê°€ í˜¸ì¶œë˜ëŠ” ê²ƒì´ë‹¤.</span>
        <span class="k">return</span> <span class="nb">call_user_func_array</span><span class="p">([</span><span class="nv">$service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">],</span> <span class="nv">$arguments</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="4-í…ŒìŠ¤íŠ¸">4. í…ŒìŠ¤íŠ¸</h2>

<p>í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë¡œì»¬ ì„œë²„ë¥¼ ê¸°ë™í•˜ê³ , <code class="highlighter-rouge">phpunit</code> í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/thrift-example-project <span class="nv">$ </span>php artisan serve
<span class="c"># Laravel development server started on http://localhost:8000/</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/thrift-example-project $ vendor/bin/phpunit
# PHPUnit 5.6.2 by Sebastian Bergmann and contributors.
# ...
# OK (3 tests, 5 assertions)
</code></pre></div></div>

<p>ë‹¤ìŒ ë¡œê·¸ë¥¼ ë³´ë©´ <code class="highlighter-rouge">FooMiddleware</code> ë° <code class="highlighter-rouge">BarMiddlware</code>ì—ì„œ Thrift ìš”ì²­ì„ ì²˜ë¦¬í•œ í”ì ì„ ë³¼ ìˆ˜ ìˆë‹¤. <code class="highlighter-rouge">all</code>, <code class="highlighter-rouge">find</code>, <code class="highlighter-rouge">store</code> ì´ ì„¸ ê°œì˜ APIë¥¼ í…ŒìŠ¤íŠ¸ í–ˆìœ¼ë¯€ë¡œ ì´ ì—¬ì„¯ ê°œì˜ ë¡œê·¸ê°€ ì°í˜”ë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># storage/logs/laravel.log</span>

<span class="o">[</span>2016-12-10 14:59:53] local.INFO: handling thrift request <span class="o">[[</span><span class="s2">"[object] (App</span><span class="se">\\</span><span class="s2">Services</span><span class="se">\\</span><span class="s2">PostService: {})"</span>,<span class="s2">"all"</span>,[<span class="s2">"[object] (Appkr</span><span class="se">\\</span><span class="s2">Thrift</span><span class="se">\\</span><span class="s2">Post</span><span class="se">\\</span><span class="s2">QueryFilter: {</span><span class="se">\"</span><span class="s2">keyword</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Lorem</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">sortBy</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">id</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">sortDirection</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">desc</span><span class="se">\"</span><span class="s2">})"</span>,0,10]],<span class="s2">"App</span><span class="se">\\</span><span class="s2">Thrift</span><span class="se">\\</span><span class="s2">FooMiddleware::handle"</span><span class="o">]</span> 
<span class="o">[</span>2016-12-10 14:59:53] local.INFO: handling thrift request <span class="o">[[</span><span class="s2">"[object] (App</span><span class="se">\\</span><span class="s2">Services</span><span class="se">\\</span><span class="s2">PostService: {})"</span>,<span class="s2">"all"</span>,[<span class="s2">"[object] (Appkr</span><span class="se">\\</span><span class="s2">Thrift</span><span class="se">\\</span><span class="s2">Post</span><span class="se">\\</span><span class="s2">QueryFilter: {</span><span class="se">\"</span><span class="s2">keyword</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Lorem</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">sortBy</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">id</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">sortDirection</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">desc</span><span class="se">\"</span><span class="s2">})"</span>,0,10]],<span class="s2">"App</span><span class="se">\\</span><span class="s2">Thrift</span><span class="se">\\</span><span class="s2">BarMiddleware::handle"</span><span class="o">]</span> 
<span class="o">[</span>2016-12-10 14:59:53] local.INFO: handling thrift request <span class="o">[[</span><span class="s2">"[object] (App</span><span class="se">\\</span><span class="s2">Services</span><span class="se">\\</span><span class="s2">PostService: {})"</span>,<span class="s2">"find"</span>,[1]],<span class="s2">"App</span><span class="se">\\</span><span class="s2">Thrift</span><span class="se">\\</span><span class="s2">FooMiddleware::handle"</span><span class="o">]</span> 
<span class="o">[</span>2016-12-10 14:59:53] local.INFO: handling thrift request <span class="o">[[</span><span class="s2">"[object] (App</span><span class="se">\\</span><span class="s2">Services</span><span class="se">\\</span><span class="s2">PostService: {})"</span>,<span class="s2">"find"</span>,[1]],<span class="s2">"App</span><span class="se">\\</span><span class="s2">Thrift</span><span class="se">\\</span><span class="s2">BarMiddleware::handle"</span><span class="o">]</span> 
<span class="o">[</span>2016-12-10 14:59:53] local.INFO: handling thrift request <span class="o">[[</span><span class="s2">"[object] (App</span><span class="se">\\</span><span class="s2">Services</span><span class="se">\\</span><span class="s2">PostService: {})"</span>,<span class="s2">"store"</span>,[<span class="s2">"foo"</span>,<span class="s2">"Lorem content"</span><span class="o">]]</span>,<span class="s2">"App</span><span class="se">\\</span><span class="s2">Thrift</span><span class="se">\\</span><span class="s2">FooMiddleware::handle"</span><span class="o">]</span> 
<span class="o">[</span>2016-12-10 14:59:53] local.INFO: handling thrift request <span class="o">[[</span><span class="s2">"[object] (App</span><span class="se">\\</span><span class="s2">Services</span><span class="se">\\</span><span class="s2">PostService: {})"</span>,<span class="s2">"store"</span>,[<span class="s2">"foo"</span>,<span class="s2">"Lorem content"</span><span class="o">]]</span>,<span class="s2">"App</span><span class="se">\\</span><span class="s2">Thrift</span><span class="se">\\</span><span class="s2">BarMiddleware::handle"</span><span class="o">]</span> 
</code></pre></div></div>

<p><code class="highlighter-rouge">FooMiddlware</code>ê°€ ì˜ˆì™¸ë¥¼ ì˜ ì†Œë¹„í•˜ëŠ” ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ê³  í…ŒìŠ¤íŠ¸í–ˆë‹¤. 100ë²ˆ ì•„ì´ë””ë¥¼ ê°€ì§„ ë ˆì½”ë“œëŠ” ì—†ì–´ì„œ ë¼ë¼ë²¨ì—ì„œ <code class="highlighter-rouge">ModelNotFoundException</code>ì´ ë‚˜ì•¼í•˜ê³ , <code class="highlighter-rouge">FooMiddleware</code>ì— ì˜í•´ì„œ Thrift í´ë¼ì´ì–¸íŠ¸ì—ê²Œ <code class="highlighter-rouge">SystemException</code>ìœ¼ë¡œ ì „ë‹¬ë˜ì–´ì•¼ í•œë‹¤.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// tests/ThriftClientTest.php</span>

<span class="kd">class</span> <span class="nc">ThriftClientTest</span> <span class="k">extends</span> <span class="nx">TestCase</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testFind</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

        <span class="nb">print_r</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertInstanceOf</span><span class="p">(</span><span class="nx">ThriftPost</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì•„ë˜ ê·¸ë¦¼ì—ì„œ <code class="highlighter-rouge">Appkr\Thrift\Errors\SystemException: No query results for model [App\Post] 100</code>ì²˜ëŸ¼ ì˜ˆì™¸ ê°ì²´ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì •í™•í•˜ê²Œ ì „ë‹¬ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># PHPUnitì—ì„œ íŠ¹ì • í…ŒìŠ¤íŠ¸ ë©”ì„œë“œë§Œ í•„í„°ë§í•´ì„œ ì‹¤í–‰í•˜ê³  ì‹¶ì„ ë•Œ --filter ì˜µì…˜ì„ ì‚¬ìš©í•œë‹¤.</span>
~/thrift-example-project <span class="nv">$ </span>vendor/bin/phpunit <span class="nt">--filter</span> testFind
</code></pre></div></div>

<p><a href="/images/2016-12-10-img-01.png"><img src="/images/2016-12-10-img-01.png" alt="ModelNotFoundException" /></a></p>

<h2 id="5-ê²°ë¡ ">5. ê²°ë¡ </h2>

<p>Thriftë¥¼ ì‚¬ìš©í•˜ëŠ” ë™ì•ˆ ë””ë²„ê¹…ì˜ ê´´ë¡œì›€ì— ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•„ì•¼ í–ˆë‹¤.</p>

<p>ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ì¢‹ì•˜ë˜ ì ì€ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°„ì˜ ì•½ì†ì„ ì½”ë“œë¡œ í‘œí˜„í•˜ê³ , ê·¸ ì½”ë“œë¥¼ ë¬¸ì„œë¡œ ì¦‰ì‹œ ë³€í™˜í•´ ê³µìœ í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ì—ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ ê°œë°œìê°€ ì„œë²„ ì½”ë“œê°€ ê°œë°œë˜ê³  ë¬¸ì„œê°€ ë‚˜ì˜¤ê¸°ê¹Œì§€ ë© ë•Œë¦¬ê³  ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ë³‘ë ¬ë¡œ ê°œë°œì„ ì‹œì‘í•  ìˆ˜ ìˆì—ˆë‹¤.</p>

<p>ë˜, ì´ê¸°ì¢… ì‹œìŠ¤í…œê°„ì— í•¨ìˆ˜ í˜¸ì¶œì„ í†µí•´ ëª¨ë¸ì„ ê·¸ëŒ€ë¡œ ì£¼ê³  ë°›ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë°ì´í„° ìŠ¤í‚¤ë§ˆë‚˜ ì—­í˜¸í™˜ì„±ê³¼ ê°™ì€ ê³¨ì¹˜êº¼ë¦¬ë¡œ ë¶€í„° í•´ë°©ë  ìˆ˜ ìˆëŠ” ì¥ì •ë¯¸ ìˆì—ˆë‹¤. í’€ì–´ì„œ ë§í•˜ë©´ PHP ì„œë²„ì—ì„œ <code class="highlighter-rouge">Post</code> ëª¨ë¸ì„ ë³´ë‚´ë©´ í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” Java, Javascript, .. ê°ì²´ë¡œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê³ , í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚¸ ê°ì²´ëŠ” ì„œë²„ì—ì„œ PHP ê°ì²´ë¡œ ê·¸ëƒ¥ ì“¸ ìˆ˜ ìˆë‹¤ëŠ” ëœ»ì´ë‹¤.</p>

<p>ì±…ì„ ì—°ì‡„ íŒ¨í„´ì„ í•œ ë²ˆì— ì´í•´í–ˆë‹¤ë©´ ê±°ì§“ë§ì´ë‹¤. ì´ ì˜ˆì œì—ì„œ ì‚¬ìš©í•œ Thrift ë¯¸ë“¤ì›¨ì–´ì˜ ë™ì‘ì„ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ì•„ë˜ ì½œ ìŠ¤íƒ ë‹¤ì´ì–´ê·¸ë¨ìœ¼ë¡œ í‘œí˜„í–ˆë‹¤.</p>

<p><a href="/images/2016-12-10-img-02.png"><img src="/images/2016-12-10-img-02.png" alt="Thrift Middleware Call Stack" /></a></p>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì˜ ì˜ˆì œ í”„ë¡œì íŠ¸ëŠ”</p>

<ul>
  <li><a href="https://github.com/appkr/thrift-example-idl">https://github.com/appkr/thrift-example-idl</a></li>
  <li><a href="https://github.com/appkr/thrift-example-project">https://github.com/appkr/thrift-example-project</a></li>
  <li><a href="https://github.com/appkr/thrift-js-poc-project">https://github.com/appkr/thrift-js-poc-project</a></li>
</ul>

<p>ì— ê³µê°œë˜ì–´ ìˆë‹¤.</p>
:ET