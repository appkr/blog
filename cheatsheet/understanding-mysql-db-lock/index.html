<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <meta name="description" content="MySQL의 잠금 특성을 확인하기 위한 실험 결과입니다.  읽기 잠금의 동작 특성  쓰기 잠금의 동작 특성  트랜잭션과 Row 잠금  라라벨에서 트랜잭션과 잠금"/>
  <meta name="google-site-verification" content="ToXKBimREnz49pDNot4b-N9ZJgYcKXPPsHsjhg4Zzuc" />
  <meta name="naver-site-verification" content="7cebcc8e5493169f5401870d9ce57f48d18491cd"/>

  <meta name="msapplication-tap-highlight" content="no"/>

  <!-- Facebook Meta -->
  <meta property="og:title" content="MySQL 테이블 잠금 실험"/>
  <meta property="og:type" content="Website"/>
  <meta property="og:author" content="appkr (juwonkim@me.com)"/>
  <meta property="og:image" content=""/>

  <!-- Google+ Meta -->
  <meta itemprop="name" content="MySQL 테이블 잠금 실험">
  <meta itemprop="description" content="MySQL의 잠금 특성을 확인하기 위한 실험 결과입니다.  읽기 잠금의 동작 특성  쓰기 잠금의 동작 특성  트랜잭션과 Row 잠금  라라벨에서 트랜잭션과 잠금">
  <meta itemprop="image" content="">
  <meta itemprop="author" content="appkr (juwonkim@me.com)"/>

  <!-- Twitter Meta -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@appkrs" />
  <meta name="twitter:title" content="MySQL 테이블 잠금 실험" />
  <meta name="twitter:description" content="MySQL의 잠금 특성을 확인하기 위한 실험 결과입니다.  읽기 잠금의 동작 특성  쓰기 잠금의 동작 특성  트랜잭션과 Row 잠금  라라벨에서 트랜잭션과 잠금" />
  <meta name="twitter:image" content="" />
  <meta name="twitter:domain" content="blog.appkr.kr">

  <!-- Mobile and Rss -->
  <link rel="canonical" href="http://blog.appkr.kr/cheatsheet/understanding-mysql-db-lock/"/>
  <link rel="alternate" type="application/rss+xml" title="Appkr.memo(new Life)" href="http://blog.appkr.kr/feed.xml"/>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/earlyaccess/nanumgothic.css"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons"/>
  <link rel="stylesheet" href="/styles/main.min.css"/>

  <title>MySQL 테이블 잠금 실험 | Appkr.memo(new Life)</title>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body id="app">

  <nav class="navbar navbar-static-top" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="sr-only">Navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        Appkr.memo(new Life)
      </a>
    </div>

    <div class="navbar-collapse collapse navbar-responsive-collapse">
      <ul class="nav navbar-nav navbar-right text-center">
        <li>
          <a href="/">Blog</a>
        </li>
        <li>
          <a href="/profile/">Profile</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
  <section id="main" class="col-md-9 minimal">
    <article class="box">
      <div class="box-header">
        <h2>
          <span class="title">MySQL 테이블 잠금 실험</span>
          <span class="action dropdown pull-right">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-target="#">
              <i class="material-icons">share</i>
            </a>

            <ul class="dropdown-menu">
              <li>
                <a href="https://www.facebook.com/sharer/sharer.php?u=http://blog.appkr.kr/cheatsheet/understanding-mysql-db-lock/&title=MySQL 테이블 잠금 실험" id="sns-facebook">
                  Facebook
                </a>
              </li>
              <li>
                <a href="http://twitter.com/share?url=http://blog.appkr.kr/cheatsheet/understanding-mysql-db-lock/&title=MySQL 테이블 잠금 실험&text=MySQL 테이블 잠금 실험" id="sns-twitter">
                  Twitter
                </a>
              </li>
              <li>
                <a href="https://plus.google.com/share?url=http://blog.appkr.kr/cheatsheet/understanding-mysql-db-lock/" id="sns-google">
                  Google+
                </a>
              </li>
            </ul>
          </span>
        </h2>

        <p class="box-meta">
          <span>
            <i class="material-icons">today</i>
            2017-08-04
          </span>
          <span>
            <i class="material-icons">face</i>
            Posted by appkr
          </span>
          <span>
            <i class="material-icons">turned_in</i>
            
              <a href="/categories#cheatsheet">
                
                    Cheatsheet
                  
              </a>
              
            
          </span>
          <span>
            <i class="material-icons">forum</i>
            <a href="/cheatsheet/understanding-mysql-db-lock/#disqus_thread" title="comments">0</a>
          </span>
        </p>
      </div>

      <div class="box-body">
        <p>MySQL의 잠금 특성을 확인하기 위한 실험 결과입니다.</p>
<ol>
  <li>읽기 잠금의 동작 특성</li>
  <li>쓰기 잠금의 동작 특성</li>
  <li>트랜잭션과 Row 잠금</li>
  <li>라라벨에서 트랜잭션과 잠금</li>
</ol>

<!--more-->
<div class="spacer">• • •</div>

<p>테스트 테이블 생성</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">lock_test</span> 
<span class="k">DEFAULT</span> <span class="n">CHARACTER</span> <span class="k">SET</span> <span class="o">=</span> <span class="n">utf8</span> <span class="k">DEFAULT</span> <span class="k">COLLATE</span> <span class="o">=</span> <span class="n">utf8_unicode_ci</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">messages</span> <span class="p">(</span>
  <span class="n">id</span> <span class="n">INT</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">message</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">140</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">INNODB</span><span class="p">;</span>

<span class="k">SHOW</span> <span class="k">TABLE</span> <span class="n">STATUS</span> <span class="k">WHERE</span> <span class="n">NAME</span> <span class="o">=</span> <span class="nv">"messages"</span><span class="p">;</span>
</code></pre>
</div>

<h2 id="1-읽기-잠금의-동작-특성">1. 읽기 잠금의 동작 특성</h2>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">LOCK</span> <span class="n">TABLES</span> <span class="n">messages</span> <span class="k">READ</span><span class="p">;</span>
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">PROCESSLIST</span><span class="p">;</span> <span class="c1">-- Query ok</span>
</code></pre>
</div>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="c1">-- 다른 프로세스(=~커넥션=~세션)에서 실행</span>
<span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">LOCK</span> <span class="n">TABLES</span> <span class="n">messages</span> <span class="k">WRITE</span><span class="p">;</span> <span class="c1">-- ...</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">mysql1</code> 프로세스에서 테이블 전체에 대해 읽기 잠금을 걸었으므로, <code class="highlighter-rouge">mysql2</code> 프로세스는 무한 뺑글이.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">PROCESSLIST</span><span class="p">;</span> <span class="c1">-- "Waiting for table metadata lock" &lt;= mysql2 프로세스의 상태</span>
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="n">UNLOCK</span> <span class="n">TABLES</span><span class="p">;</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">mysql1</code>이 테이블 잠금을 푸는 순간 <code class="highlighter-rouge">mysql2</code> 프로세스는 뺑글이 사라지고, 쓰기 잠금 얻어감.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">messages</span><span class="p">;</span> <span class="c1">-- ...</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">mysql2</code> 프로세스가 테이블에 대해 쓰기 잠금을 얻어 갔으므로, <code class="highlighter-rouge">mysql1</code> 프로세스는 무한 뺑글이.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="c1">-- 무한 뺑글이 돌던 SELECT 쿼리 취소 후</span>
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="n">UNLOCK</span> <span class="n">TABLES</span><span class="p">;</span>
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="k">OPEN</span> <span class="n">TABLES</span> <span class="k">FROM</span> <span class="n">lock_test</span><span class="p">;</span> <span class="c1">-- 1</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">mysql2</code> 프로세스가 잠금을 가지고 있으므로 다른 프로세스에서 잠금 해제 불가.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql2</span><span class="o">&gt;</span> <span class="n">UNLOCK</span> <span class="n">TABLES</span><span class="p">;</span>
</code></pre>
</div>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">messages</span><span class="p">;</span> <span class="c1">-- Query ok.</span>
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">LOCK</span> <span class="n">TABLES</span> <span class="n">messages</span> <span class="k">READ</span><span class="p">;</span>
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">messages</span><span class="p">;</span> <span class="c1">-- Query ok.</span>
</code></pre>
</div>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">messages</span><span class="p">;</span> <span class="c1">-- Query ok.</span>
<span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">messages</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'FOO'</span><span class="p">);</span> <span class="c1">-- ...</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">mysql1</code> 프로세스가 읽기 잠금을 걸었으므로, <code class="highlighter-rouge">mysql2</code> 프로세스에서도 읽기는 가능하지만, 쓰기를 시도하면 무한 뺑글이.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">messages</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'BAR'</span><span class="p">);</span> <span class="c1">-- Table 'messages' was locked with a READ lock and can't be updated</span>
</code></pre>
</div>

<p>읽기 잠금을 건 <code class="highlighter-rouge">mysql1</code> 프로세스도 쓰기 불가능을 마찬가지임.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="n">UNLOCK</span> <span class="n">TABLES</span><span class="p">;</span>
</code></pre>
</div>

<p>테이블에 걸린 모든 잠금이 풀렸으므로, 뺑글이를 돌던 <code class="highlighter-rouge">mysql2</code>의 뺑글이는 사라지고 <code class="highlighter-rouge">INSERT</code> 쿼리가 작동함.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">messages</span><span class="p">;</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">mysql2</code> 프로세스에서 <code class="highlighter-rouge">INSERT</code>한 레코드 확인 가능.</p>

<h3 id="11-결론">1.1. 결론</h3>

<ul>
  <li><code class="highlighter-rouge">READ</code>/<code class="highlighter-rouge">WRITE</code> 무관한게 먼저 테이블을 잠근 프로세스가 잠금을 반환하기 전에 다른 프로세스는 잠금을 얻을 수 없다.</li>
  <li><code class="highlighter-rouge">READ</code> 잠금이 걸린 상태에서
    <ul>
      <li>다른 프로세스에서 테이블을 읽는 것은 가능하다.</li>
      <li><code class="highlighter-rouge">READ</code> 잠금은 건 프로세스를 포함해 모든 프로세스에서 테이블에 쓰기 작업은 할 수 없다.</li>
      <li>잠금을 가진 프로세스에서 쓰기를 시도하면 바로 오류가 발생하지만, 다른 프로세스에서는 잠금이 풀릴 때 까지 기다린다.</li>
    </ul>
  </li>
</ul>

<h2 id="2-쓰기-잠금의-동작-특성">2. 쓰기 잠금의 동작 특성</h2>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">LOCK</span> <span class="n">TABLES</span> <span class="n">messages</span> <span class="k">WRITE</span><span class="p">;</span>
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">messages</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'BAZ'</span><span class="p">);</span>
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">messages</span><span class="p">;</span> <span class="c1">-- Query ok.</span>
</code></pre>
</div>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">messages</span><span class="p">;</span> <span class="c1">-- ...</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">mysql2</code> 프로세스에서는 무한 뺑글이.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">RENAME</span> <span class="k">TABLE</span> <span class="n">messages</span> <span class="k">TO</span> <span class="n">new_messages</span><span class="p">;</span> <span class="c1">-- Can't execute the given command because you have active locked tables or an active transaction</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">WRITE</code> 잠금을 가진 <code class="highlighter-rouge">mysql1</code> 프로세스지만, 테이블 이름을 변경하는 등의 DDL은 불가능함.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="n">UNLOCK</span> <span class="n">TABLES</span><span class="p">;</span>
</code></pre>
</div>

<p>테이블에 걸린 모든 잠금이 풀렸으므로, 뺑글이를 돌던 <code class="highlighter-rouge">mysql2</code>의 뺑글이는 사라지고 <code class="highlighter-rouge">SELECT</code> 쿼리가 작동함.</p>

<h3 id="21-결론">2.1. 결론</h3>

<ul>
  <li><code class="highlighter-rouge">WRITE</code> 잠금을 가진 프로세스에서만 읽기, 쓰기 가능하다.</li>
  <li>다른 프로세스에서는 잠금이 풀릴 때가지 읽기, 쓰기 모두 불가능하다.</li>
</ul>

<h2 id="3-트랜잭션과-row-잠금">3. 트랜잭션과 Row 잠금</h2>

<p><code class="highlighter-rouge">SELECT ... LOCK IN SHARE MODE</code> for READ, <code class="highlighter-rouge">SELECT ... FOR UPDATE</code> for UPDATE and DELETE.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">START</span> <span class="n">TRANSACTION</span><span class="p">;</span> 
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">messages</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">LOCK</span> <span class="k">IN</span> <span class="k">SHARE</span> <span class="k">MODE</span><span class="p">;</span>
</code></pre>
</div>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">messages</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">-- Query ok.</span>
<span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">START</span> <span class="n">TRANSACTION</span><span class="p">;</span> 
<span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">messages</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
<span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">COMMIT</span><span class="p">;</span> <span class="c1">-- ...</span>
<span class="c1">-- Lock wait timeout exceeded; try restarting transaction</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">mysql1</code> 프로세스에서 1번 Row를 잠궜지만, <code class="highlighter-rouge">mysql2</code> 프로세스에서 읽기는 가능. 반면, 쓰기 동작을 하려하면 50초 동안 뺑글이를 돌다가 쿼리 실패함. 50초에 대한 힌트는 아래 쿼리에서 찾을 수 있음.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">VARIABLES</span> <span class="k">WHERE</span> <span class="n">VARIABLE_NAME</span> <span class="k">LIKE</span> <span class="nv">"%innodb_lock%"</span><span class="p">;</span> <span class="c1">-- innodb_lock_wait_timeout: 50</span>
</code></pre>
</div>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">messages</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
<span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">COMMIT</span><span class="p">;</span> <span class="c1">-- ...</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">mysql2</code> 프로세스에서 뺑글이가 돌고 있는 상태에서 쨉싸게 <code class="highlighter-rouge">mysql1</code> 프로세스에서 같은 Row 1번을 지움.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">messages</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
<span class="n">mysql1</span><span class="o">&gt;</span> <span class="k">COMMIT</span><span class="p">;</span> <span class="c1">-- No errors; 1 row affected</span>
</code></pre>
</div>

<p>한편 mysql2 프로세스에서는… 데드락이 발생함.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="c1">-- [ERROR in query 2] Deadlock found when trying to get lock; try restarting transaction</span>
<span class="n">mysql2</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">ENGINE</span> <span class="n">INNODB</span> <span class="n">STATUS</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="31-결론">3.1. 결론</h3>

<ul>
  <li>Row 잠금이 걸려도 다른 프로세스에서 읽기는 가능하지만, 쓰기는 불가능하다.</li>
  <li>Row 잠금이 걸린 상태에서 다른 프로세스에서 쓰기를 시도하려 하면, <code class="highlighter-rouge">innodb_lock_wait_timeout</code> 옵션으로 설정된 시간 만큼 기다리다가 잠금을 얻는 것을 포기하고 쿼리 실패한다.</li>
  <li>같은 Row에 대해 여러 개의 프로세스가 동시에 쓰기를 시도할 때 Dead Lock(교착상태)이 발생할 수 있다.</li>
</ul>

<h2 id="4-라라벨에서-트랜잭션과-잠금">4. 라라벨에서 트랜잭션과 잠금</h2>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// https://github.com/appkr/db-lock-poc/blob/master/core/Myshop/Infrastructure/Eloquent/EloquentProductRepository.php#L22-L25
</span>
<span class="nx">DB</span><span class="o">::</span><span class="na">beginTransaction</span><span class="p">();</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="nv">$product</span> <span class="o">=</span> <span class="nx">Product</span><span class="o">::</span><span class="na">lockForUpdate</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findOrFail</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
    <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">prime</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
    <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
    <span class="nx">DB</span><span class="o">::</span><span class="na">commit</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">DB</span><span class="o">::</span><span class="na">rollBack</span><span class="p">();</span>
    <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<div class="spacer">• • •</div>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="c1">-- http://minsql.com/mysql/information_schema-innodb_xxx-%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-lock-%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8/</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">connection_id</span><span class="p">();</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">INNODB_LOCK_WAITS</span><span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">INNODB_LOCKS</span><span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">INNODB_TRX</span><span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">straight_join</span>
   <span class="n">w</span><span class="p">.</span><span class="n">trx_mysql_thread_id</span> <span class="n">waiting_thread</span><span class="p">,</span>
   <span class="n">w</span><span class="p">.</span><span class="n">trx_id</span> <span class="n">waiting_trx_id</span><span class="p">,</span>
   <span class="n">w</span><span class="p">.</span><span class="n">trx_query</span> <span class="n">waiting_query</span><span class="p">,</span>
   <span class="n">b</span><span class="p">.</span><span class="n">trx_mysql_thread_id</span> <span class="n">blocking_thread</span><span class="p">,</span>
   <span class="n">b</span><span class="p">.</span><span class="n">trx_id</span> <span class="n">blocking_trx_id</span><span class="p">,</span>
   <span class="n">b</span><span class="p">.</span><span class="n">trx_query</span> <span class="n">blocking_query</span><span class="p">,</span>
   <span class="n">bl</span><span class="p">.</span><span class="n">lock_id</span> <span class="n">blocking_lock_id</span><span class="p">,</span>
   <span class="n">bl</span><span class="p">.</span><span class="n">lock_mode</span> <span class="n">blocking_lock_mode</span><span class="p">,</span>
   <span class="n">bl</span><span class="p">.</span><span class="n">lock_type</span> <span class="n">blocking_lock_type</span><span class="p">,</span>
   <span class="n">bl</span><span class="p">.</span><span class="n">lock_table</span> <span class="n">blocking_lock_table</span><span class="p">,</span>
   <span class="n">bl</span><span class="p">.</span><span class="n">lock_index</span> <span class="n">blocking_lock_index</span><span class="p">,</span>
   <span class="n">wl</span><span class="p">.</span><span class="n">lock_id</span> <span class="n">waiting_lock_id</span><span class="p">,</span>
   <span class="n">wl</span><span class="p">.</span><span class="n">lock_mode</span> <span class="n">waiting_lock_mode</span><span class="p">,</span>
   <span class="n">wl</span><span class="p">.</span><span class="n">lock_type</span> <span class="n">waiting_lock_type</span><span class="p">,</span>
   <span class="n">wl</span><span class="p">.</span><span class="n">lock_table</span> <span class="n">waiting_lock_table</span><span class="p">,</span>
   <span class="n">wl</span><span class="p">.</span><span class="n">lock_index</span> <span class="n">waiting_lock_index</span>
 <span class="k">FROM</span>
   <span class="n">information_schema</span><span class="p">.</span><span class="n">INNODB_LOCK_WAITS</span> <span class="n">ilw</span> <span class="p">,</span>
   <span class="n">information_schema</span><span class="p">.</span><span class="n">INNODB_TRX</span> <span class="n">b</span> <span class="p">,</span> 
   <span class="n">information_schema</span><span class="p">.</span><span class="n">INNODB_TRX</span> <span class="n">w</span> <span class="p">,</span> 
   <span class="n">information_schema</span><span class="p">.</span><span class="n">INNODB_LOCKS</span> <span class="n">bl</span> <span class="p">,</span> 
   <span class="n">information_schema</span><span class="p">.</span><span class="n">INNODB_LOCKS</span> <span class="n">wl</span>
 <span class="k">WHERE</span>
   <span class="n">b</span><span class="p">.</span><span class="n">trx_id</span> <span class="o">=</span> <span class="n">ilw</span><span class="p">.</span><span class="n">blocking_trx_id</span>
   <span class="k">AND</span> <span class="n">w</span><span class="p">.</span><span class="n">trx_id</span> <span class="o">=</span> <span class="n">ilw</span><span class="p">.</span><span class="n">requesting_trx_id</span>
   <span class="k">AND</span> <span class="n">bl</span><span class="p">.</span><span class="n">lock_id</span> <span class="o">=</span> <span class="n">ilw</span><span class="p">.</span><span class="n">blocking_lock_id</span>
   <span class="k">AND</span> <span class="n">wl</span><span class="p">.</span><span class="n">lock_id</span> <span class="o">=</span> <span class="n">ilw</span><span class="p">.</span><span class="n">requested_lock_id</span><span class="p">;</span>
</code></pre>
</div>

      </div>

      <footer class="box-tags">
        <span><i class="material-icons">label</i> Tags:</span>
        
          <a href="/tags#개발자">
            개발자
          </a>
          , 
        
          <a href="/tags#데이터베이스">
            데이터베이스
          </a>
          
        
      </footer>
    </article>

    <nav id="pagination">
      <ul class="pager">
        
        <li class="previous">
          <a href="/learn-n-think/clean-architecture-and-dependency/">
            <span aria-hidden="true">
              <i class="material-icons">navigate_before</i>
            </span>
            <span class="pager-title-sm">Older</span>
            <span class="pager-title">
              아키텍처와 의존성
            </span>
          </a>
        </li>
        

        
        <li class="next">
          <a href="/learn-n-think/memo-in-early-2016/">
            <span class="pager-title">
              코드 비용에 대한 2016년의 메모
            </span>
            <span class="pager-title-sm">Newer</span>
            <span aria-hidden="true">
              <i class="material-icons">navigate_next</i>
            </span>
          </a>
        </li>
        
      </ul>
    </nav>

    <div class="comments" style="margin-bottom: 30px;">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//appkr.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

  </section>

  <aside id="sidebar" class="col-md-3">
    <section class="box" id="search">
  <div class="box-body">
    <form action="#">
      <div class="form-group">
        <input class="form-control input-lg" type="text" id="q" placeholder="Search...">
        <ul id="q-results"></ul>
      </div>
    </form>
  </div>
</section>

<section class="box" id="categories">
  <div class="box-header">
    <h3>Categories</h3>
  </div>

  <div class="box-body">
    <ul>
      <li>
        <a href="/categories#around-me">
          Around Me
          <span class="badge">25</span>
        </a>
      </li>
      <li>
        <a href="/categories#learn-n-think">
          Learn & Think
          <span class="badge">78</span>
        </a>
      </li>
      <li>
        <a href="/categories#work-n-play">
          Work & Play
          <span class="badge">57</span>
        </a>
      </li>
      <li>
        <a href="/categories#cheatsheet">
          Cheatsheet
          <span class="badge">1</span>
        </a>
      </li>
      <li>
        <a href="/categories#imported">
          Imported
          <span class="badge">3</span>
        </a>
      </li>
      <li>
        <a href="/categories#uncategorized">
          Uncategorized
          <span class="badge">2</span>
        </a>
      </li>
    </ul>
  </div>
</section>

<section class="box" id="tags">
  <div class="box-header">
    <h3>Tags</h3>
  </div>

  <div class="box-body tags">
    <div class="tags">
    
    
    <span style="font-size: 98%">
      <a href="/tags#3d">
        3d
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#API">
        API
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#Apache Thrift">
        Apache Thrift
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#CSS">
        CSS
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#CleanCode">
        CleanCode
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#DDD">
        DDD
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Database">
        Database
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Docker">
        Docker
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Dotfiles">
        Dotfiles
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Generator">
        Generator
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#Git">
        Git
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#JWT">
        JWT
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Javascript">
        Javascript
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#Jekyll">
        Jekyll
      </a>
    </span>
    
    <span style="font-size: 130%">
      <a href="/tags#Laravel">
        Laravel
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Lumen">
        Lumen
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#OOP">
        OOP
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#OS X">
        OS X
      </a>
    </span>
    
    <span style="font-size: 142%">
      <a href="/tags#PHP">
        PHP
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#RESTful">
        RESTful
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#RPC">
        RPC
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Refactoring">
        Refactoring
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Ruby">
        Ruby
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Swagger">
        Swagger
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#UML">
        UML
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#URL Rewriting">
        URL Rewriting
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Web">
        Web
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Websocket">
        Websocket
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#adobe">
        adobe
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#amazon">
        amazon
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#amd">
        amd
      </a>
    </span>
    
    <span style="font-size: 142%">
      <a href="/tags#android">
        android
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#apple">
        apple
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ar">
        ar
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#architecture">
        architecture
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#arm">
        arm
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bada">
        bada
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bluetooth">
        bluetooth
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bus">
        bus
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#cdp">
        cdp
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#chrome">
        chrome
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#cloud">
        cloud
      </a>
    </span>
    
    <span style="font-size: 114%">
      <a href="/tags#codec">
        codec
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#connectivity">
        connectivity
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#cpu">
        cpu
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ebook">
        ebook
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#emulator">
        emulator
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#flash">
        flash
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#framework">
        framework
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#gms">
        gms
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#google">
        google
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#gtd">
        gtd
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#intel">
        intel
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ios">
        ios
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#iphone">
        iphone
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#java">
        java
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#lbs">
        lbs
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#limo">
        limo
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#linux">
        linux
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#mcu">
        mcu
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#memory">
        memory
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#microsoft">
        microsoft
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#mobile">
        mobile
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#opencore">
        opencore
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#opengl">
        opengl
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#opengles">
        opengles
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#opensource">
        opensource
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#openvg">
        openvg
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#platform">
        platform
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#pnd">
        pnd
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#presentation">
        presentation
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#pvcore">
        pvcore
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#se">
        se
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#sns">
        sns
      </a>
    </span>
    
    <span style="font-size: 114%">
      <a href="/tags#soc">
        soc
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#symbian">
        symbian
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#tech">
        tech
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#ted">
        ted
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#tedx">
        tedx
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#windowsmobile">
        windowsmobile
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#wss">
        wss
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#x86">
        x86
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#史記">
        史記
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#孟子">
        孟子
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#孫子兵法">
        孫子兵法
      </a>
    </span>
    
    <span style="font-size: 282%">
      <a href="/tags#개발자">
        개발자
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#경력개발">
        경력개발
      </a>
    </span>
    
    <span style="font-size: 138%">
      <a href="/tags#기업철학">
        기업철학
      </a>
    </span>
    
    <span style="font-size: 174%">
      <a href="/tags#기획자">
        기획자
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#데이터베이스">
        데이터베이스
      </a>
    </span>
    
    <span style="font-size: 146%">
      <a href="/tags#리더쉽">
        리더쉽
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#생산성">
        생산성
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#소프트웨어공학">
        소프트웨어공학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#아키텍처">
        아키텍처
      </a>
    </span>
    
    <span style="font-size: 210%">
      <a href="/tags#인생철학">
        인생철학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#자녀교육">
        자녀교육
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#전략">
        전략
      </a>
    </span>
    
    <span style="font-size: 146%">
      <a href="/tags#조직관리">
        조직관리
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#조직문화">
        조직문화
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#조직행동">
        조직행동
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#철학">
        철학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#취미">
        취미
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#특기">
        특기
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#프로세스">
        프로세스
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#프로젝트관리">
        프로젝트관리
      </a>
    </span>
    
    </div>
  </div>
</section>

<section class="box" id="recent-posts">
  <div class="box-header">
    <h3>Recent Posts</h3>
  </div>

  <div class="box-body">
    <ul>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2017-12-24</small>
          <a href="/work-n-play/learn-n-think/serving-swagger-api-in-php-project/">PHP 프로젝트에 Swagger 적용 #1</a>
        </h4>
      </li>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2017-12-06</small>
          <a href="/work-n-play/clean-code-and-refactoring/">클린코드와 리팩토링</a>
        </h4>
      </li>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2017-10-22</small>
          <a href="/work-n-play/investigating-laravel-model-events/">라라벨 엘로퀀트 모델 이벤트 고찰</a>
        </h4>
      </li>
      
    </ul>
  </div>
</section>

<section class="box" id="recent-comments">
  <div class="box-header">
    <h3>Recent Comments</h3>
  </div>

  <div class="box-body dsq-widget">
    <script type="text/javascript" src="http://appkr.disqus.com/recent_comments_widget.js?num_items=5&hide_mods=0&hide_avatars=0&avatar_size=32&excerpt_length=100"></script>
  </div>
</section>

<section class="box" id="recent-feeds">
  <div class="box-header">
    <h3>Facebook Posts</h3>
  </div>

  <div class="box-body">
    <ul id="facebook-feed">
      <script id="facebook-feed-template" type="text/x-template">
        <li>
          <span class="facebook-message">
            { message }
          </span>
          ·
          <span class="facebook-meta">
            <a href="https://www.facebook.com/juwonkimatmedotcom/posts/{ id }">
              { created_time }
            </a>
          </span>
        </li>
      </script>
    </ul>
  </div>
</section>

  </aside>
</div>


  <footer id="site-footer">
  <h4>
    <a href="/">
      Appkr.memo(new Life)
    </a>
  </h4>
  <p>
    &copy; 2008~2017 •
    Built with <a href="http://jekyllrb.com/">Jekyll</a> •
    Hosted by <a href="https://pages.github.com/">Github</a> •
    <a href="/feed.xml">Rss</a>
  </p>
</footer>


  <div id="back-to-top">
    <a href="#" title="Scroll to Top">
      <i class="material-icons">keyboard_arrow_up</i>
    </a>
  </div>

  <script src="/scripts/main.min.js"></script>
</body>

</html>
