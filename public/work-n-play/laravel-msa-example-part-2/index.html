<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <meta name="description" content="지난 포스트에 이어 모노리틱 서비스 구조에서 마이크로 서비스 구조로 전환할 때 사용자 인증을 어떻게 통합할지에 대한 내용을 이어갑니다.UAA 연동: HttpMiddleware를 이용한 Password 그랜트전체 예제 코드는 https://github.com/appkr/laravel..."/>
  <meta name="google-site-verification" content="K08vxFtrUM8f7VcQr6MPRFuI7ub1QHanrPFjsKKPV2s" />
  <meta name="naver-site-verification" content="1154945df3baf6485909c67f4dbc47a19988736d"/>

  <meta name="msapplication-tap-highlight" content="no"/>

  <!-- Facebook Meta -->
  <meta property="og:title" content="라라벨 마이크로서비스 예제 2부"/>
  <meta property="og:type" content="Website"/>
  <meta property="og:author" content="appkr (juwonkim@me.com)"/>
  <meta property="og:image" content="/images/2021-02-15-uml2.png"/>

  <!-- Google+ Meta -->
  <meta itemprop="name" content="라라벨 마이크로서비스 예제 2부">
  <meta itemprop="description" content="지난 포스트에 이어 모노리틱 서비스 구조에서 마이크로 서비스 구조로 전환할 때 사용자 인증을 어떻게 통합할지에 대한 내용을 이어갑니다.UAA 연동: HttpMiddleware를 이용한 Password 그랜트전체 예제 코드는 https://github.com/appkr/laravel...">
  <meta itemprop="image" content="/images/2021-02-15-uml2.png">
  <meta itemprop="author" content="appkr (juwonkim@me.com)"/>

  <!-- Twitter Meta -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@appkrs" />
  <meta name="twitter:title" content="라라벨 마이크로서비스 예제 2부" />
  <meta name="twitter:description" content="지난 포스트에 이어 모노리틱 서비스 구조에서 마이크로 서비스 구조로 전환할 때 사용자 인증을 어떻게 통합할지에 대한 내용을 이어갑니다.UAA 연동: HttpMiddleware를 이용한 Password 그랜트전체 예제 코드는 https://github.com/appkr/laravel..." />
  <meta name="twitter:image" content="/images/2021-02-15-uml2.png" />
  <meta name="twitter:domain" content="blog.appkr.dev">

  <!-- Mobile and Rss -->
  <link rel="canonical" href="https://blog.appkr.dev/work-n-play/laravel-msa-example-part-2/"/>
  <link rel="alternate" type="application/rss+xml" title="Appkr.memo(new Story())" href="https://blog.appkr.dev/feed.xml"/>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/earlyaccess/nanumgothic.css"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons"/>

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.7/css/bootstrap-material-design.min.css"/>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.7/css/ripples.min.css"/>
  <link rel="stylesheet" href="/styles/main.css"/>

  <title>라라벨 마이크로서비스 예제 2부 | Appkr.memo(new Story())</title>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body id="app">

  <nav class="navbar navbar-static-top" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="sr-only">Navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        Appkr.memo(new Story())
      </a>
    </div>

    <div class="navbar-collapse collapse navbar-responsive-collapse">
      <ul class="nav navbar-nav navbar-right text-center">
        <li>
          <a href="/">Blog</a>
        </li>
        <li>
          <a href="/profile/">Profile</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
  <section id="main" class="col-md-9 minimal">
    <article class="box">
      <div class="box-header">
        <h2>
          <span class="title">라라벨 마이크로서비스 예제 2부</span>
          <span class="action dropdown pull-right">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-target="#">
              <i class="material-icons">share</i>
            </a>

            <ul class="dropdown-menu">
              <li>
                <a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.appkr.dev/work-n-play/laravel-msa-example-part-2/&title=라라벨 마이크로서비스 예제 2부" id="sns-facebook">
                  Facebook
                </a>
              </li>
              <li>
                <a href="http://twitter.com/share?url=https://blog.appkr.dev/work-n-play/laravel-msa-example-part-2/&title=라라벨 마이크로서비스 예제 2부&text=라라벨 마이크로서비스 예제 2부" id="sns-twitter">
                  Twitter
                </a>
              </li>
            </ul>
          </span>
        </h2>

        <p class="box-meta">
          <span>
            <i class="material-icons">today</i>
            2021-02-15
          </span>
          <span>
            <i class="material-icons">face</i>
            Posted by appkr
          </span>
          <span>
            <i class="material-icons">turned_in</i>
            
              <a href="/categories#work-n-play">
                
                    Work & Play
                  
              </a>
              
            
          </span>
          <span>
            <i class="material-icons">forum</i>
            <a href="/work-n-play/laravel-msa-example-part-2/#disqus_thread" title="comments">0</a>
          </span>
        </p>
      </div>

      <div class="box-body">
        <p><a href="https://blog.appkr.dev/work-n-play/laravel-msa-example/">지난 포스트</a>에 이어 모노리틱 서비스 구조에서 마이크로 서비스 구조로 전환할 때 사용자 인증을 어떻게 통합할지에 대한 내용을 이어갑니다.</p>

<p><img src="/images/2021-02-15-uml2.svg" alt="" /></p>
<div class="text-center"><small>UAA 연동: HttpMiddleware를 이용한 Password 그랜트</small></div>

<p>전체 예제 코드는 <a href="https://github.com/appkr/laravel-msa-example">https://github.com/appkr/laravel-msa-example</a>에 있습니다.</p>

<!--more-->
<div class="spacer">• • •</div>
<!--div class="text-center"><small>마이크로 서비스 콤포넌트</small></div-->

<h2 id="4-구현1">4 구현#1</h2>

<h3 id="4-1-프로젝트-셋업">4-1 프로젝트 셋업</h3>

<p>라라벨 프로젝트를 새로 만듭니다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>laravel new laravel-msa-example
<span class="nv">$ </span>php artisan <span class="nt">--version</span>
<span class="c"># Laravel Framework 8.21.0</span>
</code></pre></div></div>

<p>예제 소스 코드에는 PHP7.3, fpm, Nginx, MySQL 등의 런타임 환경을 docker-compose로 구동하도록 했습니다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree docker
<span class="c"># docker</span>
<span class="c"># ├── custom-php.ini      # xdebug, opcache 등 설정</span>
<span class="c"># ├── docker-compose.yml</span>
<span class="c"># ├── init.sql            # (최초 실행시 자동) 데이터베이스 생성</span>
<span class="c"># └── laravel.conf        # Nginx 설정</span>
</code></pre></div></div>

<p>최종 폴더 구조는 이렇습니다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── app                                 <span class="c"># 라라벨 제공 폴더</span>
├── hello-service                       <span class="c"># HelloAPI (Spring, non-laravel)</span>
├── src
│ ├── Infra                             <span class="c"># 인프라 레이어</span>
│ │ ├── ExternalApi
│ │ │ └── HelloApiClient.php            <span class="c"># HelloAPI</span>
│ │ ├── JhipsterUaa                     <span class="c"># UAA 연동 코드</span>
│ │ │ ├── CacheableTokenKeyProvider.php
│ │ │ ├── CacheableTokenProvider.php
│ │ │ ├── TokenKey.php
│ │ │ ├── TokenKeyResponse.php
│ │ │ ├── TokenResponse.php
│ │ │ ├── UaaTokenKeyProvider.php
│ │ │ └── UaaTokenProvider.php
│ │ ├── Token.php                       <span class="c"># 토큰 모델</span>
│ │ ├── TokenException.php
│ │ ├── TokenExtractor.php              <span class="c"># Authorization 요청 헤더에서 토큰 추출하는 유틸 </span>
│ │ ├── TokenKeyProvider.php            <span class="c"># 공개 키를 조회하기 위한 인터페이스</span>
│ │ ├── TokenParser.php                 <span class="c"># 토큰 유효성 검증기</span>
│ │ └── TokenProvider.php               <span class="c"># (OAuth2 서버로부터) 토큰을 얻기 위한 인터페이스</span>
│ ├── Model
│ │ └── Example.php                     <span class="c"># Example 도메인</span>
│ └── Service
│     ├── Dto
│     │ ├── ExampleDto.php
│     │ ├── ExampleList.php
│     │ ├── ExampleSearchParam.php
│     │ └── Page.php
│     ├── ExampleService.php
│     └── Mapper
│         └── ExampleMapper.php
└── tests
  ├── Infra
  │ ├── JWTTest.php
  │ ├── TokenExtractorTest.php
  │ ├── TokenKeyProviderTest.php
  │ ├── TokenParserTest.php
  │ └── TokenProviderTest.php
  └── Unit
      └── ExampleTest.php
</code></pre></div></div>

<p>전체 클러스터를 구동하고 작동 여부를 검증합니다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-composer <span class="nt">-f</span> docker/docker-compose.yml up <span class="nt">-d</span>
<span class="nv">$ </span>open http://localhost:8000
</code></pre></div></div>

<p>UAA는 별도로 작동시키고 작동을 검증합니다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 최초 한번만 실행</span>
<span class="nv">$ </span>wget https://github.com/appkr/msa-starter/raw/master/jhipster-uaa.zip <span class="se">\</span>
  <span class="o">&amp;&amp;</span> unzip jhipster-uaa.zip 
  <span class="o">&amp;&amp;</span> <span class="nb">cd </span>jhipster-uaa
<span class="c"># UAA가 중지되면 구동할 때마다 실행 </span>
<span class="nv">$ </span>./gradlew clean bootRun
<span class="nv">$ </span>curl <span class="nt">-s</span> http://localhost:9999/management/health
<span class="c"># { "status" : "UP" }</span>
</code></pre></div></div>

<h3 id="4-2-exampleapi">4-2 ExampleAPI</h3>

<p>Example 리소스에 대해 등록, 목록 조회 두 개의 API만 구현했습니다; 스키마 마이그레이션, 시더, 모델, 폼 리퀘스트, 서비스 레이어 등 기타 코드는 생략합니다.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// routes/api.php</span>

<span class="nc">Route</span><span class="o">::</span><span class="nf">prefix</span><span class="p">(</span><span class="s1">'examples'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">group</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nc">Route</span><span class="o">::</span><span class="nf">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">[</span><span class="nc">ExampleController</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="s1">'createExample'</span><span class="p">]);</span>
    <span class="nc">Route</span><span class="o">::</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">[</span><span class="nc">ExampleController</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="s1">'listExamples'</span><span class="p">]);</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-php linenos highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Http/Controllers/ExampleController.php</span>

<span class="kn">namespace</span> <span class="nn">App\Http\Controllers</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Http\Requests\CreateExampleRequest</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Http\Requests\ListExampleRequest</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Appkr\Service\ExampleService</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Http\JsonResponse</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ExampleController</span> <span class="kd">extends</span> <span class="nc">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$service</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ExampleService</span> <span class="nv">$exampleService</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="nv">$exampleService</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">createExample</span><span class="p">(</span><span class="kt">CreateExampleRequest</span> <span class="nv">$request</span><span class="p">):</span> <span class="kt">JsonResponse</span>
    <span class="p">{</span>
        <span class="nv">$dto</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">service</span><span class="o">-&gt;</span><span class="nf">createExample</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">toDto</span><span class="p">());</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nc">JsonResponse</span><span class="p">(</span><span class="nv">$dto</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">listExamples</span><span class="p">(</span><span class="kt">ListExampleRequest</span> <span class="nv">$request</span><span class="p">):</span> <span class="kt">JsonResponse</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">JsonResponse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">service</span><span class="o">-&gt;</span><span class="nf">listExamples</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">toDto</span><span class="p">()));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>작동을 검증합니다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s1">'Accept:application/json'</span> http://localhost:8000/api/examples
</code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"이문세 5집"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-02-05T02:18:46.000000Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-02-05T02:18:46.000000Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"created_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"d593f9ef-d089-44fe-abe7-05c30219bb4c"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"updated_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"d593f9ef-d089-44fe-abe7-05c30219bb4c"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"page"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
    </span><span class="nl">"totalElements"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"totalPages"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"number"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="5-구현2-password-그랜트">5 구현#2 Password 그랜트</h2>

<h3 id="5-1-httpmiddleware">5-1 HttpMiddleware</h3>

<p>현재는 엔드포인트만 알고 있다면 아무나 ExampleAPI를 사용할 수 있는 상태입니다. Authorization HTTP 헤더에 UAA에서 받은 토큰을 제출했을 때만, Example 리소스를 사용할 수 있도록 HttpMiddleware를 구현하고 적용해 보겠습니다.</p>

<div class="language-php linenos highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Http/Middleware/TokenAuthenticate.php</span>

<span class="kn">namespace</span> <span class="nn">AppP\Http\Middleware</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Models\User</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Appkr\Infra\TokenException</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Appkr\Infra\TokenExtractor</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Appkr\Infra\TokenParser</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Closure</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Http\JsonResponse</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Http\Request</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ramsey\Uuid\Uuid</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TokenAuthenticate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$tokenParser</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">TokenParser</span> <span class="nv">$tokenParser</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tokenParser</span> <span class="o">=</span> <span class="nv">$tokenParser</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">handle</span><span class="p">(</span><span class="kt">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="kt">Closure</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$jwtString</span> <span class="o">=</span> <span class="nc">TokenExtractor</span><span class="o">::</span><span class="nb">extract</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$jwtString</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nc">TokenException</span><span class="o">::</span><span class="nf">tokenNotProvided</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tokenParser</span><span class="o">-&gt;</span><span class="nf">parse</span><span class="p">(</span><span class="nv">$jwtString</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">TokenException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">JsonResponse</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">(),],</span> 
                <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getStatusCode</span><span class="p">()</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="err">\</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">JsonResponse</span><span class="p">([</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'Unknown exception'</span><span class="p">,],</span> <span class="mi">400</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">setUserResolver</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">();</span>
            <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$token</span><span class="o">-&gt;</span><span class="nf">getUserName</span><span class="p">()</span> <span class="k">instanceof</span> <span class="nc">Uuid</span><span class="p">)</span> 
                <span class="o">?</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="nf">getUserName</span><span class="p">()</span> 
                <span class="o">:</span> <span class="nc">Uuid</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="nc">Uuid</span><span class="o">::</span><span class="no">NIL</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$user</span><span class="p">;</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">26</code> line: <code class="language-plaintext highlighter-rouge">TokenExtractor</code>는 <code class="language-plaintext highlighter-rouge">Request</code> 객체에서 JWT <code class="language-plaintext highlighter-rouge">access_token</code>을 추출하는 역할을 한다</li>
  <li><code class="language-plaintext highlighter-rouge">28</code> line: 클라이언트가 토큰을 제출하지 않았다면, 예외가 발생한다</li>
  <li><code class="language-plaintext highlighter-rouge">30</code> line: <code class="language-plaintext highlighter-rouge">TokenParser::parse</code> 메서드는 JWT 토큰을 받아서 파싱하고 <code class="language-plaintext highlighter-rouge">Token</code>모델을 반환하는 역할을 한다</li>
  <li><code class="language-plaintext highlighter-rouge">32</code> line: 이상의 과정에서 <code class="language-plaintext highlighter-rouge">TokenException</code>이 발생할 수 있으며, 이때는 사용자에게 4xx 응답코드와 예외 메시지를 응답한다</li>
  <li><code class="language-plaintext highlighter-rouge">40</code> line: 이상의 과정이 순조롭게 진행되었다면, UserResolver 클로저를 등록한다; <code class="language-plaintext highlighter-rouge">43</code>줄을 보면 파싱된 토큰에서 <code class="language-plaintext highlighter-rouge">userName:UUIDInterface</code>을 조회하고 응답하는 것을 볼 수 있다</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// routes/api.php</span>

<span class="nc">Route</span><span class="o">::</span><span class="nf">prefix</span><span class="p">(</span><span class="s1">'examples'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">middleware</span><span class="p">(</span><span class="nc">TokenAuthenticate</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">group</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 생략 ...</span>
<span class="p">});</span>
</code></pre></div></div>

<p>작동을 검증합니다. 필요한 클래스들이 아직 없어서, 예외가 발생할텐데요. 예외를 발생시키지 않도록 최소한의 클래스와 메서드만 선언하고 테스트한다면 아래와 같은 결과를 얻을 수 있습니다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-i</span> <span class="nt">-H</span> <span class="s1">'Accept:application/json'</span> http://localhost:8000/api/examples
</code></pre></div></div>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">400</span> <span class="ne">Bad Request</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="na">X-RateLimit-Limit</span><span class="p">:</span> <span class="s">60</span>
<span class="na">X-RateLimit-Remaining</span><span class="p">:</span> <span class="s">59</span>
<span class="na">Access-Control-Allow-Origin</span><span class="p">:</span> <span class="s">*</span>

<span class="p">{</span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"Token was not provided"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="5-2-tokenextractor">5-2 TokenExtractor</h3>

<p><code class="language-plaintext highlighter-rouge">Request</code> 객체에서 JWT <code class="language-plaintext highlighter-rouge">access_token</code>을 추출하는 책임을 <code class="language-plaintext highlighter-rouge">TokenExtractor</code>에게 부여했습니다.</p>

<div class="language-php linenos highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// src/Infra/TokenExtractor.php</span>

<span class="kn">namespace</span> <span class="nn">Appkr\Infra</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Illuminate\Http\Request</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TokenExtractor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">extract</span><span class="p">(</span><span class="kt">Request</span> <span class="nv">$request</span><span class="p">):</span> <span class="kt">?string</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">hasHeader</span><span class="p">(</span><span class="s1">'authorization'</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$authHeader</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nb">header</span><span class="p">(</span><span class="s1">'authorization'</span><span class="p">);</span>
        <span class="nv">$jwtString</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/bearer\s/i'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$authHeader</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$jwtString</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">16</code> line: <code class="language-plaintext highlighter-rouge">authorization</code> 요청 헤더를 구한후, <code class="language-plaintext highlighter-rouge">bearer </code> 스킴 문자열을 버리는 코드입니다</li>
</ul>

<h3 id="5-3-tokenparser">5-3 TokenParser</h3>

<p>1부 3절에서 <code class="language-plaintext highlighter-rouge">firebase/php-jwt</code> 패키지를 설치해습니다. <a href="https://github.com/firebase/php-jwt#example-with-rs256-openssl">공개키를 이용하여 JWT를 파싱하는 방법은 링크를 참고</a>합니다.</p>

<p><code class="language-plaintext highlighter-rouge">TokenParser</code>는 원본 JWT 토큰을 받아서 파싱하고 <code class="language-plaintext highlighter-rouge">Token</code>모델을 반환하는 책임을 부여했습니다. <a href="https://github.com/appkr/laravel-msa-example/blob/master/src/Infra/Token.php"><code class="language-plaintext highlighter-rouge">Token</code> 모델은 예제 코드를 참고</a>합니다</p>

<div class="language-php linenos highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// src/Infra/TokenExtractor.php</span>

<span class="kn">namespace</span> <span class="nn">Appkr\Infra</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Firebase\JWT\BeforeValidException</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Firebase\JWT\ExpiredException</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Firebase\JWT\SignatureInvalidException</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TokenParser</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$tokenKeyProvider</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">TokenKeyProvider</span> <span class="nv">$tokenKeyProvider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tokenKeyProvider</span> <span class="o">=</span> <span class="nv">$tokenKeyProvider</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">parse</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$jwtString</span><span class="p">):</span> <span class="kt">Token</span>
    <span class="p">{</span>
        <span class="nv">$token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Token</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$token</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">::</span><span class="nf">fromTokenString</span><span class="p">(</span>
                <span class="nv">$jwtString</span><span class="p">,</span> 
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tokenKeyProvider</span><span class="o">-&gt;</span><span class="nf">getKey</span><span class="p">()</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">SignatureInvalidException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">TokenException</span><span class="o">::</span><span class="nf">invalidSignature</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">BeforeValidException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">TokenException</span><span class="o">::</span><span class="nf">beforeValid</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">ExpiredException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">TokenException</span><span class="o">::</span><span class="nf">expired</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">UnexpectedValueException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">TokenException</span><span class="o">::</span><span class="nf">invalidToken</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$token</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">15</code> line: <code class="language-plaintext highlighter-rouge">TokenKeyProvider</code> 주입한다</li>
  <li><code class="language-plaintext highlighter-rouge">22</code> line: 토큰을 파싱 및 객체 생성 책임을 <code class="language-plaintext highlighter-rouge">Token</code> 클래스에 위임함; 원본 토큰 문자열과 <code class="language-plaintext highlighter-rouge">TokenKeyProvider</code>을 인자로 전달한다</li>
  <li><code class="language-plaintext highlighter-rouge">26-34</code> line: <code class="language-plaintext highlighter-rouge">firebase/php-jwt</code> 패키지의 <code class="language-plaintext highlighter-rouge">\Firebase\JWT\JWT::decode</code> 메서드에서 던진 예외를 <code class="language-plaintext highlighter-rouge">TokenException</code>으로 치환한다</li>
</ul>

<table>
  <thead>
    <tr>
      <th>예외</th>
      <th>설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SignatureInvalidException</code></td>
      <td>공개 키가 유효하지 않을 때</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">BeforeValidException</code></td>
      <td><code class="language-plaintext highlighter-rouge">iat</code>(Issued at) 값보다 현재 시각이 과거일 때</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ExpiredException</code></td>
      <td><code class="language-plaintext highlighter-rouge">iat</code>(Expiration time) 값보다 현재 시각이 미래일 때</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">UnexpectedValueException</code></td>
      <td>토큰이 변조되었거나 유효하지 않을 때</td>
    </tr>
  </tbody>
</table>

<p>현재까지의 구현을 클래스 다이어그램으로 살펴볼까요?</p>

<p><img src="/images/2021-02-15-uml1.svg" alt="" /></p>
<div class="text-center"><small>구현 중간 점검</small></div>

<h3 id="5-4-tokenkeyprovider">5-4 TokenKeyProvider</h3>

<p><code class="language-plaintext highlighter-rouge">TokenKeyProvider</code>는 UAA 서버로부터 공개 키를 받아오는 역할을 합니다. 간결함을 위해 인터페이스 구현, <code class="language-plaintext highlighter-rouge">config/oauth2.php</code> 설정 등의 내용은 생략합니다. <a href="https://github.com/appkr/laravel-msa-example/blob/master/src/Infra/JhipsterUaa/TokenKeyResponse.php"><code class="language-plaintext highlighter-rouge">TokenKeyResponse</code> 모델도 생략하니 예제 코드를 참고</a>바랍니다.</p>

<div class="language-php linenos highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Appkr\Infra\JhipsterUaa</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Appkr\Infra\TokenKeyProvider</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">GuzzleHttp\Client</span> <span class="k">as</span> <span class="nc">GuzzleClient</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">GuzzleHttp\Psr7\Request</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">GuzzleHttp\Psr7\Response</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Support\Arr</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Psr\Http\Client\ClientExceptionInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">UaaTokenKeyProvider</span> <span class="kd">implements</span> <span class="nc">TokenKeyProvider</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$httpClient</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">GuzzleClient</span> <span class="nv">$httpClient</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$config</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">httpClient</span> <span class="o">=</span> <span class="nv">$httpClient</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getKey</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getTokenKey</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getKey</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getTokenKey</span><span class="p">():</span> <span class="kt">TokenKeyResponse</span>
    <span class="p">{</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="nc">Arr</span><span class="o">::</span><span class="nf">get</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="s1">'token_key_path'</span><span class="p">));</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">httpClient</span><span class="o">-&gt;</span><span class="nf">sendRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">ClientExceptionInterface</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nc">TokenKeyResponse</span><span class="o">::</span><span class="nf">fromJsonString</span><span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getBody</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">30</code> line: == <code class="language-plaintext highlighter-rouge">new Request('GET', '/oauth/token_key'));</code></li>
  <li><code class="language-plaintext highlighter-rouge">33</code> line: UAA에 요청하고 받은 응답을 <code class="language-plaintext highlighter-rouge">$response</code> 변수에 담았다</li>
  <li><code class="language-plaintext highlighter-rouge">37</code> line: 응답을 파싱하는 책임을 <code class="language-plaintext highlighter-rouge">TokenKeyResponse</code>에 위임했다</li>
</ul>

<h3 id="5-5-oauth2serviceprovider">5-5 OAuth2ServiceProvider</h3>

<p>런타임에 TokenParser, TokenKeyProvider 등의 객체를 정상적으로 주입하기 위해서는 서비스 프로바이더에 객체 조립 공식을 등록해야 합니다.</p>

<div class="language-php linenos highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Providers/OAuth2ServiceProvider.php</span>

<span class="kn">namespace</span> <span class="nn">App\Providers</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Appkr\Infra\JhipsterUaa\UaaTokenKeyProvider</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Appkr\Infra\TokenKeyProvider</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Appkr\Infra\TokenParser</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">GuzzleHttp\Client</span> <span class="k">as</span> <span class="nc">GuzzleClient</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Contracts\Config\Repository</span> <span class="k">as</span> <span class="nc">ConfigRepository</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Contracts\Foundation\Application</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Support\Arr</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Support\ServiceProvider</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">OAuth2ServiceProvider</span> <span class="kd">extends</span> <span class="nc">ServiceProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">register</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">registerTokenKeyProvider</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">registerTokenParser</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">function</span> <span class="n">registerTokenKeyProvider</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">TokenKeyProvider</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Application</span> <span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="nf">make</span><span class="p">(</span><span class="nc">ConfigRepository</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'oauth2.jhipster'</span><span class="p">);</span>
            <span class="nv">$httpClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GuzzleClient</span><span class="p">([</span>
                <span class="s1">'base_uri'</span> <span class="o">=&gt;</span> <span class="nc">Arr</span><span class="o">::</span><span class="nf">get</span><span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="s1">'base_uri'</span><span class="p">),</span>
                <span class="s1">'timeout'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">]);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">UaaTokenKeyProvider</span><span class="p">(</span><span class="nv">$httpClient</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">registerTokenParser</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">TokenParser</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Application</span> <span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">TokenParser</span><span class="p">(</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="nf">make</span><span class="p">(</span><span class="nc">TokenKeyProvider</span><span class="o">::</span><span class="n">class</span><span class="p">));</span>
        <span class="p">});</span>
    <span class="p">}</span>   
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">30</code> line: <code class="language-plaintext highlighter-rouge">UaaTokenKeyProvider</code> 생성자가 요구하는 <code class="language-plaintext highlighter-rouge">GuzzleClient,</code> <code class="language-plaintext highlighter-rouge">$config: string[]</code>을 주입했다</li>
  <li><code class="language-plaintext highlighter-rouge">37</code> line: <code class="language-plaintext highlighter-rouge">TokenParser</code> 생성자가 요구하는 <code class="language-plaintext highlighter-rouge">TokenKeyProvider</code>를 주입했다</li>
</ul>

<p>뿐만아니라 <code class="language-plaintext highlighter-rouge">config/app.php</code>의 <code class="language-plaintext highlighter-rouge">providers</code> 배열에 방금 만든 서비스 프로바이더를 등록해줘야 합니다. 오랜만에 하는 라라벨 프로젝트라 이 부분을 놓치고 삽질을 했는데요, <a href="https://modernpug.slack.com/archives/C0MGYSQ0L/p1612766800053200">슬랙에서 여러 분들께서 같이 봐주셔서 해결</a>했습니다.</p>

<p>작동하는지 검증해볼까요? UAA를 포함한 전체 클러스터가 작동하고 있다고 가정합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ RESPONSE</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="nt">--data</span> <span class="s2">"username=user&amp;password=user&amp;grant_type=password&amp;scope=openid"</span> http://web_app:changeit@localhost:9999/oauth/token<span class="si">)</span>
<span class="nv">$ ACCESS_TOKEN</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$RESPONSE</span> | jq .access_token | xargs<span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-i</span> <span class="nt">-H</span> <span class="s1">'Accept:application/json'</span> <span class="nt">-H</span> <span class="s2">"Authorization: bearer </span><span class="k">${</span><span class="nv">ACCESS_TOKEN</span><span class="k">}</span><span class="s2">"</span> http://localhost:8000/api/examples
</code></pre></div></div>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="na">X-RateLimit-Limit</span><span class="p">:</span> <span class="s">60</span>
<span class="na">X-RateLimit-Remaining</span><span class="p">:</span> <span class="s">59</span>
<span class="na">Access-Control-Allow-Origin</span><span class="p">:</span> <span class="s">*</span>

<span class="p">{</span><span class="nl">"data"</span><span class="p">:[{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"</span><span class="se">\u</span><span class="s2">c774</span><span class="se">\u</span><span class="s2">bb38</span><span class="se">\u</span><span class="s2">c138 5</span><span class="se">\u</span><span class="s2">c9d1"</span><span class="p">,</span><span class="nl">"created_at"</span><span class="p">:</span><span class="s2">"2021-02-05T02:18:46.000000Z"</span><span class="p">,</span><span class="nl">"updated_at"</span><span class="p">:</span><span class="s2">"2021-02-05T02:18:46.000000Z"</span><span class="p">,</span><span class="nl">"created_by"</span><span class="p">:</span><span class="s2">"d593f9ef-d089-44fe-abe7-05c30219bb4c"</span><span class="p">,</span><span class="nl">"updated_by"</span><span class="p">:</span><span class="s2">"d593f9ef-d089-44fe-abe7-05c30219bb4c"</span><span class="p">},</span><span class="s2">"page"</span><span class="err">:</span><span class="p">{</span><span class="nl">"size"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="nl">"totalElements"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="nl">"totalPages"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"number"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="5-5-cacheabletokenkeyprovider">5-5 CacheableTokenKeyProvider</h3>

<p>현재까지 구현은 공개 키가 필요할 때마다 매번 UAA에 HTTP 요청을 해야 합니다. 한번 받은 공개 키는 24시간 동안 캐시에 저장하고 꺼내쓸 수 있도록 구현했습니다.</p>

<div class="language-php linenos highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// src/Infra/JhipsterUaa/CacheableTokenKeyProvider.php</span>

<span class="kn">namespace</span> <span class="nn">Appkr\Infra\JhipsterUaa</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Appkr\Infra\TokenKeyProvider</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Contracts\Cache\Repository</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">CacheableTokenKeyProvider</span> <span class="kd">implements</span> <span class="nc">TokenKeyProvider</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">CACHE_KEY</span> <span class="o">=</span> <span class="s1">'oauth2.token_key'</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">CACHE_TTL_SECONDS</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">;</span> <span class="c1">// 24시간</span>

    <span class="k">private</span> <span class="nv">$delegate</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$cacheRepository</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">TokenKeyProvider</span> <span class="nv">$delegate</span><span class="p">,</span> 
        <span class="kt">Repository</span> <span class="nv">$cacheRepository</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">delegate</span> <span class="o">=</span> <span class="nv">$delegate</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">cacheRepository</span> <span class="o">=</span> <span class="nv">$cacheRepository</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getKey</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getTokenKey</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getKey</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getTokenKey</span><span class="p">():</span> <span class="kt">TokenKeyResponse</span>
    <span class="p">{</span>
        <span class="nv">$self</span> <span class="o">=</span> <span class="nv">$this</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">cacheRepository</span><span class="o">-&gt;</span><span class="nf">remember</span><span class="p">(</span>
            <span class="k">self</span><span class="o">::</span><span class="no">CACHE_KEY</span><span class="p">,</span> 
            <span class="k">self</span><span class="o">::</span><span class="no">CACHE_TTL_SECONDS</span><span class="p">,</span> 
            <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$self</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">delegate</span><span class="o">-&gt;</span><span class="nf">getTokenKey</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">32</code> line: <code class="language-plaintext highlighter-rouge">$delegate: UaaTokenKeyProvider</code>로부터 받은 응답을 24시간 동안 <code class="language-plaintext highlighter-rouge">oauth2.token_key</code>라고 캐시 키의 값으로 저장한다</li>
  <li><code class="language-plaintext highlighter-rouge">36</code> line: <code class="language-plaintext highlighter-rouge">$delegate: UaaTokenKeyProvider</code>에게 위임한다; 데코레이터 패턴을 적용함</li>
</ul>

<p>데코레이터가 정상 작동할 수 있도록 서비스 프로바이더에 객체 조립 공식을 변경 등록해야 합니다.</p>

<div class="language-php linenos highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/Providers/OAuth2ServiceProvider.php</span>

<span class="kn">use</span> <span class="nc">Appkr\Infra\JhipsterUaa\CacheableTokenKeyProvider</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Contracts\Cache\Repository</span> <span class="k">as</span> <span class="nc">CacheRepository</span><span class="p">;</span>
<span class="c1">// 생략 ...</span>

<span class="kd">class</span> <span class="nc">OAuth2ServiceProvider</span> <span class="kd">extends</span> <span class="nc">ServiceProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">register</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 생략 ...</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">function</span> <span class="n">registerTokenKeyProvider</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">TokenKeyProvider</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Application</span> <span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="nf">make</span><span class="p">(</span><span class="nc">ConfigRepository</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'oauth2.jhipster'</span><span class="p">);</span>
            <span class="nv">$httpClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GuzzleClient</span><span class="p">([</span>
                <span class="s1">'base_uri'</span> <span class="o">=&gt;</span> <span class="nc">Arr</span><span class="o">::</span><span class="nf">get</span><span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="s1">'base_uri'</span><span class="p">),</span>
                <span class="s1">'timeout'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">]);</span>
            <span class="nv">$innerProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UaaTokenKeyProvider</span><span class="p">(</span><span class="nv">$httpClient</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
            <span class="nv">$cacheRepository</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="nf">make</span><span class="p">(</span><span class="nc">CacheRepository</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nc">CacheableTokenKeyProvider</span><span class="p">(</span><span class="nv">$innerProvider</span><span class="p">,</span> <span class="nv">$cacheRepository</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">25</code> line: <code class="language-plaintext highlighter-rouge">CacheableTokenKeyProvider</code> 생성자가 필요로하는 <code class="language-plaintext highlighter-rouge">TokenKeyProvider</code> 타입으로 기존에 사용하던 <code class="language-plaintext highlighter-rouge">UaaTokenKeyProvider</code>를 주입하고, 캐시 저장소를 사용할 수 있도록 <code class="language-plaintext highlighter-rouge">CacheRepository</code>를 주입했다</li>
</ul>

<p>Password 그랜트가 완성됐습니다. 클래스 다이어그램을 살펴볼까요?</p>

<p><img src="/images/2021-02-15-uml2.svg" alt="" /></p>
<div class="text-center"><small>UAA 연동: HttpMiddleware를 이용한 Password 그랜트</small></div>

<h2 id="6-구현3-clientcredentials-그랜트">6 구현#3 ClientCredentials 그랜트</h2>

<h3 id="6-1-tokenprovider-구현">6-1 TokenProvider 구현</h3>
<p>TBD</p>

<h2 id="7-요약">7 요약</h2>

<p>3부에서 이어집니다</p>

      </div>

      <footer class="box-tags">
        <span><i class="material-icons">label</i> Tags:</span>
        
          <a href="/tags#PHP">
            PHP
          </a>
          , 
        
          <a href="/tags#Laravel">
            Laravel
          </a>
          , 
        
          <a href="/tags#MSA">
            MSA
          </a>
          , 
        
          <a href="/tags#Oauth2">
            Oauth2
          </a>
          
        
      </footer>
    </article>

    <nav id="pagination">
      <ul class="pager">
        
        <li class="previous">
          <a href="/work-n-play/laravel-msa-example/">
            <span aria-hidden="true">
              <i class="material-icons">navigate_before</i>
            </span>
            <span class="pager-title-sm">Older</span>
            <span class="pager-title">
              라라벨 마이크로서비스 예제
            </span>
          </a>
        </li>
        

        
        <li class="next disabled">
          <a href="#">
            <span>Newer</span>
            <span aria-hidden="true">
              <i class="material-icons">navigate_next</i>
            </span>
          </a>
        </li>
        
      </ul>
    </nav>

    <div class="comments" style="margin-bottom: 30px;">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//appkr.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

  </section>

  <aside id="sidebar" class="col-md-3">
    <section id="search_sidebar" class="box hidden-xs">
  <div class="box-body">
    <form action="#">
      <div class="form-group">
        <input class="form-control input-lg" type="text" id="q_sidebar" placeholder="Search...">
        <ul id="q_sidebar_res"></ul>
      </div>
    </form>
  </div>
</section>

<section class="box" id="categories">
  <div class="box-header">
    <h3>Categories</h3>
  </div>

  <div class="box-body">
    <ul>
      <li>
        <a href="/categories#around-me">
          Around Me
          <span class="badge">25</span>
        </a>
      </li>
      <li>
        <a href="/categories#learn-n-think">
          Learn & Think
          <span class="badge">84</span>
        </a>
      </li>
      <li>
        <a href="/categories#work-n-play">
          Work & Play
          <span class="badge">68</span>
        </a>
      </li>
      <li>
        <a href="/categories#cheatsheet">
          Cheatsheet
          <span class="badge">4</span>
        </a>
      </li>
      <li>
        <a href="/categories#imported">
          Imported
          <span class="badge">3</span>
        </a>
      </li>
      <li>
        <a href="/categories#uncategorized">
          Uncategorized
          <span class="badge">2</span>
        </a>
      </li>
    </ul>
  </div>
</section>

<section class="box" id="tags">
  <div class="box-header">
    <h3>Tags</h3>
  </div>

  <div class="box-body tags">
    <div class="tags">
    
    
    <span style="font-size: 98%">
      <a href="/tags#3d">
        3d
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#API">
        API
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#AWS">
        AWS
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#Apache Thrift">
        Apache Thrift
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#CSS">
        CSS
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#CleanCode">
        CleanCode
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#DDD">
        DDD
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#Database">
        Database
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#DevOps">
        DevOps
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Docker">
        Docker
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Dotfiles">
        Dotfiles
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ELK">
        ELK
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Generator">
        Generator
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#Git">
        Git
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#JWT">
        JWT
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Javascript">
        Javascript
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#Jekyll">
        Jekyll
      </a>
    </span>
    
    <span style="font-size: 150%">
      <a href="/tags#Laravel">
        Laravel
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Linux">
        Linux
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Log">
        Log
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Lumen">
        Lumen
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#MSA">
        MSA
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#OOP">
        OOP
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#OS X">
        OS X
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Oauth2">
        Oauth2
      </a>
    </span>
    
    <span style="font-size: 154%">
      <a href="/tags#PHP">
        PHP
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Programming">
        Programming
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#RESTful">
        RESTful
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#RPC">
        RPC
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Refactoring">
        Refactoring
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Ruby">
        Ruby
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Security">
        Security
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Swagger">
        Swagger
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#UML">
        UML
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#URL Rewriting">
        URL Rewriting
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Web">
        Web
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Websocket">
        Websocket
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#adobe">
        adobe
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#amazon">
        amazon
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#amd">
        amd
      </a>
    </span>
    
    <span style="font-size: 142%">
      <a href="/tags#android">
        android
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#apple">
        apple
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ar">
        ar
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#architecture">
        architecture
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#arm">
        arm
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bada">
        bada
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bluetooth">
        bluetooth
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bus">
        bus
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#cdp">
        cdp
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#chrome">
        chrome
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#cloud">
        cloud
      </a>
    </span>
    
    <span style="font-size: 114%">
      <a href="/tags#codec">
        codec
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#connectivity">
        connectivity
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#cpu">
        cpu
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ebook">
        ebook
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#emulator">
        emulator
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#flash">
        flash
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#framework">
        framework
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#gms">
        gms
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#google">
        google
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#gtd">
        gtd
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#intel">
        intel
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ios">
        ios
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#iphone">
        iphone
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#java">
        java
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#lbs">
        lbs
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#limo">
        limo
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#linux">
        linux
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#mcu">
        mcu
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#memory">
        memory
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#microsoft">
        microsoft
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#mobile">
        mobile
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#opencore">
        opencore
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#opengl">
        opengl
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#opengles">
        opengles
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#opensource">
        opensource
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#openvg">
        openvg
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#platform">
        platform
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#pnd">
        pnd
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#presentation">
        presentation
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#pvcore">
        pvcore
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#se">
        se
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#sns">
        sns
      </a>
    </span>
    
    <span style="font-size: 114%">
      <a href="/tags#soc">
        soc
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#symbian">
        symbian
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#tech">
        tech
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#ted">
        ted
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#tedx">
        tedx
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#windowsmobile">
        windowsmobile
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#wss">
        wss
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#x86">
        x86
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#史記">
        史記
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#孟子">
        孟子
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#孫子兵法">
        孫子兵法
      </a>
    </span>
    
    <span style="font-size: 298%">
      <a href="/tags#개발자">
        개발자
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#경력개발">
        경력개발
      </a>
    </span>
    
    <span style="font-size: 142%">
      <a href="/tags#기업철학">
        기업철학
      </a>
    </span>
    
    <span style="font-size: 174%">
      <a href="/tags#기획자">
        기획자
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#데이터베이스">
        데이터베이스
      </a>
    </span>
    
    <span style="font-size: 146%">
      <a href="/tags#리더쉽">
        리더쉽
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#생산성">
        생산성
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#소프트웨어공학">
        소프트웨어공학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#수학">
        수학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#아키텍처">
        아키텍처
      </a>
    </span>
    
    <span style="font-size: 218%">
      <a href="/tags#인생철학">
        인생철학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#자녀교육">
        자녀교육
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#전략">
        전략
      </a>
    </span>
    
    <span style="font-size: 150%">
      <a href="/tags#조직관리">
        조직관리
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#조직문화">
        조직문화
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#조직행동">
        조직행동
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#철학">
        철학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#취미">
        취미
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#특기">
        특기
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#프로세스">
        프로세스
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#프로젝트관리">
        프로젝트관리
      </a>
    </span>
    
    </div>
  </div>
</section>

<section class="box" id="recent-posts">
  <div class="box-header">
    <h3>Recent Posts</h3>
  </div>

  <div class="box-body">
    <ul>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2021-02-15</small>
          <a href="/work-n-play/laravel-msa-example-part-2/">라라벨 마이크로서비스 예제 2부</a>
        </h4>
      </li>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2021-02-13</small>
          <a href="/work-n-play/laravel-msa-example/">라라벨 마이크로서비스 예제</a>
        </h4>
      </li>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2021-02-03</small>
          <a href="/learn-n-think/the-travelers-gift/">REVISIT 폰더씨의 위대한 하루</a>
        </h4>
      </li>
      
    </ul>
  </div>
</section>

<section class="box" id="recent-comments">
  <div class="box-header">
    <h3>Recent Comments</h3>
  </div>

  <div class="box-body dsq-widget">
    <script type="text/javascript" src="//appkr.disqus.com/recent_comments_widget.js?num_items=3&hide_mods=0&hide_avatars=0&avatar_size=32&excerpt_length=100"></script>
  </div>
</section>

<section class="box" id="recent-feeds">
  <div class="box-header">
    <h3>Facebook Posts</h3>
  </div>

  <div class="box-body">
    <ul id="facebook-feed">
      <script id="facebook-feed-template" type="text/x-template">
        <li>
          <span class="facebook-message">
            { message }
          </span>
          ·
          <span class="facebook-meta">
            <a href="https://www.facebook.com/juwonkimatmedotcom/posts/{ id }">
              { created_time }
            </a>
          </span>
        </li>
      </script>
    </ul>
  </div>
</section>

<section class="box" id="youtube-lists">
  <div class="box-header">
    <h3>Youtube Videos</h3>
  </div>

  <div class="box-body">
    <ul id="youtube-list">
      <script id="youtube-list-template" type="text/x-template">
        <li>
          <span class="facebook-message">
            { message }
          </span>
          ·
          <span class="facebook-meta">
            <a href="https://www.youtube.com/watch?v={ id }">
              { created_time }
            </a>
          </span>
        </li>
      </script>
    </ul>
  </div>
</section>

<section class="box" id="gist-lists">
  <div class="box-header">
    <h3>Github Gist</h3>
  </div>

  <div class="box-body">
    <ul id="gist-list">
      <script id="gist-list-template" type="text/x-template">
        <li>
          <span class="facebook-message">
            { message }
          </span>
          ·
          <span class="facebook-meta">
            <a href="https://gist.github.com/{ id }">
              { created_time }
            </a>
          </span>
        </li>
      </script>
    </ul>
  </div>
</section>

<section class="box" id="activity-lists">
  <div class="box-header">
    <h3>Github Activity</h3>
  </div>

  <div class="box-body">
    <ul id="activity-list">
      <script id="activity-list-template" type="text/x-template">
        <li>
          <span class="facebook-message">
            <small>{ type }</small>: { message }
          </span>
          ·
          <span class="facebook-meta">
            <a href="https://github.com/{ repoName }/commits">
              { created_time }
            </a>
          </span>
        </li>
      </script>
    </ul>
  </div>
</section>

  </aside>
</div>


  <footer id="site-footer">
  <h4>
    <a href="/">
      Appkr.memo(new Story())
    </a>
  </h4>
  <p>
    &copy; 2008~2021 •
    Built with <a href="http://jekyllrb.com/">Jekyll</a> •
    Hosted by <a href="https://pages.github.com/">Github</a> •
    <a href="/feed.xml">Rss</a>
  </p>
</footer>


  <div id="back-to-top">
    <a href="#" title="Scroll to Top">
      <i class="material-icons">keyboard_arrow_up</i>
    </a>
  </div>

  <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/1.1.1/jekyll-search.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.7/js/material.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.7/js/ripples.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/4.0.1/ekko-lightbox.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
  <script src="/scripts/fat.js"></script>
  <script src="/scripts/main.js"></script>
</body>

</html>
