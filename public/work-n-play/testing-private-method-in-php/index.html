<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <meta name="description" content="최근에 회사 일로 검색 서비스를 개발했다. 검색 엔진으로는 Elastic Search를 사용했고, 매일 최한시(off-peak time)에 한 번씩 운영 데이터베이스에서 검색, 필터링, 정렬, Aggregation 등에 필요한 컬럼만 골라 인덱싱하도록 설계했다. 그리고, 재고 수량..."/>
  <meta name="google-site-verification" content="ToXKBimREnz49pDNot4b-N9ZJgYcKXPPsHsjhg4Zzuc" />
  <meta name="naver-site-verification" content="7cebcc8e5493169f5401870d9ce57f48d18491cd"/>

  <meta name="msapplication-tap-highlight" content="no"/>

  <!-- Facebook Meta -->
  <meta property="og:title" content="Private(or Protected) 메서드 테스트 하기 "/>
  <meta property="og:type" content="Website"/>
  <meta property="og:author" content="appkr (juwonkim@me.com)"/>
  <meta property="og:image" content="http://blog.appkr.kr/images/2016-12-04-img-01.png"/>

  <!-- Google+ Meta -->
  <meta itemprop="name" content="Private(or Protected) 메서드 테스트 하기 ">
  <meta itemprop="description" content="최근에 회사 일로 검색 서비스를 개발했다. 검색 엔진으로는 Elastic Search를 사용했고, 매일 최한시(off-peak time)에 한 번씩 운영 데이터베이스에서 검색, 필터링, 정렬, Aggregation 등에 필요한 컬럼만 골라 인덱싱하도록 설계했다. 그리고, 재고 수량...">
  <meta itemprop="image" content="http://blog.appkr.kr/images/2016-12-04-img-01.png">
  <meta itemprop="author" content="appkr (juwonkim@me.com)"/>

  <!-- Twitter Meta -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@appkrs" />
  <meta name="twitter:title" content="Private(or Protected) 메서드 테스트 하기 " />
  <meta name="twitter:description" content="최근에 회사 일로 검색 서비스를 개발했다. 검색 엔진으로는 Elastic Search를 사용했고, 매일 최한시(off-peak time)에 한 번씩 운영 데이터베이스에서 검색, 필터링, 정렬, Aggregation 등에 필요한 컬럼만 골라 인덱싱하도록 설계했다. 그리고, 재고 수량..." />
  <meta name="twitter:image" content="http://blog.appkr.kr/images/2016-12-04-img-01.png" />
  <meta name="twitter:domain" content="blog.appkr.kr">

  <!-- Mobile and Rss -->
  <link rel="canonical" href="http://blog.appkr.kr/work-n-play/testing-private-method-in-php/"/>
  <link rel="alternate" type="application/rss+xml" title="Appkr.memo(new Life)" href="http://blog.appkr.kr/feed.xml"/>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/earlyaccess/nanumgothic.css"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons"/>
  <link rel="stylesheet" href="/styles/main.min.css"/>

  <title>Private(or Protected) 메서드 테스트 하기  | Appkr.memo(new Life)</title>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body id="app">

  <nav class="navbar navbar-static-top" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="sr-only">Navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        Appkr.memo(new Life)
      </a>
    </div>

    <div class="navbar-collapse collapse navbar-responsive-collapse">
      <ul class="nav navbar-nav navbar-right text-center">
        <li class="active"><a href="/">Blog</a></li>
        <!--<li><a href="/guest-book/">Guest Book</a></li>-->
        <li><a href="/profile/">Profile</a></li>
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
  <section id="main" class="col-md-9 minimal">
    <article class="box">
      <div class="box-header">
        <h2>
          <span class="title">Private(or Protected) 메서드 테스트 하기 </span>
          <span class="action dropdown pull-right">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-target="#">
              <i class="material-icons">share</i>
            </a>

            <ul class="dropdown-menu">
              <li>
                <a href="https://www.facebook.com/sharer/sharer.php?u=http://blog.appkr.kr/work-n-play/testing-private-method-in-php/&title=Private(or Protected) 메서드 테스트 하기 " id="sns-facebook">
                  Facebook
                </a>
              </li>
              <li>
                <a href="http://twitter.com/share?url=http://blog.appkr.kr/work-n-play/testing-private-method-in-php/&title=Private(or Protected) 메서드 테스트 하기 &text=Private(or Protected) 메서드 테스트 하기 " id="sns-twitter">
                  Twitter
                </a>
              </li>
              <li>
                <a href="https://plus.google.com/share?url=http://blog.appkr.kr/work-n-play/testing-private-method-in-php/" id="sns-google">
                  Google+
                </a>
              </li>
            </ul>
          </span>
        </h2>

        <p class="box-meta">
          <span>
            <i class="material-icons">today</i>
            2016-12-04
          </span>
          <span>
            <i class="material-icons">face</i>
            Posted by appkr
          </span>
          <span>
            <i class="material-icons">turned_in</i>
            
              <a href="/categories#work-n-play">
                
                    Work & Play
                  
              </a>
              
            
          </span>
          <span>
            <i class="material-icons">forum</i>
            <a href="/work-n-play/testing-private-method-in-php/#disqus_thread" title="comments">0</a>
          </span>
        </p>
      </div>

      <div class="box-body">
        <p>최근에 회사 일로 검색 서비스를 개발했다. 검색 엔진으로는 Elastic Search를 사용했고, 매일 최한시(off-peak time)에 한 번씩 운영 데이터베이스에서 검색, 필터링, 정렬, Aggregation 등에 필요한 컬럼만 골라 인덱싱하도록 설계했다. 그리고, 재고 수량과 같이 실시간 업데이트가 필요한 값 들은 다른 서비스에서 SNS 메시지 또는 메시지 큐를 이용해서 전달하고, 전달 받은 값을 인덱싱에 반영하도록 구현했다.</p>

<p>Elastic Search는 사용법이 복잡하긴 하지만, 인덱싱된 필드 값에 따라 내림차순, 오름차순으로 미리 정렬된 결과를 받을 수 있다. 그런데, 아무리 실시간 업데이트를 한다고 해도, 인덱싱된 값만으로 정렬이 불가능한 경우가 있고, 이 경우에는 검색 결과를 받아서 후 처리로 배열을 순회하면서 다시 정렬을 해야 한다. 같은 클래스의 Public 메서드가 정렬 요청을 하므로, 당연히 Protected 메서드로 구현했다.</p>

<p>일반적으로 알려진 <strong>테스트 모범 사례</strong>는 다음과 같다.</p>

<ul>
  <li><strong>내가 짠 코드만 테스트한다.</strong> 외부에서 가져온 라이브러리를 테스트할 이유는 없다.</li>
  <li><strong>Public 메서드만 테스트한다.</strong> Private나 Protected 메서드는 Public 메서드가 작동하는데 도움을 주는 메서드들이므로, Public 메서드를 테스트함으로써 자동으로 테스트된다.</li>
</ul>

<p>후처리 정렬의 정상 작동을 확인해야 할 필요성이 생긴 것이다. 물론 구현한 Protected 메서드의 가시성을 Public으로 변경하면 쉽다. 그런데, 다른 클래스에서 호출하지도 않을 메서드를 Public으로 선언하는 것은 기분이 찜찜하다. 이 포스트에서는 <strong>Private나 Protected로 선언된 메서드를 유닛 테스트하는 방법을 설명</strong>한다. 결론부터 말하면, <strong>PHP의 <code class="highlighter-rouge">Reflection</code> API를 이용</strong>하는 것이다.</p>

<!--more-->
<div class="spacer">• • •</div>

<h2 id="1-테스트-타겟">1. 테스트 타겟</h2>

<p>테스트의 대상은 아래 클래스의 <code class="highlighter-rouge">sortByStoreStatusAndCanBuyNow()</code> 메서드다. 여러 단계를 거치긴 하지만, Public으로 선언한 <code class="highlighter-rouge">query()</code> 메서드의 의해서 호출된다. 인라인으로 간략한 설명을 달아 두었다.</p>

<p>참고로 <strong>네임스페이스에 나온 <a href="http://bootake.com"><code class="highlighter-rouge">Bootake</code>는 내가 속한 회사에서 하는 서비스</a> 중 하나</strong>다. 이번에 구현한 코드는 아직 서비스에 반영되진 않았다.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// core/Infrastructure/Queries/CvsProduct.php
</span>
<span class="k">namespace</span> <span class="nx">Search\Infrastructure\Queries</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Bootake\SearchService\Thrift\Search\Product</span> <span class="k">as</span> <span class="nx">ThriftProduct</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Bootake\SearchService\Thrift\Search\SearchFilter</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Bootake\SearchService\Thrift\Search\Section</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Bootake\SearchService\Thrift\Search\SectionType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Collection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Search\Application\OutMappers\ProductMapper</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Search\Domain\Product</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CvsProduct</span> <span class="k">extends</span> <span class="nx">BaseQuery</span> <span class="k">implements</span> <span class="nx">Queryable</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">model</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 엘로퀀트 모델 인스턴스다. 모델에 선언한 몇 가지 속성에 접근하기 위해서 필요하다.
</span>        <span class="c1">// BaseQuery라는 추상 부모 클래스에서 abstract function으로 이 메서드의 구현을 강제하고 있다.
</span>        <span class="k">return</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">query</span><span class="p">(</span><span class="nx">SearchFilter</span> <span class="nv">$sf</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$regionId</span><span class="p">,</span> <span class="nv">$offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Elastic Search로 부터 받은 검색 결과를 $rawResults에 담았다.
</span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawResults</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">search</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">buildParam</span><span class="p">(</span><span class="nv">$sf</span><span class="p">,</span> <span class="nv">$regionId</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="c1">// 검색 결과는 여러 상점에서 제폼을 검색하므로 동일 제품이 검색 결과에 나타난다.
</span>        <span class="c1">// Elastic Search는 이미 Aggregation(GROUP BY)된 결과를 반환하는 것이 아니라,
</span>        <span class="c1">// 특정 필드 값에 따라 Aggregation했을 때의 ID값을 결과에 포함하여 반환한다.
</span>        <span class="c1">// 해서 실제 필요한 개수보다 더 많은 레코드를 요청하고, 필요한 레코드만 골라낸 후 페이징을 해야 한다.
</span>        <span class="c1">// 부모 클래스의 fetch() 메서드가 이 역할을 담당한다.
</span>        <span class="nv">$filtered</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">model</span><span class="o">-&gt;</span><span class="na">distinctAttribute</span><span class="p">(),</span> <span class="nv">$offset</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">buildSection</span><span class="p">(</span><span class="nv">$filtered</span><span class="p">,</span> <span class="nv">$sf</span><span class="p">,</span> <span class="nv">$regionId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">buildParam</span><span class="p">(</span><span class="nx">SearchFilter</span> <span class="nv">$sf</span><span class="p">,</span> <span class="nv">$regionId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Elastic Search에 전달할 검색 파라미터다.
</span>        <span class="k">return</span> <span class="p">[</span>
            <span class="c1">// ...
</span>        <span class="p">];</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">buildSection</span><span class="p">(</span><span class="nx">Collection</span> <span class="nv">$payload</span><span class="p">,</span> <span class="nx">SearchFilter</span> <span class="nv">$sf</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$regionId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// HTTP 응답으로 반환할 필드만 골라서 맵핑한다.
</span>        <span class="c1">// 이 과정에서 런타임에 계산해야 할 값들을 추가하거나, 데이터를 가공하거나 캐스팅하기도 한다.
</span>        <span class="nv">$mapped</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">ProductMapper</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">mapCollection</span><span class="p">(</span><span class="nv">$payload</span><span class="p">,</span> <span class="nv">$sf</span><span class="p">,</span> <span class="nv">$regionId</span><span class="p">);</span>
        
        <span class="c1">// 정렬한다. 이 포스트의 대상이 되는 문제의 메서드가 여기서 호출된다.
</span>        <span class="c1">// 정렬한 결과를 미리 정의한 ThriftProduct Type에 맞도록 맵핑했다. 
</span>        <span class="nv">$sorted</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sortByStoreStatusAndCanBuyNow</span><span class="p">(</span><span class="nv">$mapped</span><span class="p">)</span>
                       <span class="o">-&gt;</span><span class="na">map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="k">array</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
                           <span class="k">return</span> <span class="k">new</span> <span class="nx">ThriftProduct</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
                       <span class="p">})</span>
                       <span class="o">-&gt;</span><span class="na">values</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

        <span class="c1">// $sorted 배열은 [ThriftProduct, ThriftProduct, ...] 형식인데,
</span>        <span class="c1">// 얘를 다시 Thrift 인터페이스에서 정의한 Section Type으로 랩핑한다.
</span>        <span class="c1">// getTotal()등의 메서드는 부모 클래스에 있다.
</span>        <span class="k">return</span> <span class="k">new</span> <span class="nx">Section</span><span class="p">([</span>
            <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">SectionType</span><span class="o">::</span><span class="na">PRODUCT</span><span class="p">,</span>
            <span class="s1">'matchedCount'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTotal</span><span class="p">(),</span>
            <span class="s1">'perPage'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">perPage</span><span class="p">(),</span>
            <span class="s1">'currentPage'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resolveCurrentPage</span><span class="p">(),</span>
            <span class="s1">'stores'</span> <span class="o">=&gt;</span> <span class="p">[],</span>
            <span class="s1">'products'</span> <span class="o">=&gt;</span> <span class="nv">$sorted</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">sortByStoreStatusAndCanBuyNow</span><span class="p">(</span><span class="nx">Collection</span> <span class="nv">$unsorted</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$unsorted</span><span class="o">-&gt;</span><span class="na">sortBy</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 'canBuyNow' 속성은 불리언이라 정렬을 위해 정수 값으로 바꾸어, $canBuyNow 변수에 할당했다.
</span>            <span class="c1">// 'canBuyNow'는 지금 장바구니에 담긴 상품과 같은 상점의 제품이란 의미다.
</span>            <span class="nv">$canBuyNow</span> <span class="o">=</span> <span class="nv">$product</span><span class="p">[</span><span class="s1">'canBuyNow'</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>

            <span class="c1">// 제품이 속한 상점의 상태(영업 중 -&gt; 배송 준비 중 -&gt; 영업 준비 중)와
</span>            <span class="c1">// $canBuyNow를 복합해서 정렬해야 하므로 두 개 값을 결합했다.
</span>            <span class="c1">// 즉, 지금 상점이 영업 중이고 장바구니에 담긴 상품과 같은 상품이라 바로 구매 가능한 상품이 우선 노출된다.
</span>            <span class="k">return</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'%d%d'</span><span class="p">,</span> <span class="nv">$product</span><span class="p">[</span><span class="s1">'storeStatus'</span><span class="p">],</span> <span class="nv">$canBuyNow</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="2-테스트-작성">2. 테스트 작성</h2>

<h3 id="21-테스트-헬퍼">2.1. 테스트 헬퍼</h3>

<p><code class="highlighter-rouge">getTestableMethod()</code> 메서드는 PHP의 <code class="highlighter-rouge">Reflection</code> 클래스를 이용해서 인자로 받은 <code class="highlighter-rouge">$class::$name</code> 메서드를 이번 프로세스 동안만 Private 또는 Protected 메서드를 Public으로 변경해준다. 즉, 테스트를 수행하는 동안은 테스트 클래스가 타켓 메서드에 접근할 수 있다.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// tests/TestCase.php
</span>
<span class="k">namespace</span> <span class="nx">Test</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">TestCase</span> <span class="k">extends</span> <span class="nx">\Laravel\Lumen\Testing\TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createApplication</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">require</span> <span class="nx">__DIR__</span><span class="o">.</span><span class="s1">'/../bootstrap/app.php'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getTestableMethod</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// $class의 Reflection 인스턴스를 만든다.
</span>        <span class="nv">$reflection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\ReflectionClass</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
        
        <span class="c1">// $name 메서드를 접근 가능하도록 한다.
</span>        <span class="nv">$method</span> <span class="o">=</span> <span class="nv">$reflection</span><span class="o">-&gt;</span><span class="na">getMethod</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="nv">$method</span><span class="o">-&gt;</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

        <span class="c1">// Reflection된 클래스가 아니라, 메서드를 반환한다.
</span>        <span class="k">return</span> <span class="nv">$method</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="22-테스트-코드">2.2. 테스트 코드</h3>

<p>이제 테스트 코드를 쓰면 된다. 앞 절에서 만든 헬퍼에서 반환 받은 메서드에 <code class="highlighter-rouge">invokeArgs(클래스 인스턴스, [메서드의 인자])</code>식으로 사용하면 원래 감추진 메서드를 호출하여 결과를 얻을 수 있다.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// tests/Unit/QueryTest.php
</span>
<span class="k">namespace</span> <span class="nx">Test\Unit</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Bootake\SearchService\Thrift\Search\StoreStatus</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Elasticsearch\ClientBuilder</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Search\Infrastructure\Queries\CvsProduct</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">QueryTest</span> <span class="k">extends</span> <span class="nx">\Test\TestCase</span>
<span class="p">{</span>
    <span class="sd">/** @test */</span>
    <span class="k">function</span> <span class="nf">cvs_products_collection_should_be_sorted_by_its_parent_store_status</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$productCollection</span> <span class="o">=</span> <span class="nx">collect</span><span class="p">([</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">CLOSED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">CLOSED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">PREPARING</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">PREPARING</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">OPENED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">OPENED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">],</span>
        <span class="p">]);</span>

        <span class="c1">// 1절에서 설명한 테스트 타켓 클래스의 인스턴스를 만든다.
</span>        <span class="nv">$cvsProductQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CvsProduct</span><span class="p">(</span>
            <span class="nx">ClientBuilder</span><span class="o">::</span><span class="na">fromConfig</span><span class="p">([</span><span class="cm">/*...*/</span><span class="p">])</span>
        <span class="p">);</span>

        <span class="c1">// 테스트 헬퍼를 이용해서 다른 클래스에서 접근할 수 있는 메서드를 가져온다. 
</span>        <span class="nv">$method</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">getTestableMethod</span><span class="p">(</span>
            <span class="nx">CvsProduct</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="s1">'sortByStoreStatusAndCanBuyNow'</span>
        <span class="p">);</span>

        <span class="c1">// 메서드를 호출하고 반환값을 저장한다.
</span>        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$method</span><span class="o">-&gt;</span><span class="na">invokeArgs</span><span class="p">(</span><span class="nv">$cvsProductQuery</span><span class="p">,</span> <span class="p">[</span><span class="nv">$productCollection</span><span class="p">]);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">OPENED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">],</span>
            <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">()</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">'storeStatus'</span> <span class="o">=&gt;</span> <span class="nx">StoreStatus</span><span class="o">::</span><span class="na">CLOSED</span><span class="p">,</span> <span class="s1">'canBuyNow'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">],</span>
            <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><a href="/images/2016-12-04-img-01.png"><img src="/images/2016-12-04-img-01.png" alt="Unit Test" /></a></p>

<!--more-->
<div class="spacer">• • •</div>

<h2 id="덧-elastic-search-검색-성능">덧. Elastic Search 검색 성능</h2>

<p>지난 달에 열린 XECon에서 <a href="https://www.facebook.com/findstar">안정수</a>님이 <a href="https://laravel.kr/docs/5.3/scout">라라벨 Scout</a>를 발표했는데, 청중 중에 한 분이 Scout의 성능에 대한 질문을 하셨다. Scout는 Algolia 또는 Elastic Search 등의 검색 엔진을 라라벨 프로젝트에서 사용하기 쉽도록 랩핑한 라이브러리다. 본 포스트의 주제와 무관하지만 필자가 측정한 성능을 남겨 놓는다.</p>

<p>검색 요청을 수신하고 프레임워크를 부팅하고 검색을 수행하는 메서드에 도달하는 데까지 41ms, 검색 요청에는 위/경도를 포함하고 있는데 받은 위/경도에 해당하는 지역 ID를 PostgreSQL을 사용하는 다른 마이크로 서비스에 던져 응답을 받는데까지 걸린 총 시간 481ms, 15만 인덱스에 대고 검색하고 결과를 받아 후처리하는 등 모든 작업을 마치고 응답을 내보기 직전까지 걸린 시간 777ms다.</p>

<p>OS X의 PHP 내장 웹 서버에서 검색 서비스를 구동하고, Elastic Search는 원격에 있는 상태로 테스트했다.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># storage/logs/lumen.log</span>

<span class="o">[</span>2016-12-04 15:13:22] search.DEBUG: 검색 요청 수신:SearchService.php:69 <span class="o">[</span>0.04101300239563] 
<span class="o">[</span>2016-12-04 15:13:22] search.DEBUG: RegionId 페치 완료<span class="o">(</span><span class="nv">regionId</span><span class="o">=</span><span class="k">****</span><span class="o">)</span>:SearchService.php:77 <span class="o">[</span>0.48165106773376] 
<span class="o">[</span>2016-12-04 15:13:22] search.DEBUG: 검색 완료:SearchService.php:87 <span class="o">[</span>0.7775821685791] 
<span class="o">[</span>2016-12-04 15:13:22] search.DEBUG: 성능 요구량 <span class="o">[</span><span class="s2">"메모리(MB) : 6.883152"</span>,<span class="s2">"CPU(%): 1.97802734375"</span><span class="o">]</span> 
</code></pre>
</div>

      </div>

      <footer class="box-tags">
        <span><i class="material-icons">label</i> Tags:</span>
        
          <a href="/tags#개발자">
            개발자
          </a>
          , 
        
          <a href="/tags#PHP">
            PHP
          </a>
          
        
      </footer>
    </article>

    <nav id="pagination">
      <ul class="pager">
        
        <li class="previous">
          <a href="/work-n-play/php-application-logging-to-elasticsearch-using-monolog/">
            <span aria-hidden="true">
              <i class="material-icons">navigate_before</i>
            </span>
            <span class="pager-title-sm">Older</span>
            <span class="pager-title">
              Monolog를 이용한 애플리케...
            </span>
          </a>
        </li>
        

        
        <li class="next">
          <a href="/work-n-play/how-to-use-apache-thrift-in-php-part-2/">
            <span class="pager-title">
              RPC - Apache Thri...
            </span>
            <span class="pager-title-sm">Newer</span>
            <span aria-hidden="true">
              <i class="material-icons">navigate_next</i>
            </span>
          </a>
        </li>
        
      </ul>
    </nav>

    <div class="comments" style="margin-bottom: 30px;">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//appkr.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

  </section>

  <aside id="sidebar" class="col-md-3">
    <section class="box" id="search">
  <div class="box-body">
    <form action="#">
      <div class="form-group">
        <input class="form-control input-lg" type="text" id="q" placeholder="Search...">
        <ul id="q-results"></ul>
      </div>
    </form>
  </div>
</section>

<section class="box" id="categories">
  <div class="box-header">
    <h3>Categories</h3>
  </div>

  <div class="box-body">
    <ul>
      <li>
        <a href="/categories#around-me">
          Around Me
          <span class="badge">25</span>
        </a>
      </li>
      <li>
        <a href="/categories#learn-n-think">
          Learn & Think
          <span class="badge">71</span>
        </a>
      </li>
      <li>
        <a href="/categories#work-n-play">
          Work & Play
          <span class="badge">52</span>
        </a>
      </li>
      <li>
        <a href="/categories#imported">
          Imported
          <span class="badge">3</span>
        </a>
      </li>
      <li>
        <a href="/categories#uncategorized">
          Uncategorized
          <span class="badge">2</span>
        </a>
      </li>
    </ul>
  </div>
</section>

<section class="box" id="tags">
  <div class="box-header">
    <h3>Tags</h3>
  </div>

  <div class="box-body tags">
    <div class="tags">
    
    
    <span style="font-size: 98%">
      <a href="/tags#3d">
        3d
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#API">
        API
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Apache Thrift">
        Apache Thrift
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#CSS">
        CSS
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Database">
        Database
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Docker">
        Docker
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Dotfiles">
        Dotfiles
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Facebook">
        Facebook
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Generator">
        Generator
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#Git">
        Git
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#JWT">
        JWT
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Javascript">
        Javascript
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#Jekyll">
        Jekyll
      </a>
    </span>
    
    <span style="font-size: 126%">
      <a href="/tags#Laravel">
        Laravel
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Lumen">
        Lumen
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#OS X">
        OS X
      </a>
    </span>
    
    <span style="font-size: 134%">
      <a href="/tags#PHP">
        PHP
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#RESTful">
        RESTful
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#RPC">
        RPC
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Ruby">
        Ruby
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Streaming">
        Streaming
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#URL Rewriting">
        URL Rewriting
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Web">
        Web
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Websocket">
        Websocket
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#adobe">
        adobe
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#amazon">
        amazon
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#amd">
        amd
      </a>
    </span>
    
    <span style="font-size: 142%">
      <a href="/tags#android">
        android
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#apple">
        apple
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ar">
        ar
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#architecture">
        architecture
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#arm">
        arm
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bada">
        bada
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bluetooth">
        bluetooth
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bus">
        bus
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#cdp">
        cdp
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#chrome">
        chrome
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#cloud">
        cloud
      </a>
    </span>
    
    <span style="font-size: 114%">
      <a href="/tags#codec">
        codec
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#connectivity">
        connectivity
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#cpu">
        cpu
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ebook">
        ebook
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#emulator">
        emulator
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#flash">
        flash
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#framework">
        framework
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#gms">
        gms
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#google">
        google
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#gtd">
        gtd
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#intel">
        intel
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ios">
        ios
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#iphone">
        iphone
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#java">
        java
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#lbs">
        lbs
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#limo">
        limo
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#linux">
        linux
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#mcu">
        mcu
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#memory">
        memory
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#microsoft">
        microsoft
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#mobile">
        mobile
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#opencore">
        opencore
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#opengl">
        opengl
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#opengles">
        opengles
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#opensource">
        opensource
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#openvg">
        openvg
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#platform">
        platform
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#pnd">
        pnd
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#presentation">
        presentation
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#pvcore">
        pvcore
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#se">
        se
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#sns">
        sns
      </a>
    </span>
    
    <span style="font-size: 114%">
      <a href="/tags#soc">
        soc
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#symbian">
        symbian
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#tech">
        tech
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#ted">
        ted
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#tedx">
        tedx
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#windowsmobile">
        windowsmobile
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#wss">
        wss
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#x86">
        x86
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#史記">
        史記
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#孟子">
        孟子
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#孫子兵法">
        孫子兵法
      </a>
    </span>
    
    <span style="font-size: 238%">
      <a href="/tags#개발자">
        개발자
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#경력개발">
        경력개발
      </a>
    </span>
    
    <span style="font-size: 138%">
      <a href="/tags#기업철학">
        기업철학
      </a>
    </span>
    
    <span style="font-size: 174%">
      <a href="/tags#기획자">
        기획자
      </a>
    </span>
    
    <span style="font-size: 146%">
      <a href="/tags#리더쉽">
        리더쉽
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#생산성">
        생산성
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#소프트웨어공학">
        소프트웨어공학
      </a>
    </span>
    
    <span style="font-size: 210%">
      <a href="/tags#인생철학">
        인생철학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#자녀교육">
        자녀교육
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#전략">
        전략
      </a>
    </span>
    
    <span style="font-size: 146%">
      <a href="/tags#조직관리">
        조직관리
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#조직문화">
        조직문화
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#조직행동">
        조직행동
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#철학">
        철학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#취미">
        취미
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#특기">
        특기
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#프로젝트관리">
        프로젝트관리
      </a>
    </span>
    
    </div>
  </div>
</section>

<section class="box" id="recent-posts">
  <div class="box-header">
    <h3>Recent Posts</h3>
  </div>

  <div class="box-body">
    <ul>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2017-02-11</small>
          <a href="/work-n-play/db-query-performance-illustration-using-array/">데이터베이스 쿼리 성능 차이를 이해하기 위한 실험</a>
        </h4>
      </li>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2017-02-11</small>
          <a href="/learn-n-think/style-changed/">존칭형으로 블로그 쓰기</a>
        </h4>
      </li>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2017-01-15</small>
          <a href="/work-n-play/understanding-php-exception-class-part-2/">PHP의 예외 클래스 이해하기 2부</a>
        </h4>
      </li>
      
    </ul>
  </div>
</section>

<section class="box" id="recent-comments">
  <div class="box-header">
    <h3>Recent Comments</h3>
  </div>

  <div class="box-body dsq-widget">
    <script type="text/javascript" src="http://appkr.disqus.com/recent_comments_widget.js?num_items=5&hide_mods=0&hide_avatars=0&avatar_size=32&excerpt_length=100"></script>
  </div>
</section>

<section class="box" id="recent-feeds">
  <div class="box-header">
    <h3>Facebook Posts</h3>
  </div>

  <div class="box-body">
    <ul id="facebook-feed">
      <script id="facebook-feed-template" type="text/x-template">
        <li>
          <span class="facebook-message">
            { message }
          </span>
          ·
          <span class="facebook-meta">
            <a href="https://www.facebook.com/juwonkimatmedotcom/posts/{ id }">
              { created_time }
            </a>
          </span>
        </li>
      </script>
    </ul>
  </div>
</section>

  </aside>
</div>


  <footer id="site-footer">
  <h4>
    <a href="/">
      Appkr.memo(new Life)
    </a>
  </h4>
  <p>
    &copy; 2008~2017 •
    Built with <a href="http://jekyllrb.com/">Jekyll</a> •
    Hosted by <a href="https://pages.github.com/">Github</a> •
    <a href="/feed.xml">Rss</a>
  </p>
</footer>


  <div id="back-to-top">
    <a href="#" title="Scroll to Top">
      <i class="material-icons">keyboard_arrow_up</i>
    </a>
  </div>

  <script src="/scripts/main.min.js"></script>
</body>

</html>
