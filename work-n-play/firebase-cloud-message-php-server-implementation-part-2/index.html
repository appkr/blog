<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <meta name="description" content="이 포스트는 2016년 12월 24일 첫 포스트 이후, 2017년 1월, 2018년 7월, 2018년 11월 총 세차례에 걸쳐 완전히 다시 썼으며, 예제 코드 또한 변경되었습니다.     최종 리팩토링의 가장 큰 변경은 기존에 사용하던 brozot/laravel-fcm 패키지를 완..."/>
  <meta name="google-site-verification" content="ToXKBimREnz49pDNot4b-N9ZJgYcKXPPsHsjhg4Zzuc" />
  <meta name="naver-site-verification" content="7cebcc8e5493169f5401870d9ce57f48d18491cd"/>

  <meta name="msapplication-tap-highlight" content="no"/>

  <!-- Facebook Meta -->
  <meta property="og:title" content="모바일 푸쉬 메시지(FCM)를 위한 PHP 서버 구현 2부"/>
  <meta property="og:type" content="Website"/>
  <meta property="og:author" content="appkr (juwonkim@me.com)"/>
  <meta property="og:image" content="//blog.appkr.kr/images/images/2016-12-24-img-01.png"/>

  <!-- Google+ Meta -->
  <meta itemprop="name" content="모바일 푸쉬 메시지(FCM)를 위한 PHP 서버 구현 2부">
  <meta itemprop="description" content="이 포스트는 2016년 12월 24일 첫 포스트 이후, 2017년 1월, 2018년 7월, 2018년 11월 총 세차례에 걸쳐 완전히 다시 썼으며, 예제 코드 또한 변경되었습니다.     최종 리팩토링의 가장 큰 변경은 기존에 사용하던 brozot/laravel-fcm 패키지를 완...">
  <meta itemprop="image" content="//blog.appkr.kr/images/images/2016-12-24-img-01.png">
  <meta itemprop="author" content="appkr (juwonkim@me.com)"/>

  <!-- Twitter Meta -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@appkrs" />
  <meta name="twitter:title" content="모바일 푸쉬 메시지(FCM)를 위한 PHP 서버 구현 2부" />
  <meta name="twitter:description" content="이 포스트는 2016년 12월 24일 첫 포스트 이후, 2017년 1월, 2018년 7월, 2018년 11월 총 세차례에 걸쳐 완전히 다시 썼으며, 예제 코드 또한 변경되었습니다.     최종 리팩토링의 가장 큰 변경은 기존에 사용하던 brozot/laravel-fcm 패키지를 완..." />
  <meta name="twitter:image" content="//blog.appkr.kr/images/images/2016-12-24-img-01.png" />
  <meta name="twitter:domain" content="blog.appkr.kr">

  <!-- Mobile and Rss -->
  <link rel="canonical" href="http://blog.appkr.kr/work-n-play/firebase-cloud-message-php-server-implementation-part-2/"/>
  <link rel="alternate" type="application/rss+xml" title="Appkr.memo(new Life)" href="http://blog.appkr.kr/feed.xml"/>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/earlyaccess/nanumgothic.css"/>
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons"/>
  <link rel="stylesheet" href="/styles/main.min.css"/>

  <title>모바일 푸쉬 메시지(FCM)를 위한 PHP 서버 구현 2부 | Appkr.memo(new Life)</title>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body id="app">

  <nav class="navbar navbar-static-top" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="sr-only">Navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        Appkr.memo(new Life)
      </a>
    </div>

    <div class="navbar-collapse collapse navbar-responsive-collapse">
      <ul class="nav navbar-nav navbar-right text-center">
        <li>
          <a href="/">Blog</a>
        </li>
        <li>
          <a href="/profile/">Profile</a>
        </li>
      </ul>

      <div id="search_header" class="visible-xs">
        <div class="box-body">
          <form action="#">
            <div class="form-group">
              <input class="form-control input-lg" type="text" id="q_header" placeholder="Search...">
              <ul id="q_header_res"></ul>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</nav>


  <div class="container">
  <section id="main" class="col-md-9 minimal">
    <article class="box">
      <div class="box-header">
        <h2>
          <span class="title">모바일 푸쉬 메시지(FCM)를 위한 PHP 서버 구현 2부</span>
          <span class="action dropdown pull-right">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-target="#">
              <i class="material-icons">share</i>
            </a>

            <ul class="dropdown-menu">
              <li>
                <a href="https://www.facebook.com/sharer/sharer.php?u=http://blog.appkr.kr/work-n-play/firebase-cloud-message-php-server-implementation-part-2/&title=모바일 푸쉬 메시지(FCM)를 위한 PHP 서버 구현 2부" id="sns-facebook">
                  Facebook
                </a>
              </li>
              <li>
                <a href="http://twitter.com/share?url=http://blog.appkr.kr/work-n-play/firebase-cloud-message-php-server-implementation-part-2/&title=모바일 푸쉬 메시지(FCM)를 위한 PHP 서버 구현 2부&text=모바일 푸쉬 메시지(FCM)를 위한 PHP 서버 구현 2부" id="sns-twitter">
                  Twitter
                </a>
              </li>
              <li>
                <a href="https://plus.google.com/share?url=http://blog.appkr.kr/work-n-play/firebase-cloud-message-php-server-implementation-part-2/" id="sns-google">
                  Google+
                </a>
              </li>
            </ul>
          </span>
        </h2>

        <p class="box-meta">
          <span>
            <i class="material-icons">today</i>
            2016-12-24
          </span>
          <span>
            <i class="material-icons">face</i>
            Posted by appkr
          </span>
          <span>
            <i class="material-icons">turned_in</i>
            
              <a href="/categories#work-n-play">
                
                    Work & Play
                  
              </a>
              
            
          </span>
          <span>
            <i class="material-icons">forum</i>
            <a href="/work-n-play/firebase-cloud-message-php-server-implementation-part-2/#disqus_thread" title="comments">0</a>
          </span>
        </p>
      </div>

      <div class="box-body">
        <div class="panel panel-default">
  <div class="panel-body">
    <p class="lead">이 포스트는 2016년 12월 24일 첫 포스트 이후, 2017년 1월, 2018년 7월, 2018년 11월 총 세차례에 걸쳐 완전히 다시 썼으며, 예제 코드 또한 변경되었습니다.</p> 
    <p class="lead">최종 리팩토링의 가장 큰 변경은 기존에 사용하던 <code class="highlighter-rouge">brozot/laravel-fcm</code> 패키지를 완전히 버리고, <code class="highlighter-rouge">Guzzle</code>로 직접 구현했다는 점입니다.</p>
  </div>
</div>

<p><strong>FCM(Firebase Cloud Message)은 Android, iOS, Web 등의 클라이언트에 푸쉬 메시지를 보내기 위한 서비스</strong>다. 과거 GCM(Google Cloud Message)이 진화한 것이다.</p>

<p><img src="https://1.bp.blogspot.com/-YIfQT6q8ZM4/Vzyq5z1B8HI/AAAAAAAAAAc/UmWSSMLKtKgtH7CACElUp12zXkrPK5UoACLcB/s1600/image00.png" alt="Firebase Logo" /></p>

<p><a href="/work-n-play/firebase-cloud-message-php-server-implementation-part-1/">지난 1부</a>에서는 푸쉬 메시지를 받을 모바일 단말 애플리케이션이 구글 Fcm 서버로 부터 받은 고유 식별 토큰을 애플리케이션 서버로 전달해 등록하는 과정을 구현했다. 이번 포스트에서는 등록한 토큰으로 푸쉬 메시지를 쏘는 기능을 구현한다.</p>

<!--more-->
<div class="spacer">• • •</div>

<h2 id="1-설계">1. 설계</h2>

<p><a href="/images/2016-12-24-img-00.png"><img src="/images/2016-12-24-img-00.png" alt="" /></a></p>

<p><small>그림 원본: https://docs.google.com/presentation/d/11kNXkxA0kXoO-ayQHFa2yCOAIch4CEofXgf013aywFM/edit?usp=sharing</small></p>

<p>각 클래스의 역할은 아래와 같다.</p>

<h4 id="fcmserviceprovider">FcmServiceProvider</h4>
<ul>
  <li><code class="highlighter-rouge">FcmDeviceRepository</code> 인터페이스에 대한 구체 클래스인 <code class="highlighter-rouge">EloquentFcmDeviceRepository</code>를 등록한다.</li>
  <li><code class="highlighter-rouge">FcmHandler</code> 조립을 위한 공식을 등록한다.</li>
</ul>

<h4 id="fcmhandler">FcmHandler</h4>
<ul>
  <li>Fcm 메시지를 전송한다.</li>
  <li>메시지 전달을 요청한 push_service_id가 바뀌었으면, <code class="highlighter-rouge">FcmDeviceRepository</code>를 이용해서 <code class="highlighter-rouge">Device</code> 모델을 업데이트한다.</li>
  <li>메시지 전달에 실패했을 때, 재전송하거나, 유효하지 않은 push_service_id라고 응답 받으면, <code class="highlighter-rouge">FcmDeviceRepository</code>를 이용해서 <code class="highlighter-rouge">Device</code> 모델을 삭제한다.</li>
  <li>로그를 남긴다.</li>
</ul>

<h4 id="fcmdevicerepository-eloquentfcmdevicerepository">FcmDeviceRepository, EloquentFcmDeviceRepository</h4>
<ul>
  <li>Fcm 서버의 응답에 따라, <code class="highlighter-rouge">Device</code> 모델을 업데이트하거나 삭제한다.</li>
</ul>

<h4 id="downstreamresponse">DownstreamResponse</h4>
<ul>
  <li><code class="highlighter-rouge">GuzzleClient</code>의 HTTP 응답을 파싱하여, 의미를 담고 있고 사용하기 편리한 형태로 가공한 데이터 객체다.</li>
  <li><code class="highlighter-rouge">brozot/laravel-fcm</code>에서 제공하는 클래스를 그대로 인용했다.</li>
</ul>

<h4 id="user-device">User, Device</h4>
<ul>
  <li>A User has many devices. A Device belongs to a User.</li>
</ul>

<h2 id="2-환경변수-등록">2. 환경변수 등록</h2>

<p>이전 포스트에서 설명했듯이 Firebase 콘솔로 부터 받은 <strong>서버 키</strong>와 <strong>발신자 ID</strong>를 Fcm 서버에 요청할 때마다 제출해야 정상적으로 통신이된다. <code class="highlighter-rouge">.env</code> 파일에 환경 변수를 먼저 등록하고, 라라벨 config를 통해 이 값들에 접근할 수 있도록 하자.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># .env</span>

<span class="nv">FCM_SERVER_KEY</span><span class="o">=</span>AAAAMqBU...OJy1Dw
<span class="nv">FCM_SENDER_ID</span><span class="o">=</span>217...581
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// config/fcm.php</span>

<span class="k">return</span> <span class="p">[</span>
    <span class="s1">'server_key'</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">'FCM_SERVER_KEY'</span><span class="p">),</span>
    <span class="s1">'sender_id'</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">'FCM_SENDER_ID'</span><span class="p">),</span>
    <span class="s1">'server_send_url'</span> <span class="o">=&gt;</span> <span class="s1">'https://fcm.googleapis.com'</span><span class="p">,</span>
    <span class="s1">'timeout'</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="p">,</span> <span class="c1">// in second</span>
<span class="p">];</span>
</code></pre></div></div>

<h2 id="3-서비스-프로바이더">3. 서비스 프로바이더</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="cp">&lt;?php</span> <span class="c1">// app/Providers/FcmServiceProvider</span>
 <span class="mi">2</span> 
 <span class="mi">3</span> <span class="k">namespace</span> <span class="nx">App\Providers</span><span class="p">;</span>
 <span class="mi">4</span> 
 <span class="mi">5</span> <span class="k">use</span> <span class="nx">App\Services\EloquentFcmDeviceRepository</span><span class="p">;</span>
 <span class="mi">6</span> <span class="k">use</span> <span class="nx">App\Services\FcmDeviceRepository</span><span class="p">;</span>
 <span class="mi">7</span> <span class="k">use</span> <span class="nx">App\Services\FcmHandler</span><span class="p">;</span>
 <span class="mi">8</span> <span class="k">use</span> <span class="nx">GuzzleHttp\Client</span> <span class="k">as</span> <span class="nx">GuzzleClient</span><span class="p">;</span>
 <span class="mi">9</span> <span class="k">use</span> <span class="nx">Illuminate\Contracts\Config\Repository</span> <span class="k">as</span> <span class="nx">ConfigRepository</span><span class="p">;</span>
<span class="mi">10</span> <span class="k">use</span> <span class="nx">Illuminate\Contracts\Foundation\Application</span><span class="p">;</span>
<span class="mi">11</span> <span class="k">use</span> <span class="nx">Illuminate\Support\ServiceProvider</span><span class="p">;</span>
<span class="mi">12</span> <span class="k">use</span> <span class="nx">Psr\Log\LoggerInterface</span><span class="p">;</span>
<span class="mi">13</span> 
<span class="mi">14</span> <span class="k">class</span> <span class="nc">FcmServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="mi">15</span> <span class="p">{</span>
<span class="mi">16</span>     <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">()</span>
<span class="mi">17</span>     <span class="p">{</span>
<span class="mi">18</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bindFcmDeviceRepository</span><span class="p">();</span>
<span class="mi">19</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bindFcmHandler</span><span class="p">();</span>
<span class="mi">20</span>     <span class="p">}</span>
<span class="mi">21</span> 
<span class="mi">22</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">bindFcmDeviceRepository</span><span class="p">()</span>
<span class="mi">23</span>     <span class="p">{</span>
<span class="mi">24</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="nx">FcmDeviceRepository</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nx">EloquentFcmDeviceRepository</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="mi">25</span>     <span class="p">}</span>
<span class="mi">26</span> 
<span class="mi">27</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">bindFcmHandler</span><span class="p">()</span>
<span class="mi">28</span>     <span class="p">{</span>
<span class="mi">29</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="nx">FcmHandler</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Application</span> <span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">30</span>             <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">ConfigRepository</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'fcm'</span><span class="p">);</span>
<span class="mi">31</span> 
<span class="mi">32</span>             <span class="nv">$httpClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GuzzleClient</span><span class="p">([</span>
<span class="mi">33</span>                 <span class="s1">'base_uri'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'server_send_url'</span><span class="p">],</span>
<span class="mi">34</span>                 <span class="s1">'headers'</span> <span class="o">=&gt;</span> <span class="p">[</span>
<span class="mi">35</span>                     <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"key=</span><span class="si">{</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'server_key'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
<span class="mi">36</span>                     <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span><span class="p">,</span>
<span class="mi">37</span>                     <span class="s1">'project_id'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'sender_id'</span><span class="p">],</span>
<span class="mi">38</span>                 <span class="p">],</span>
<span class="mi">39</span>                 <span class="s1">'timeout'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'timeout'</span><span class="p">],</span>
<span class="mi">40</span>             <span class="p">]);</span>
<span class="mi">41</span>             <span class="nv">$deviceRepo</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">FcmDeviceRepository</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="mi">42</span>             <span class="nv">$logger</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">LoggerInterface</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="mi">43</span> 
<span class="mi">44</span>             <span class="k">return</span> <span class="k">new</span> <span class="nx">FcmHandler</span><span class="p">(</span><span class="nv">$httpClient</span><span class="p">,</span> <span class="nv">$deviceRepo</span><span class="p">,</span> <span class="nv">$logger</span><span class="p">);</span>
<span class="mi">45</span>         <span class="p">});</span>
<span class="mi">46</span>     <span class="p">}</span>
<span class="mi">47</span> <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>24: <code class="highlighter-rouge">FcmDeviceRepository</code>를 요청하면, <code class="highlighter-rouge">EloquentFcmDeviceRepository</code>를 조립해서 제공한다.</li>
  <li>32~40: Fcm 서버와 통신하기위한 HTTP 클라이언트를 조립한다.</li>
  <li>44: <code class="highlighter-rouge">FcmHandler</code> 객체가 동작하기 위해 필요한 의존 객체를 생성자로 주입하고 생성된 최종 객체를 반환한다.</li>
</ul>

<h2 id="4-디바이스-리포지토리">4. 디바이스 리포지토리</h2>

<p>인터페이스를 만들지 말지는 개발자의 선택이다.</p>

<p>이 예제에서 구현한 엘로퀀트를 이용하는 리포지토리를 대신하는 다른 리포지토리를 런타임에 선택해서 사용하려면 인터페이스를 만들고, 인터페이스를 구현하는 구체 클래스를 추가하는 것이 좋다. 가령, 서비스 프로바이더에 조건문을 걸어 환경에 따라 서로 다른 리포지토리를 사용하는 용례를 생각해 볼 수 있다(<code class="highlighter-rouge">if (App::environment('local')) { return new NullRepository; }</code>).</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="cp">&lt;?php</span> <span class="c1">// app/Services/FcmDeviceRepository.php</span>
 <span class="mi">2</span> 
 <span class="mi">3</span> <span class="k">namespace</span> <span class="nx">App\Services</span><span class="p">;</span>
 <span class="mi">4</span> 
 <span class="mi">5</span> <span class="k">interface</span> <span class="nx">FcmDeviceRepository</span>
 <span class="mi">6</span> <span class="p">{</span>
 <span class="mi">7</span>     <span class="k">public</span> <span class="k">function</span> <span class="nf">updateFcmDevice</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$oldId</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$newId</span><span class="p">);</span>
 <span class="mi">8</span>     <span class="k">public</span> <span class="k">function</span> <span class="nf">deleteFcmDevice</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$deprecatedId</span><span class="p">);</span>
 <span class="mi">9</span> <span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="cp">&lt;?php</span> <span class="c1">// app/Services/EloquentFcmDeviceRepository.php</span>
 <span class="mi">2</span> 
 <span class="mi">3</span> <span class="k">namespace</span> <span class="nx">App\Services</span><span class="p">;</span>
 <span class="mi">4</span> 
 <span class="mi">5</span> <span class="k">use</span> <span class="nx">App\Device</span><span class="p">;</span>
 <span class="mi">6</span> <span class="k">use</span> <span class="nx">DB</span><span class="p">;</span>
 <span class="mi">7</span> 
 <span class="mi">8</span> <span class="k">class</span> <span class="nc">EloquentFcmDeviceRepository</span> <span class="k">implements</span> <span class="nx">FcmDeviceRepository</span>
 <span class="mi">9</span> <span class="p">{</span>
<span class="mi">10</span>     <span class="k">public</span> <span class="k">function</span> <span class="nf">updateFcmDevice</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$oldId</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$newId</span><span class="p">)</span>
<span class="mi">11</span>     <span class="p">{</span>
<span class="mi">12</span>         <span class="nv">$device</span> <span class="o">=</span> <span class="nx">Device</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">'push_service_id'</span><span class="p">,</span> <span class="nv">$oldId</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
<span class="mi">13</span>         <span class="k">if</span> <span class="p">(</span><span class="nv">$device</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">14</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">15</span>         <span class="p">}</span>
<span class="mi">16</span> 
<span class="mi">17</span>         <span class="nv">$device</span><span class="o">-&gt;</span><span class="na">push_service_id</span> <span class="o">=</span> <span class="nv">$newId</span><span class="p">;</span>
<span class="mi">18</span> 
<span class="mi">19</span>         <span class="nx">DB</span><span class="o">::</span><span class="na">transaction</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$device</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">20</span>             <span class="nv">$device</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
<span class="mi">21</span>         <span class="p">});</span>
<span class="mi">22</span>     <span class="p">}</span>
<span class="mi">23</span> 
<span class="mi">24</span>     <span class="k">public</span> <span class="k">function</span> <span class="nf">deleteFcmDevice</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$deprecatedId</span><span class="p">)</span>
<span class="mi">25</span>     <span class="p">{</span>
<span class="mi">26</span>         <span class="nv">$device</span> <span class="o">=</span> <span class="nx">Device</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">'push_service_id'</span><span class="p">,</span> <span class="nv">$deprecatedId</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
<span class="mi">27</span>         <span class="k">if</span> <span class="p">(</span><span class="nv">$device</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">28</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">29</span>         <span class="p">}</span>
<span class="mi">30</span> 
<span class="mi">31</span>         <span class="nx">DB</span><span class="o">::</span><span class="na">transaction</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$device</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">32</span>             <span class="nv">$device</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
<span class="mi">33</span>         <span class="p">});</span>
<span class="mi">34</span>     <span class="p">}</span>
<span class="mi">35</span> <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>12: Fcm 서버에서 응답받은 <code class="highlighter-rouge">$oldId</code>를 가진 <code class="highlighter-rouge">Device</code> 모델을 찾는다.</li>
  <li>17: Fcm 서버에서 응답받은 <code class="highlighter-rouge">$newId</code>로 교체한다.</li>
  <li>20: 저장한다.</li>
  <li>24~34: 마찬가지로 Fcm 서버가 유효하지 않다고 응답해준 <code class="highlighter-rouge">$deprecatedId</code>를 가진 <code class="highlighter-rouge">Device</code> 모델을 찾아 삭제한다.</li>
</ul>

<h2 id="5-fcm-핸들러">5. Fcm 핸들러</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1 <span class="cp">&lt;?php</span> <span class="c1">// app/Services/FcmHandler.php</span>
  <span class="mi">2</span> 
  <span class="mi">3</span> <span class="k">namespace</span> <span class="nx">App\Services</span><span class="p">;</span>
  <span class="mi">4</span> 
  <span class="mi">5</span> <span class="k">use</span> <span class="nx">Exception</span><span class="p">;</span>
  <span class="mi">6</span> <span class="k">use</span> <span class="nx">GuzzleHttp\Client</span> <span class="k">as</span> <span class="nx">GuzzleClient</span><span class="p">;</span>
  <span class="mi">7</span> <span class="k">use</span> <span class="nx">GuzzleHttp\Psr7\Request</span><span class="p">;</span>
  <span class="mi">8</span> <span class="k">use</span> <span class="nx">Psr\Log\LoggerInterface</span><span class="p">;</span>
  <span class="mi">9</span> 
 <span class="mi">10</span> <span class="k">class</span> <span class="nc">FcmHandler</span>
 <span class="mi">11</span> <span class="p">{</span>
 <span class="mi">12</span>     <span class="k">const</span> <span class="no">MAX_TOKEN_PER_REQUEST</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
 <span class="mi">13</span>     <span class="k">const</span> <span class="no">API_ENDPOINT</span> <span class="o">=</span> <span class="s1">'fcm/send'</span><span class="p">;</span>
 <span class="mi">14</span> 
 <span class="mi">15</span>     <span class="k">private</span> <span class="nv">$httpClient</span><span class="p">;</span>
 <span class="mi">16</span>     <span class="k">private</span> <span class="nv">$deviceRepo</span><span class="p">;</span>
 <span class="mi">17</span>     <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>
 <span class="mi">18</span> 
 <span class="mi">19</span>     <span class="k">private</span> <span class="nv">$receivers</span><span class="p">;</span>
 <span class="mi">20</span>     <span class="k">private</span> <span class="nv">$message</span><span class="p">;</span>
 <span class="mi">21</span>     <span class="k">private</span> <span class="nv">$retryIntervalInUs</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span> <span class="c1">// 100ms</span>
 <span class="mi">22</span>     <span class="k">private</span> <span class="nv">$maxRetryCount</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
 <span class="mi">23</span>     <span class="k">private</span> <span class="nv">$retriedCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">24</span> 
 <span class="mi">25</span>     <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
 <span class="mi">26</span>         <span class="nx">GuzzleClient</span> <span class="nv">$httpClient</span><span class="p">,</span>
 <span class="mi">27</span>         <span class="nx">FcmDeviceRepository</span> <span class="nv">$deviceRepo</span><span class="p">,</span>
 <span class="mi">28</span>         <span class="nx">LoggerInterface</span> <span class="nv">$logger</span>
 <span class="mi">29</span>     <span class="p">)</span> <span class="p">{</span>
 <span class="mi">30</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">httpClient</span> <span class="o">=</span> <span class="nv">$httpClient</span><span class="p">;</span>
 <span class="mi">31</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deviceRepo</span> <span class="o">=</span> <span class="nv">$deviceRepo</span><span class="p">;</span>
 <span class="mi">32</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
 <span class="mi">33</span>     <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>15~17: 생성자를 통해 받은 멤버 필드들이다.</li>
  <li>19~20: 개별 메시지 전송에 필요한 수신자와 메시지 본문을 담을 필드다.</li>
  <li>21~23: 메시지 재전송등의 제어를 위해 사용할 필드다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="mi">35</span>     <span class="k">public</span> <span class="k">function</span> <span class="nf">sendMessage</span><span class="p">()</span>
 <span class="mi">36</span>     <span class="p">{</span>
 <span class="mi">37</span>         <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nb">array_filter</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">receivers</span><span class="p">))</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">38</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logProgress</span><span class="p">(</span><span class="s1">'푸쉬 알림을 전송을 건너 뜁니다: 수신자가 없습니다.'</span><span class="p">);</span>
 <span class="mi">39</span>             <span class="k">return</span><span class="p">;</span>
 <span class="mi">40</span>         <span class="p">}</span>
 <span class="mi">41</span> 
 <span class="mi">42</span>         <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isInitialRequest</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">43</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logProgress</span><span class="p">(</span><span class="s1">'푸쉬 알림을 전송합니다.'</span><span class="p">,</span> <span class="p">[</span>
 <span class="mi">44</span>                 <span class="s1">'receivers'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">receivers</span><span class="p">,</span>
 <span class="mi">45</span>                 <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span>
 <span class="mi">46</span>             <span class="p">],</span> <span class="s1">'debug'</span><span class="p">);</span>
 <span class="mi">47</span>         <span class="p">}</span>
 <span class="mi">48</span> 
 <span class="mi">49</span>         <span class="k">try</span> <span class="p">{</span>
 <span class="mi">50</span>             <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">receivers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">MAX_TOKEN_PER_REQUEST</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">51</span>                 <span class="nv">$response</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
 <span class="mi">52</span>                 <span class="k">foreach</span> <span class="p">(</span><span class="nb">array_chunk</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">receivers</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">MAX_TOKEN_PER_REQUEST</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$chunk</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">53</span>                     <span class="nv">$responsePartial</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_sendMessage</span><span class="p">(</span><span class="nv">$chunk</span><span class="p">);</span>
 <span class="mi">54</span>                     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">55</span>                         <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$responsePartial</span><span class="p">;</span>
 <span class="mi">56</span>                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">57</span>                         <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">merge</span><span class="p">(</span><span class="nv">$responsePartial</span><span class="p">);</span>
 <span class="mi">58</span>                     <span class="p">}</span>
 <span class="mi">59</span> 
 <span class="mi">60</span>                     <span class="nb">usleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
 <span class="mi">61</span>                 <span class="p">}</span>
 <span class="mi">62</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">63</span>                 <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_sendMessage</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">receivers</span><span class="p">);</span>
 <span class="mi">64</span>             <span class="p">}</span>
 <span class="mi">65</span> 
 <span class="mi">66</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatePushServiceIdsIfAny</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
 <span class="mi">67</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handleDeliveryFailureIfAny</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
 <span class="mi">68</span> 
 <span class="mi">69</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logProgress</span><span class="p">(</span><span class="s2">"푸쉬 알림을 전송했습니다."</span><span class="p">,</span> <span class="p">[</span>
 <span class="mi">70</span>                 <span class="s1">'receiver'</span> <span class="o">=&gt;</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">receivers</span><span class="p">,</span>
 <span class="mi">71</span>             <span class="p">]);</span>
 <span class="mi">72</span>         <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">73</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logProgress</span><span class="p">(</span><span class="s2">"푸쉬 알림을 전송하지 못헸습니다: </span><span class="si">{</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="p">[</span>
 <span class="mi">74</span>                 <span class="s1">'receiver'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">receivers</span><span class="p">,</span>
 <span class="mi">75</span>             <span class="p">],</span> <span class="s1">'error'</span><span class="p">);</span>
 <span class="mi">76</span>             <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
 <span class="mi">77</span>         <span class="p">}</span>
 <span class="mi">78</span>     <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>42~47: 재전송이 아닌 최초 요청일때, 로그를 남긴다.</li>
  <li>50: Fcm 스펙이 한 요청당 1,000개의 수신자까지만 메시지를 전송할 수 있으므로, 제한 개수를 넘을 때는 청크로 나누어 처리한다.</li>
  <li>52~53: 청크로 나누었기 때문에, 청크에 대한 응답을 합치는 구문이다. 가령 1,500개 수신자에게 메시지를 보낸다면, 1,000개 짜리 청크에 대한 응답을 <code class="highlighter-rouge">$response</code> 변수에 담아두고, 나머지 500개 청크에 대한 응답을 <code class="highlighter-rouge">$response</code>에 머지하는 방식이다.</li>
  <li>65~66: 처리 방식(청크 vs. 한방)에 무관하게, Fcm 서버의 응답을 담고 있는 <code class="highlighter-rouge">$response</code> 변수를 이용해서, push_service_id의 업데이트 또는 삭제 작업을 다른 함수에 위임한다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="mi">80</span>     <span class="k">public</span> <span class="k">function</span> <span class="nf">setReceivers</span><span class="p">(</span><span class="k">array</span> <span class="nv">$receivers</span><span class="p">)</span>
 <span class="mi">81</span>     <span class="p">{</span>
 <span class="mi">82</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">receivers</span> <span class="o">=</span> <span class="nv">$receivers</span><span class="p">;</span>
 <span class="mi">83</span>     <span class="p">}</span>
 <span class="mi">84</span> 
 <span class="mi">85</span>     <span class="k">public</span> <span class="k">function</span> <span class="nf">setMessage</span><span class="p">(</span><span class="k">array</span> <span class="nv">$message</span><span class="p">)</span>
 <span class="mi">86</span>     <span class="p">{</span>
 <span class="mi">87</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="nv">$message</span><span class="p">;</span>
 <span class="mi">88</span>     <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>메시지를 전송(수신)할 push_service_id와 보낼 메시지를 셋팅하는 함수다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="mi">90</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">_sendMessage</span><span class="p">(</span><span class="k">array</span> <span class="nv">$tokens</span><span class="p">)</span>
 <span class="mi">91</span>     <span class="p">{</span>
 <span class="mi">92</span>         <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">(</span><span class="nv">$tokens</span><span class="p">);</span>
 <span class="mi">93</span>         <span class="nv">$guzzleResponse</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">httpClient</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
 <span class="mi">94</span> 
 <span class="mi">95</span>         <span class="k">return</span> <span class="k">new</span> <span class="nx">DownstreamResponse</span><span class="p">(</span><span class="nv">$guzzleResponse</span><span class="p">,</span> <span class="nv">$tokens</span><span class="p">);</span>
 <span class="mi">96</span>     <span class="p">}</span>
 <span class="mi">97</span> 
 <span class="mi">98</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">getRequest</span><span class="p">(</span><span class="k">array</span> <span class="nv">$tokens</span><span class="p">)</span>
 <span class="mi">99</span>     <span class="p">{</span>
<span class="mi">100</span>         <span class="c1">// 'to' for single receiver,</span>
<span class="mi">101</span>         <span class="c1">// 'registration_ids' for multiple receivers</span>
<span class="mi">102</span>         <span class="nv">$httpBody</span> <span class="o">=</span> <span class="nx">\GuzzleHttp\json_encode</span><span class="p">([</span>
<span class="mi">103</span>             <span class="s1">'registration_ids'</span> <span class="o">=&gt;</span> <span class="nv">$tokens</span><span class="p">,</span>
<span class="mi">104</span>             <span class="s1">'notification'</span> <span class="o">=&gt;</span> <span class="kc">null</span><span class="p">,</span>
<span class="mi">105</span>             <span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span>
<span class="mi">106</span>         <span class="p">]);</span>
<span class="mi">107</span> 
<span class="mi">108</span>         <span class="k">return</span> <span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">API_ENDPOINT</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">$httpBody</span><span class="p">);</span>
<span class="mi">109</span>     <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>92: <code class="highlighter-rouge">getRqeust()</code> 함수에게 요청 객체 생성을 위임한다.</li>
  <li>93: 라라벨 컨테이너가 서비스 프로바이더에 등록해둔 조립 공식에 따라 만들어준, <code class="highlighter-rouge">$httpClient: GuzzleClient</code> 객체를 이용해서 Fcm 서버에 HTTP 요청을 보내고, 응답을 <code class="highlighter-rouge">$guzzleResponse</code> 변수에 담았다.</li>
  <li>95: Fcm 서버의 응답(<code class="highlighter-rouge">$guzzleResponse</code>)과 수신자 목록을 이용해서 <code class="highlighter-rouge">DownstreamResponse</code> 데이터 객체를 만들고 반환한다. 63, 66~67에서 봤던 <code class="highlighter-rouge">$response</code> 변수가 바로 여기서 반환한 <code class="highlighter-rouge">DownstreamResponse</code> 객체다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">111</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">updatePushServiceIdsIfAny</span><span class="p">(</span><span class="nx">DownstreamResponse</span> <span class="nv">$response</span><span class="p">)</span>
<span class="mi">112</span>     <span class="p">{</span>
<span class="mi">113</span>         <span class="k">if</span> <span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="na">numberModification</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">114</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">115</span>         <span class="p">}</span>
<span class="mi">116</span> 
<span class="mi">117</span>         <span class="sd">/**
118          * @var array $pushServiceIdsToModify {
119          *     @var string $oldPushServiceId =&gt; string $newPushServiceId
120          * }
121          */</span>
<span class="mi">122</span>         <span class="nv">$pushServiceIdsToModify</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">tokensToModify</span><span class="p">();</span>
<span class="mi">123</span> 
<span class="mi">124</span>         <span class="c1">// 메시지는 성공적으로 전달되었습니다.</span>
<span class="mi">125</span>         <span class="c1">// 단말기 공장 초기화 등의 이유로 구글 Fcm 서버에 등록된 registration_id가 바뀌었습니다.</span>
<span class="mi">126</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logProgress</span><span class="p">(</span><span class="s1">'구글 서버와 push_service_id 를 동기화합니다.'</span><span class="p">,</span> <span class="p">[</span>
<span class="mi">127</span>             <span class="s1">'push_service_id_to_modify'</span> <span class="o">=&gt;</span> <span class="nv">$pushServiceIdsToModify</span>
<span class="mi">128</span>         <span class="p">]);</span>
<span class="mi">129</span> 
<span class="mi">130</span>         <span class="k">foreach</span> <span class="p">(</span><span class="nv">$pushServiceIdsToModify</span> <span class="k">as</span> <span class="nv">$oldPushServiceId</span> <span class="o">=&gt;</span> <span class="nv">$newPushServiceId</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">131</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deviceRepo</span><span class="o">-&gt;</span><span class="na">updateFcmDevice</span><span class="p">(</span><span class="nv">$oldPushServiceId</span><span class="p">,</span> <span class="nv">$newPushServiceId</span><span class="p">);</span>
<span class="mi">132</span>         <span class="p">}</span>
<span class="mi">133</span>     <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>131: 라라벨 컨테이너가 주입해준 <code class="highlighter-rouge">EloquentFcmDeviceRepository</code> 객체를 여기서 사용한다. 이미 설명했듯이, 리포지토리의 <code class="highlighter-rouge">updateFcmDevice()</code> 함수를 호출해서, push_service_id를 업데이트 작업을 지시하는 부분이다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">135</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">handleDeliveryFailureIfAny</span><span class="p">(</span><span class="nx">DownstreamResponse</span> <span class="nv">$response</span><span class="p">)</span>
<span class="mi">136</span>     <span class="p">{</span>
<span class="mi">137</span>         <span class="k">if</span> <span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="na">numberFailure</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">138</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">139</span>         <span class="p">}</span>
<span class="mi">140</span> 
<span class="mi">141</span>         <span class="nv">$pushServiceIdsToDelete</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">tokensToDelete</span><span class="p">();</span>
<span class="mi">142</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$pushServiceIdsToDelete</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">143</span>             <span class="c1">// 해당 registration_id를 가진 단말기가 구글 Fcm 서비스에 등록되어 있지 않습니다.</span>
<span class="mi">144</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logProgress</span><span class="p">(</span><span class="s1">'사용불가한 push_service_id 를 삭제합니다.'</span><span class="p">,</span> <span class="p">[</span>
<span class="mi">145</span>                 <span class="s1">'push_service_ids_to_delete'</span> <span class="o">=&gt;</span> <span class="nv">$pushServiceIdsToDelete</span>
<span class="mi">146</span>             <span class="p">]);</span>
<span class="mi">147</span> 
<span class="mi">148</span>             <span class="k">foreach</span> <span class="p">(</span><span class="nv">$pushServiceIdsToDelete</span> <span class="k">as</span> <span class="nv">$pushServiceIdToDelete</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">149</span>                 <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deviceRepo</span><span class="o">-&gt;</span><span class="na">deleteFcmDevice</span><span class="p">(</span><span class="nv">$pushServiceIdToDelete</span><span class="p">);</span>
<span class="mi">150</span>             <span class="p">}</span>
<span class="mi">151</span>         <span class="p">}</span>
<span class="mi">152</span> 
<span class="mi">153</span>         <span class="nv">$pushServiceIdsToRetry</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">tokensToRetry</span><span class="p">();</span>
<span class="mi">154</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$pushServiceIdsToRetry</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">155</span>             <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isFinalRetry</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">156</span>                 <span class="c1">// 재시도 했지만 메시지 전송에 실패했습니다.</span>
<span class="mi">157</span>                 <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">();</span>
<span class="mi">158</span>             <span class="p">}</span>
<span class="mi">159</span> 
<span class="mi">160</span>             <span class="c1">// 최대 3회, 1회는 기본값, 다음 루프는 2회, 3회까지 실행됨.</span>
<span class="mi">161</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">retriedCount</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">retriedCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">162</span>             <span class="c1">// (최초 1회 200밀리초 뒤 실행, 2회 400밀리초 뒤, 3회 800밀리초 뒤) -&gt; 프로세스가 총 1.4초동안 실행됨.</span>
<span class="mi">163</span>             <span class="c1">// @see https://firebase.google.com/docs/cloud-messaging/http-server-ref?hl=ko#error-codes</span>
<span class="mi">164</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">retryIntervalInUs</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">retryIntervalInUs</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="mi">165</span> 
<span class="mi">166</span>             <span class="nb">usleep</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">retryIntervalInUs</span><span class="p">);</span>
<span class="mi">167</span> 
<span class="mi">168</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logProgress</span><span class="p">(</span><span class="s2">"</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getOrdinalRetryCount</span><span class="p">()</span><span class="si">}</span><span class="s2"> 재전송 시도합니다."</span><span class="p">,</span> <span class="p">[</span>
<span class="mi">169</span>                 <span class="s1">'retried_count'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">retriedCount</span><span class="p">,</span>
<span class="mi">170</span>                 <span class="s1">'push_service_ids_to_retry'</span> <span class="o">=&gt;</span> <span class="nv">$pushServiceIdsToRetry</span><span class="p">,</span>
<span class="mi">171</span>             <span class="p">]);</span>
<span class="mi">172</span> 
<span class="mi">173</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">receivers</span> <span class="o">=</span> <span class="nv">$pushServiceIdsToRetry</span><span class="p">;</span>
<span class="mi">174</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sendMessage</span><span class="p">();</span>
<span class="mi">175</span>         <span class="p">}</span>
<span class="mi">176</span>     <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>우선 <code class="highlighter-rouge">handleDeliveryFailureIfAny()</code> 함수를 두가지 일을 한다. 이렇게 구현된 이유는 뒤에 설명할 Fcm 서버의 응답 스펙과 관련이 있다. 두 가지 일이란;</li>
  <li>141~151: 첫째 디바이스 리포지토리에게 유효하지 않는 push_service_id 삭제 지시를 한다.</li>
  <li>153~175: 둘째, 재전송이 필요한 push_service_id 들에 대해 2번 더 전송 시도한다.</li>
  <li>160~161: 지금까지 <code class="highlighter-rouge">$retriedCount</code> 변수에는 <code class="highlighter-rouge">0</code>이 담겨 있었고, 이 라인에서 <code class="highlighter-rouge">1</code>을 더했다.</li>
  <li>162~164: <a href="https://en.wikipedia.org/wiki/Exponential_backoff">Exponential Backoff</a> 구현이다. 방금 실패했으면 재시도해도 실패할 가능성이 있으므로, 재시도 주기를 점진적으로 늘려가며 재시도하는 로직이다.</li>
  <li>173~174: 수신자(<code class="highlighter-rouge">$receivers</code>) 변수를 실패한 push_service_id[]로 덮어 쓰고, <code class="highlighter-rouge">sendMessage()</code> API를 다시 호출한다. 또 실패하면 이 함수에 들어오게 되고, <code class="highlighter-rouge">$retriedCount</code>, <code class="highlighter-rouge">$retryIntervalInUs</code> 등의 제어 변수들이 조정되고, 또 재시도하게 될 것이다.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">178</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">isInitialRequest</span><span class="p">()</span>
<span class="mi">179</span>     <span class="p">{</span>
<span class="mi">180</span>         <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">retriedCount</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">181</span>     <span class="p">}</span>
<span class="mi">182</span> 
<span class="mi">183</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">isFinalRetry</span><span class="p">()</span>
<span class="mi">184</span>     <span class="p">{</span>
<span class="mi">185</span>         <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">retriedCount</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">maxRetryCount</span><span class="p">;</span>
<span class="mi">186</span>     <span class="p">}</span>
<span class="mi">187</span> 
<span class="mi">188</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">getOrdinalRetryCount</span><span class="p">()</span>
<span class="mi">189</span>     <span class="p">{</span>
<span class="mi">190</span>         <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">retriedCount</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">191</span>             <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>  <span class="k">return</span> <span class="s1">'첫번째'</span><span class="p">;</span>
<span class="mi">192</span>             <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>  <span class="k">return</span> <span class="s1">'두번째'</span><span class="p">;</span>
<span class="mi">193</span>             <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>  <span class="k">return</span> <span class="s1">'세번째'</span><span class="p">;</span>
<span class="mi">194</span>             <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="s1">''</span><span class="p">;</span>
<span class="mi">195</span>         <span class="p">}</span>
<span class="mi">196</span>     <span class="p">}</span>
<span class="mi">197</span> 
<span class="mi">198</span>     <span class="k">private</span> <span class="k">function</span> <span class="nf">logProgress</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$context</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">string</span> <span class="nv">$level</span> <span class="o">=</span> <span class="s1">'debug'</span><span class="p">)</span>
<span class="mi">199</span>     <span class="p">{</span>
<span class="mi">200</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="nv">$level</span><span class="p">,</span> <span class="s2">"[FcmHandler] </span><span class="si">{</span><span class="nv">$message</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
<span class="mi">201</span>     <span class="p">}</span>
<span class="mi">202</span> <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>나머지는 모두 헬퍼 함수들이다.</li>
</ul>

<h2 id="6-메시지-보내기-테스트">6. 메시지 보내기 테스트</h2>

<p>팅커를 이용해서 구현한 클래스가 잘 작동하는지 확인해보자. 유효하지 않은 단말기 토큰이므로 실패가 떨어지는 것은 당연하다. 우리의 PHP 애플리케이션 서버에서 생성한 메시지가 Fcm 서버를 거쳐 단말기에게 전달되는 전체 과정을 확인하지는 못했지만, 적어도 Fcm 서버와 통신이 된다는 것은 확인했다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># In terminal session 1</span>
<span class="nv">$ </span>php artisan tinker
<span class="o">&gt;&gt;&gt;</span> <span class="nv">$handler</span> <span class="o">=</span> App::make<span class="o">(</span>App<span class="se">\S</span>ervices<span class="se">\F</span>cmHandler::class<span class="o">)</span><span class="p">;</span>
<span class="o">=&gt;</span> App<span class="se">\S</span>ervices<span class="se">\F</span>cmHandler <span class="o">{</span><span class="c">#733}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nv">$handler</span>-&gt;setReceivers<span class="o">([</span>str_repeat<span class="o">(</span><span class="s1">'a'</span>, 152<span class="o">)])</span><span class="p">;</span>
<span class="o">=&gt;</span> null

<span class="o">&gt;&gt;&gt;</span> <span class="nv">$handler</span>-&gt;setMessage<span class="o">([</span><span class="s1">'Lorem'</span> <span class="o">=&gt;</span> <span class="s1">'Ipsum'</span><span class="o">])</span><span class="p">;</span>
<span class="o">=&gt;</span> null

<span class="o">&gt;&gt;&gt;</span> <span class="nv">$handler</span>-&gt;sendMessage<span class="o">()</span><span class="p">;</span>
<span class="o">=&gt;</span> null
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># In terminal session 2</span>
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-f</span> storage/logs/laravel.log
<span class="o">[</span>2018-11-13 14:27:11] local.DEBUG: <span class="o">[</span>FcmHandler] 푸쉬 알림을 전송합니다. <span class="o">{</span><span class="s2">"receivers"</span>:[<span class="s2">"aa..um"</span><span class="o">}}</span>
<span class="o">[</span>2018-11-13 14:27:11] local.DEBUG: <span class="o">[</span>FcmHandler] 사용불가한 push_service_id 를 삭제합니다. <span class="o">{</span><span class="s2">"push_service_ids_to_delete"</span>:[<span class="s2">"aa..aa"</span><span class="o">]}</span>
<span class="o">[</span>2018-11-13 14:27:11] local.DEBUG: <span class="o">[</span>FcmHandler] 푸쉬 알림을 전송했습니다. <span class="o">{</span><span class="s2">"receiver"</span>:[<span class="s2">"aa..aa"</span><span class="o">]}</span>
</code></pre></div></div>

<h2 id="7-컨트롤러-구현">7. 컨트롤러 구현</h2>

<p>Fcm 메시지는 웹 페이지, 크론, 이벤트 핸들러, 큐 잡 등등 애플리케이션 어디서든 보낼 수 있다. 이 포스트에서는 웹 페이지를 통해서 메시지를 보낸다고 가정하고 컨트롤러(간결함을 위해 라우트 정의 파일 이용)를 만들어본다. 1부에서 만든 단말기 등록 API를 이용해서 1번 User의 단말기가 등록되어 있다고 가정한다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// routes/api.php</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">'fcm_test'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">App\Services\FcmHandler</span> <span class="nv">$fcmHandler</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$user</span> <span class="o">=</span> <span class="nx">App\User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nv">$fcmHandler</span><span class="o">-&gt;</span><span class="na">setReceivers</span><span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getPushServiceIds</span><span class="p">());</span>
    <span class="nv">$fcmHandler</span><span class="o">-&gt;</span><span class="na">setMessage</span><span class="p">([</span>
        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'Hello Fcm'</span><span class="p">,</span>
    <span class="p">]);</span>
    <span class="nv">$fcmHandler</span><span class="o">-&gt;</span><span class="na">sendMessage</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Illuminate\Http\JsonResponse</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">$user-&gt;getPushServiceIds()</code>는 모델에 정의한 헬퍼 함수이며, 다음과 같다.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="c1">// app/User.php</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Authenticatable</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getPushServiceIds</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">devices</span><span class="o">-&gt;</span><span class="na">pluck</span><span class="p">(</span><span class="s1">'push_service_id'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>본문에 언급되지 않은 코드는 <a href="https://github.com/appkr/fcm-scratchpad/pull/2/files">예제 프로젝트의 풀 리퀘스트</a>에서 확인할 수 있다.</p>
</blockquote>

<h2 id="8-푸쉬-메시지-요청에-대한-fcm-서버-응답의-이해">8. 푸쉬 메시지 요청에 대한 Fcm 서버 응답의 이해</h2>

<p><code class="highlighter-rouge">DownstreamResponse</code> 클래스를 이해하려면, <a href="https://firebase.google.com/docs/cloud-messaging/server#response">Fcm 문서</a>에 명시된 Fcm 서버의 응답 메시지를 이해해야 하는데… 아래는 총 6개의 단말기에 푸쉬 메시지를 보냈을 때 Fcm 서버의 응답 예제이다. 이 예제를 통해서 Fcm 응답 스펙을 이해할 수 있다.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> 
  </span><span class="s2">"multicast_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w">
  </span><span class="s2">"success"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
  </span><span class="s2">"failure"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
  </span><span class="s2">"canonical_ids"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"results"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"message_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1:0408"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Unavailable"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"InvalidRegistration"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"message_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1:1516"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"message_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1:2342"</span><span class="p">,</span><span class="w"> </span><span class="s2">"registration_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NotRegistered"</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>우선 <code class="highlighter-rouge">results.message_id</code>가 있는 메시지들은 성공한 것이다. <code class="highlighter-rouge">DownstreamResponse</code> 클래스의 메서드들도 다음 표에 정리했다.</p>

<table>
  <thead>
    <tr>
      <th>응답 필드</th>
      <th>라이브러리의 메서드(<code class="highlighter-rouge">DownstreamResponse</code>)</th>
      <th>설명</th>
      <th>예제 응답 번호(zero-index)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">success</code></td>
      <td><code class="highlighter-rouge">numberSuccess()</code></td>
      <td>푸쉬 메시지 전달에 성공한 건수</td>
      <td>0,3,4</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">failure</code></td>
      <td><code class="highlighter-rouge">numberFailure()</code></td>
      <td>푸쉬 메시지 전달에 실패한 건수</td>
      <td>1,2,5</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">canonical_ids</code></td>
      <td><code class="highlighter-rouge">numberModification()</code></td>
      <td>단말기의 고유 식별 토큰이 변경된 건수</td>
      <td>4</td>
    </tr>
    <tr>
      <td> </td>
      <td><code class="highlighter-rouge">tokensToDelete()</code></td>
      <td>애플리케이션 서버에서 삭제할 토큰의 목록</td>
      <td>5</td>
    </tr>
    <tr>
      <td> </td>
      <td><code class="highlighter-rouge">tokensToModify()</code></td>
      <td>애플리케이션 서버에서 업데이트할 토큰의 목록</td>
      <td>4</td>
    </tr>
    <tr>
      <td> </td>
      <td><code class="highlighter-rouge">tokensToRetry()</code></td>
      <td>애플리케이션 서버에서 재 전송해야 하는 토큰의 목록</td>
      <td>1</td>
    </tr>
    <tr>
      <td> </td>
      <td><code class="highlighter-rouge">tokensWithError()</code></td>
      <td>에러가 난 이유 목록</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h2 id="9-결론">9. 결론</h2>

<p>2부에 걸친 포스트를 통해 모바일 단말기에 Firebase Cloud Message를 보내기 위한 PHP 애플리케이션 서버를 구현하는 방법을 다루었다. 3부를 쓸 기회가 있다면 빠진 퍼즐 조각인 모바일 앱 부분을 소개할 예정이다.</p>

<p>고정된 위치에서 전원과 인터넷에 연결되어 있는 기기와 달리, 모바일은 계속 변하는 환경에 노출되어 있다. 따라서 모바일 환경에 적합한 기술을 선택하는 것이 중요한데, Fcm이 최고의 선택이라고 장담할 수는 없지만, 가장 대중적인 선택임에는 틀림없다.</p>

<div class="spacer">• • •</div>

<p>이번 포스트의 <strong>예제 프로젝트는 <a href="https://github.com/appkr/fcm-scratchpad">https://github.com/appkr/fcm-scratchpad</a>에 공개</strong>되어 있다.</p>

<p><strong>포스트맨 콜렉션은 <a href="https://raw.githubusercontent.com/appkr/fcm-scratchpad/master/docs/fcm-scratchpad.postman_collection.json">https://raw.githubusercontent.com/appkr/fcm-scratchpad/master/docs/fcm-scratchpad.postman_collection.json</a></strong>에서 받을 수 있다.</p>

<h2 id="덧">덧.</h2>

<p>이 예제 프로젝트와 연동해서 작동하는 Android 예제 클라이언트를 brownsoo 님이 제공해 주셨습니다. 상세한 설명은 <a href="https://github.com/brownsoo/fcm-scratchpad-android">https://github.com/brownsoo/fcm-scratchpad-android</a>를 참고해 주세요.</p>

<p><img src="https://raw.githubusercontent.com/appkr/fcm-scratchpad/master/docs/image-04.png" alt="Android Client Example" /></p>

      </div>

      <footer class="box-tags">
        <span><i class="material-icons">label</i> Tags:</span>
        
          <a href="/tags#개발자">
            개발자
          </a>
          , 
        
          <a href="/tags#Laravel">
            Laravel
          </a>
          , 
        
          <a href="/tags#PHP">
            PHP
          </a>
          
        
      </footer>
    </article>

    <nav id="pagination">
      <ul class="pager">
        
        <li class="previous">
          <a href="/work-n-play/firebase-cloud-message-php-server-implementation-part-1/">
            <span aria-hidden="true">
              <i class="material-icons">navigate_before</i>
            </span>
            <span class="pager-title-sm">Older</span>
            <span class="pager-title">
              모바일 푸쉬 메시지(FCM)를 ...
            </span>
          </a>
        </li>
        

        
        <li class="next">
          <a href="/work-n-play/understanding-php-exception-class/">
            <span class="pager-title">
              PHP의 예외 클래스 이해하기
            </span>
            <span class="pager-title-sm">Newer</span>
            <span aria-hidden="true">
              <i class="material-icons">navigate_next</i>
            </span>
          </a>
        </li>
        
      </ul>
    </nav>

    <div class="comments" style="margin-bottom: 30px;">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//appkr.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

  </section>

  <aside id="sidebar" class="col-md-3">
    <section id="search_sidebar" class="box hidden-xs">
  <div class="box-body">
    <form action="#">
      <div class="form-group">
        <input class="form-control input-lg" type="text" id="q_sidebar" placeholder="Search...">
        <ul id="q_sidebar_res"></ul>
      </div>
    </form>
  </div>
</section>

<section class="box" id="categories">
  <div class="box-header">
    <h3>Categories</h3>
  </div>

  <div class="box-body">
    <ul>
      <li>
        <a href="/categories#around-me">
          Around Me
          <span class="badge">25</span>
        </a>
      </li>
      <li>
        <a href="/categories#learn-n-think">
          Learn & Think
          <span class="badge">80</span>
        </a>
      </li>
      <li>
        <a href="/categories#work-n-play">
          Work & Play
          <span class="badge">59</span>
        </a>
      </li>
      <li>
        <a href="/categories#cheatsheet">
          Cheatsheet
          <span class="badge">4</span>
        </a>
      </li>
      <li>
        <a href="/categories#imported">
          Imported
          <span class="badge">3</span>
        </a>
      </li>
      <li>
        <a href="/categories#uncategorized">
          Uncategorized
          <span class="badge">2</span>
        </a>
      </li>
    </ul>
  </div>
</section>

<section class="box" id="tags">
  <div class="box-header">
    <h3>Tags</h3>
  </div>

  <div class="box-body tags">
    <div class="tags">
    
    
    <span style="font-size: 98%">
      <a href="/tags#3d">
        3d
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#API">
        API
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#Apache Thrift">
        Apache Thrift
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#CSS">
        CSS
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#CleanCode">
        CleanCode
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#DDD">
        DDD
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Database">
        Database
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#DevOps">
        DevOps
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Docker">
        Docker
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Dotfiles">
        Dotfiles
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ELK">
        ELK
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Generator">
        Generator
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#Git">
        Git
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#JWT">
        JWT
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Javascript">
        Javascript
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#Jekyll">
        Jekyll
      </a>
    </span>
    
    <span style="font-size: 134%">
      <a href="/tags#Laravel">
        Laravel
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Linux">
        Linux
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Log">
        Log
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Lumen">
        Lumen
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#OOP">
        OOP
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#OS X">
        OS X
      </a>
    </span>
    
    <span style="font-size: 146%">
      <a href="/tags#PHP">
        PHP
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#RESTful">
        RESTful
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#RPC">
        RPC
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Refactoring">
        Refactoring
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Ruby">
        Ruby
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Security">
        Security
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Swagger">
        Swagger
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#UML">
        UML
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#URL Rewriting">
        URL Rewriting
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#Web">
        Web
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#Websocket">
        Websocket
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#adobe">
        adobe
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#amazon">
        amazon
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#amd">
        amd
      </a>
    </span>
    
    <span style="font-size: 142%">
      <a href="/tags#android">
        android
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#apple">
        apple
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ar">
        ar
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#architecture">
        architecture
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#arm">
        arm
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bada">
        bada
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bluetooth">
        bluetooth
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#bus">
        bus
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#cdp">
        cdp
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#chrome">
        chrome
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#cloud">
        cloud
      </a>
    </span>
    
    <span style="font-size: 114%">
      <a href="/tags#codec">
        codec
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#connectivity">
        connectivity
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#cpu">
        cpu
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ebook">
        ebook
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#emulator">
        emulator
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#flash">
        flash
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#framework">
        framework
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#gms">
        gms
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#google">
        google
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#gtd">
        gtd
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#intel">
        intel
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#ios">
        ios
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#iphone">
        iphone
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#java">
        java
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#lbs">
        lbs
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#limo">
        limo
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#linux">
        linux
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#mcu">
        mcu
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#memory">
        memory
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#microsoft">
        microsoft
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#mobile">
        mobile
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#opencore">
        opencore
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#opengl">
        opengl
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#opengles">
        opengles
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#opensource">
        opensource
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#openvg">
        openvg
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#platform">
        platform
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#pnd">
        pnd
      </a>
    </span>
    
    <span style="font-size: 106%">
      <a href="/tags#presentation">
        presentation
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#pvcore">
        pvcore
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#se">
        se
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#sns">
        sns
      </a>
    </span>
    
    <span style="font-size: 114%">
      <a href="/tags#soc">
        soc
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#symbian">
        symbian
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#tech">
        tech
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#ted">
        ted
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#tedx">
        tedx
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#windowsmobile">
        windowsmobile
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#wss">
        wss
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#x86">
        x86
      </a>
    </span>
    
    <span style="font-size: 110%">
      <a href="/tags#史記">
        史記
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#孟子">
        孟子
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#孫子兵法">
        孫子兵法
      </a>
    </span>
    
    <span style="font-size: 294%">
      <a href="/tags#개발자">
        개발자
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#경력개발">
        경력개발
      </a>
    </span>
    
    <span style="font-size: 138%">
      <a href="/tags#기업철학">
        기업철학
      </a>
    </span>
    
    <span style="font-size: 174%">
      <a href="/tags#기획자">
        기획자
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#데이터베이스">
        데이터베이스
      </a>
    </span>
    
    <span style="font-size: 146%">
      <a href="/tags#리더쉽">
        리더쉽
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#생산성">
        생산성
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#소프트웨어공학">
        소프트웨어공학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#수학">
        수학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#아키텍처">
        아키텍처
      </a>
    </span>
    
    <span style="font-size: 210%">
      <a href="/tags#인생철학">
        인생철학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#자녀교육">
        자녀교육
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#전략">
        전략
      </a>
    </span>
    
    <span style="font-size: 146%">
      <a href="/tags#조직관리">
        조직관리
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#조직문화">
        조직문화
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#조직행동">
        조직행동
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#철학">
        철학
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#취미">
        취미
      </a>
    </span>
    
    <span style="font-size: 94%">
      <a href="/tags#특기">
        특기
      </a>
    </span>
    
    <span style="font-size: 102%">
      <a href="/tags#프로세스">
        프로세스
      </a>
    </span>
    
    <span style="font-size: 98%">
      <a href="/tags#프로젝트관리">
        프로젝트관리
      </a>
    </span>
    
    </div>
  </div>
</section>

<section class="box" id="recent-posts">
  <div class="box-header">
    <h3>Recent Posts</h3>
  </div>

  <div class="box-body">
    <ul>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2018-11-05</small>
          <a href="/cheatsheet/vim-cheatsheet/">Vim cheatsheet</a>
        </h4>
      </li>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2018-11-04</small>
          <a href="/learn-n-think/php-object-copy/">PHP 객체의 복제 특성</a>
        </h4>
      </li>
      
      <li>
        <h4>
          <small class="box-meta"><i class="material-icons">today</i> 2018-10-20</small>
          <a href="/learn-n-think/short-parable-on-sql-injection/">SQL Injection 방어</a>
        </h4>
      </li>
      
    </ul>
  </div>
</section>

<section class="box" id="recent-comments">
  <div class="box-header">
    <h3>Recent Comments</h3>
  </div>

  <div class="box-body dsq-widget">
    <script type="text/javascript" src="//appkr.disqus.com/recent_comments_widget.js?num_items=5&hide_mods=0&hide_avatars=0&avatar_size=32&excerpt_length=100"></script>
  </div>
</section>

<section class="box" id="recent-feeds">
  <div class="box-header">
    <h3>Facebook Posts</h3>
  </div>

  <div class="box-body">
    <ul id="facebook-feed">
      <script id="facebook-feed-template" type="text/x-template">
        <li>
          <span class="facebook-message">
            { message }
          </span>
          ·
          <span class="facebook-meta">
            <a href="https://www.facebook.com/juwonkimatmedotcom/posts/{ id }">
              { created_time }
            </a>
          </span>
        </li>
      </script>
    </ul>
  </div>
</section>

<section class="box" id="gist-lists">
  <div class="box-header">
    <h3>Github Gist</h3>
  </div>

  <div class="box-body">
    <ul id="gist-list">
      <script id="gist-list-template" type="text/x-template">
        <li>
          <span class="facebook-message">
            { message }
          </span>
          ·
          <span class="facebook-meta">
            <a href="https://gist.github.com/{ id }">
              { created_time }
            </a>
          </span>
        </li>
      </script>
    </ul>
  </div>
</section>

  </aside>
</div>


  <footer id="site-footer">
  <h4>
    <a href="/">
      Appkr.memo(new Life)
    </a>
  </h4>
  <p>
    &copy; 2008~2018 •
    Built with <a href="http://jekyllrb.com/">Jekyll</a> •
    Hosted by <a href="https://pages.github.com/">Github</a> •
    <a href="/feed.xml">Rss</a>
  </p>
</footer>


  <div id="back-to-top">
    <a href="#" title="Scroll to Top">
      <i class="material-icons">keyboard_arrow_up</i>
    </a>
  </div>

  <script src="/scripts/main.min.js"></script>
</body>

</html>
